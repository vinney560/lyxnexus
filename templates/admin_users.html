<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Mngmt | LyxNexus Admin</title>
    <!-- Font Awesome 6 (free) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Legacy scripts -->
    <script src="/_0eXv3/tailwind.all.css"></script>
    <script src="/_0eXv4/n-s.js"></script>
    <script src="/_0eXv4/loading.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0b0f1a;
            --bg-surface: #141b2b;
            --bg-surface-light: #1e2a3a;
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.4);
            --secondary: #8b5cf6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border-glow: rgba(59, 130, 246, 0.2);
            --card-bg: rgba(20, 30, 45, 0.7);
            --glass-edge: rgba(255, 255, 255, 0.05);
            --shadow-card: 0 20px 30px -10px rgba(0, 0, 0, 0.6);
            --transition-default: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --gray-400: #9ca3af;
            --secondary-600: #9333ea;
            --primary-600: #2563eb;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 40%),
                              radial-gradient(circle at 90% 70%, rgba(139, 92, 246, 0.03) 0%, transparent 40%);
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .glass-morph {
            background: rgba(20, 30, 45, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--glass-edge);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: var(--transition-default);
        }
        .glass-morph:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 40px;
            font-weight: 500;
            font-size: 0.9rem;
            border: none;
            background: rgba(255,255,255,0.03);
            color: var(--text-primary);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.05);
            transition: var(--transition-default);
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            background: linear-gradient(145deg, var(--primary), var(--secondary));
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary, .btn-success, .btn-danger, .btn-warning, .btn-info, .btn-ai, .btn-dashboard, .btn-phone, .btn-events, .btn-shares, .btn-notify, .btn-money, .btn-secondary {
            background: linear-gradient(145deg, #1e2a3a, #141b2b);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .btn-success { background: linear-gradient(145deg, #10b981, #059669); border-color: #10b98130; }
        .btn-danger { background: linear-gradient(145deg, #ef4444, #b91c1c); border-color: #ef444430; }
        .btn-warning { background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #f59e0b30; }
        .btn-info { background: linear-gradient(145deg, #0ea5e9, #0369a1); border-color: #0ea5e930; }
        .btn-ai { background: linear-gradient(145deg, #a3aa3f, #5a761a); border-color: #a3aa3f30; }
        .btn-dashboard { background: linear-gradient(145deg, #6f31b5, #1a1ad7); border-color: #6f31b530; }
        .btn-phone { background: linear-gradient(145deg, #ff4d4d, #c7304e, #442e76); border-color: #ff4d4d30; }
        .btn-events { background: linear-gradient(145deg, #f97316, #c2410c); border-color: #f9731630; }
        .btn-shares { background: linear-gradient(145deg, #14b8a6, #0d9488); border-color: #14b8a630; }
        .btn-notify { background: linear-gradient(145deg, #ef4444, #dc2626); border-color: #ef444430; }
        .btn-money { background: linear-gradient(145deg, #fbbf24, #f59e0b); border-color: #fbbf2430; }

        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
        }
        .btn:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(60%);
        }

        .btn-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        .btn-loading .btn-spinner {
            display: inline-block;
        }

        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.8rem;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: capitalize;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
        }
        .status-admin {
            background: linear-gradient(145deg, #8b5cf6, #6d28d9);
            border-color: #a78bfa60;
            color: white;
        }
        .status-user {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f660;
            color: #93c5fd;
        }
        .status-online {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b98160;
            color: #6ee7b7;
        }
        .status-allowed {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #d1fae5;
        }
        .status-banned {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #fecaca;
        }

        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(11, 16, 26, 0.8);
            backdrop-filter: blur(16px) saturate(200%);
            -webkit-backdrop-filter: blur(16px) saturate(200%);
            border-bottom: 1px solid var(--glass-edge);
        }
        .nav-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .sidebar-toggle-header {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(59,130,246,0.2);
            width: 42px;
            height: 42px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition-default);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .sidebar-toggle-header:hover {
            background: rgba(59,130,246,0.15);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .logo-container {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 16px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(59,130,246,0.4);
        }
        .logo-container svg {
            width: 28px;
            height: 28px;
            color: white;
        }
        .gradient-text {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
        }
        .last-updated {
            background: rgba(16,185,129,0.1);
            border: 1px solid #10b98130;
            border-radius: 40px;
            padding: 0.4rem 1.2rem;
            font-size: 0.8rem;
            color: #6ee7b7;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-toggle.old-fixed {
            display: none;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -320px;
            width: 280px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(24px) saturate(200%);
            -webkit-backdrop-filter: blur(24px) saturate(200%);
            border-right: 1px solid rgba(255,255,255,0.05);
            box-shadow: 10px 0 40px rgba(0,0,0,0.6);
            transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-header {
            padding: 1.8rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .sidebar-title {
            font-size: 1.4rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #c084fc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .sidebar-close {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            width: 36px;
            height: 36px;
            border-radius: 12px;
            color: var(--text-secondary);
            transition: var(--transition-default);
        }
        .sidebar-close:hover {
            background: rgba(239,68,68,0.2);
            border-color: #ef4444;
            color: #fecaca;
            transform: rotate(90deg);
        }
        .sidebar-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .nav-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }
        .nav-buttons-container .btn {
            width: 100%;
            justify-content: flex-start;
            padding: 0.9rem 1.2rem;
            border-radius: 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
            font-weight: 500;
            box-shadow: none;
        }
        .nav-buttons-container .btn i {
            width: 28px;
            font-size: 1.2rem;
            opacity: 0.8;
        }
        .sidebar-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            margin: 1.2rem 0;
        }
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: var(--text-secondary);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            z-index: 999;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .main-container {
            max-width: calc(100% - 20px);
            margin: 0 auto;
            padding: 10px;
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .quick-stat {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-edge);
            border-radius: 14px;
            padding: 0.8rem 0.5rem;
            text-align: center;
            transition: var(--transition-default);
            box-shadow: var(--shadow-card);
        }
        .quick-stat:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 20px 30px -8px var(--primary-glow);
        }
        .stats-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .quick-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
            background: linear-gradient(135deg, #fff, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .quick-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .online-users-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 18px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-card);
        }

        .online-user-item {
            background: rgba(16,185,129,0.05);
            border: 1px solid rgba(16,185,129,0.15);
            border-radius: 18px;
            padding: 0.8rem 1rem;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: 0.2s;
        }

        .online-user-item:hover {
            background: rgba(16,185,129,0.1);
            border-color: #10b98160;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 12px #10b981;
            animation: pulse 2s infinite;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-container {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-edge);
            border-radius: 18px;
            padding: 1.5rem;
            height: 300px;
            box-shadow: var(--shadow-card);
        }
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            letter-spacing: 0.3px;
        }
        .chart-wrapper {
            height: calc(100% - 2.5rem);
            width: 100%;
        }

        .filters-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 1.8rem;
            margin-bottom: 2rem;
            border: 1px solid var(--glass-edge);
            box-shadow: var(--shadow-card);
        }
        .search-container {
            position: relative;
            margin-bottom: 1.2rem;
        }
        .search-input {
            width: 100%;
            padding: 1rem 1.5rem 1rem 3rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 60px;
            color: white;
            font-size: 1rem;
            transition: 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .search-icon {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        .filter-select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 40px;
            padding: 0.7rem 1.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .table-wrapper {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 1.8rem;
            border: 1px solid var(--glass-edge);
            box-shadow: var(--shadow-card);
            overflow-x: auto;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .user-table th {
            text-align: left;
            padding: 1rem 0.8rem;
            color: var(--primary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(59,130,246,0.2);
        }
        .user-table td {
            padding: 1rem 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .user-table tbody tr {
            transition: 0.2s;
            border-radius: 20px;
        }
        .user-table tbody tr:hover {
            background: rgba(59,130,246,0.05);
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        /* modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--bg-surface);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 36px;
            padding: 2rem;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: rgba(20,30,45,0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 0.9rem 1.5rem;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 5px solid #10b981; }
        .toast-error { border-left: 5px solid #ef4444; }
        .toast-info { border-left: 5px solid #3b82f6; }

        @media (max-width: 768px) {
            .nav-container { padding: 0.75rem 1rem; }
            .gradient-text { font-size: 1.2rem; }
            .header-title { display: none; }
            .quick-stats-grid { grid-template-columns: repeat(2,1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .filter-select { width: 100%; }
            .action-buttons { flex-direction: column; }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        .footer-btn {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(255, 255, 255, 0.03);
            color: var(--gray-400);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .footer-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            color: white;
        }

        .footer-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-details h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .footer-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-section {
            padding: 8px 16px;
        }

        .nav-section-title {
            color: var(--gray-500);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin: 2px 8px;
            border-radius: 14px;
            color: var(--gray-400);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            border-color: var(--glass-border-hover);
            transform: translateX(4px);
        }

        .nav-item i {
            width: 20px;
            font-size: 1.1rem;
            color: var(--primary-400);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(168, 85, 247, 0.15));
            border-color: var(--glass-border-hover);
            color: rgba(242, 169, 10, 0.783);
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <nav class="sticky-nav">
        <div class="nav-container">
            <div class="nav-left">
                <button class="sidebar-toggle-header" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-container">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                        <polyline points="7.5 4.21 12 6.81 16.5 4.21" />
                        <polyline points="7.5 19.79 7.5 14.6 3 12" />
                        <polyline points="21 12 16.5 14.6 16.5 19.79" />
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                        <line x1="12" y1="22.08" x2="12" y2="12" />
                    </svg>                        
                </div>
                <span class="gradient-text header-title">Users Management</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="last-updated">
                    <i class="fas fa-sync-alt"></i>
                    <span id="last-updated-text">Updated: just now</span>
                </div>
                <span class="text-sm text-gray-400 hidden sm:block"><i class="fas fa-clock mr-1"></i> auto 120s</span>
            </div>
        </div>
    </nav>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Navigation</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="nav-buttons-container">
                <div class="sidebar-divider"></div>
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                </div>
                <div class="nav-item active">
                    <i class="fas fa-chart-pie"></i>
                    <span>User Mngmt</span>
                </div>
                <button class="btn btn-info" onclick="window.location.href='/admin/analytics'"><i class="fas fa-chart-bar"></i> Analytics</button>
                <button class="btn btn-dashboard" onclick="window.location.href='/dashboard'"><i class="fas fa-tachometer-alt"></i> Dashboard</button>

                <div class="sidebar-divider"></div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                </div>
                <button class="btn btn-money" onclick="window.location.href='/admin/4123/payment-monitor'"><i class="fas fa-money-bill-wave-alt"></i> Money</button>
                <button class="btn btn-success" onclick="window.location.href='/konami/'"><i class="fas fa-gamepad"></i> Konami</button>
                <button class="btn btn-events" onclick="window.location.href='/events/admin/events'"><i class="fas fa-calendar-alt"></i> Events</button>
                <button class="btn btn-shares" onclick="window.location.href='/admin/shares'"><i class="fas fa-share-alt"></i> Shares</button>
                <button class="btn btn-notify" onclick="window.location.href='/admin/notifications'"><i class="fas fa-bell"></i> Notification</button>

                <div class="sidebar-divider"></div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                </div>
                <button class="btn btn-ai" onclick="window.location.href='/ai-chat'"><i class="fas fa-robot"></i> AI Help</button>
                <button class="btn btn-phone" onclick="window.location.href='/admin/phone'"><i class="fas fa-mobile-alt"></i> Phones</button>
                <div class="sidebar-divider"></div>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    A
                </div>
                <div class="user-details">
                    <h4>Admin User</h4>
                    <p>administrator</p>
                </div>
            </div>
            <div class="footer-buttons">
                <button class="footer-btn" onclick="window.location.href='/admin'">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back</span>
                </button>
                <button class="footer-btn danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <main class="main-container">
        <!-- header title -->
        <div class="mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold gradient-text mb-2">User Management</h1>
            <p class="text-gray-400">Manage system users and administrator privileges</p>
        </div>

        <!-- quick stats (original IDs) -->
        <div class="quick-stats-grid">
            <div class="quick-stat"><div class="stats-icon text-blue-400"><i class="fas fa-users"></i></div><div class="quick-stat-value" id="total-users">0</div><div class="quick-stat-label">Total Users</div></div>
            <div class="quick-stat"><div class="stats-icon text-purple-400"><i class="fas fa-user-shield"></i></div><div class="quick-stat-value" id="admin-users">0</div><div class="quick-stat-label">Administrators</div></div>
            <div class="quick-stat"><div class="stats-icon text-green-400"><i class="fas fa-user"></i></div><div class="quick-stat-value" id="regular-users">0</div><div class="quick-stat-label">Regular Users</div></div>
            <div class="quick-stat"><div class="stats-icon text-yellow-400"><i class="fas fa-user-plus"></i></div><div class="quick-stat-value" id="today-users">0</div><div class="quick-stat-label">Today's Registrations</div></div>
            <div class="quick-stat"><div class="stats-icon text-indigo-400"><i class="fas fa-chart-line"></i></div><div class="quick-stat-value" id="active-today">0</div><div class="quick-stat-label">Active Today</div></div>
            <div class="quick-stat"><div class="stats-icon text-green-400"><i class="fas fa-circle"></i></div><div class="quick-stat-value" id="online-users">0</div><div class="quick-stat-label">Online Now</div></div>
            <div class="quick-stat"><div class="stats-icon text-orange-400"><i class="fas fa-bolt"></i></div><div class="quick-stat-value" id="avg-activity">0</div><div class="quick-stat-label">Avg. Activity</div></div>
            <div class="quick-stat"><div class="stats-icon text-pink-400"><i class="fas fa-fire"></i></div><div class="quick-stat-value" id="total-activity">0</div><div class="quick-stat-label">Total Activities</div></div>
            <div class="quick-stat"><div class="stats-icon text-yellow-400"><i class="fas fa-bell"></i></div><div class="quick-stat-value" id="all-subs-users">0</div><div class="quick-stat-label">Enabled WebPush</div></div>
        </div>

        <!-- online panel (original IDs) -->
        <div class="online-users-panel">
            <div class="card-header flex justify-between items-center">
                <h3 class="section-title font-semibold"><i class="fas fa-circle mr-2 text-green-400"></i> Online Users <span id="online-count">(0)</span></h3>
                <button class="btn btn-info btn-sm" onclick="refreshOnlineUsers()"><i class="fas fa-sync-alt mr-2"></i> Refresh</button>
            </div>
            <div id="online-users-list" class="max-h-40 overflow-y-auto mt-4">
                <div class="text-center text-gray-400 py-4"><div class="spinner mx-auto"></div><p class="mt-2">Loading online users...</p></div>
            </div>
        </div>

        <!-- charts grid (original IDs) -->
        <div class="chart-grid">
            <div class="chart-container"><div class="chart-title">Registration Trend</div><div class="chart-wrapper"><canvas id="registration-chart"></canvas></div></div>
            <div class="chart-container"><div class="chart-title">Activity Distribution</div><div class="chart-wrapper"><canvas id="activity-chart"></canvas></div></div>
            <div class="chart-container"><div class="chart-title">Admin vs Users</div><div class="chart-wrapper"><canvas id="role-chart"></canvas></div></div>
            <div class="chart-container"><div class="chart-title">Activity Timeline</div><div class="chart-wrapper"><canvas id="timeline-chart"></canvas></div></div>
        </div>

        <!-- search/filter panel (original elements) -->
        <div class="filters-panel">
            <div class="flex items-center gap-2 mb-4"><i class="fas fa-search text-blue-400"></i><span class="font-medium">User Search & Filters</span></div>
            <div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" id="search-input" class="search-input" placeholder="Search by username, mobile, ID..."></div>
            <div class="search-filters flex flex-wrap gap-3">
                <select id="role-filter" class="filter-select"><option value="">All Roles</option><option value="admin">Admins</option><option value="user">Users</option></select>
                <select id="activity-filter" class="filter-select"><option value="">All Activity</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
                <select id="status-filter" class="filter-select"><option value="">All Status</option><option value="online">Online</option><option value="offline">Offline</option></select>
                <select id="payment-status-filter" class="filter-select"><option value="">All Payment</option><option value="paid">Paid</option><option value="unpaid">Unpaid</option></select>
                <select id="date-filter" class="filter-select"><option value="">All Time</option><option value="today">Today</option><option value="week">Week</option><option value="month">Month</option></select>
                <button class="btn btn-secondary" id="clear-filters"><i class="fas fa-times mr-2"></i>Clear</button>
            </div>
        </div>

        <!-- user table (original structure) -->
        <div class="table-wrapper">
            <div class="flex flex-wrap justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">All Users <span id="user-count" class="text-gray-400">(0)</span></h2>
                <div class="flex gap-3">
                    <button class="btn" id="refresh-btn" onclick="refreshUsers()"><i class="fas fa-sync-alt mr-2"></i> Refresh</button>
                    <button class="btn btn-success" id="export-btn"><i class="fas fa-download mr-2"></i> Export</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="user-table">
                    <thead><tr><th>ID</th><th>Year</th><th>Username</th><th>Mobile</th><th>Role</th><th>Status</th><th>Payment</th><th>Seen</th><th>Created</th><th>Activity</th><th>Actions</th></tr></thead>
                    <tbody id="users-table-body"><tr><td colspan="11" class="text-center py-8"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
            <!-- pagination (original) -->
            <div class="flex justify-between items-center mt-6">
                <div class="text-sm text-gray-400">Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="showing-total">0</span></div>
                <div class="flex gap-2"><button class="btn btn-secondary" id="prev-page" disabled><i class="fas fa-chevron-left mr-2"></i>Prev</button><button class="btn btn-secondary" id="next-page" disabled>Next<i class="fas fa-chevron-right ml-2"></i></button></div>
            </div>
        </div>
    </main>

    <!-- modals untouched -->
    <div id="confirm-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4" id="confirm-title">Confirm Action</h3><p id="confirm-message" class="text-gray-300 mb-6">Are you sure?</p><div class="flex justify-end gap-3"><button class="btn btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button><button class="btn btn-danger" id="confirm-action-btn"><span class="btn-spinner"></span>Confirm</button></div></div></div>

    <script>
        const API_BASE = '/api';
        const USERS_ENDPOINT = `${API_BASE}/users`;
        const ONLINE_USERS_ENDPOINT = `${API_BASE}/online-users`;
        
        let currentUserId = null;
        let pollInterval;
        let isRefreshing = false;
        let allUsers = [];
        let filteredUsers = [];
        let onlineUsers = [];        
        let currentPage = 1;
        const usersPerPage = 10;
        let charts = {};

        // Initialize charts with smaller sizes
        function initializeCharts() {
            const registrationCtx = document.getElementById('registration-chart').getContext('2d');
            const activityCtx = document.getElementById('activity-chart').getContext('2d');
            const roleCtx = document.getElementById('role-chart').getContext('2d');
            const timelineCtx = document.getElementById('timeline-chart').getContext('2d');
            
            // Registration Trend Chart
            charts.registration = new Chart(registrationCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'User Registrations',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Activity Distribution Chart
            charts.activity = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High Activity', 'Medium Activity', 'Low Activity'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(107, 114, 128, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#F9FAFB',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            
            // Role Distribution Chart
            charts.role = new Chart(roleCtx, {
                type: 'pie',
                data: {
                    labels: ['Administrators', 'Regular Users'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgba(139, 92, 246, 1)',
                            'rgba(59, 130, 246, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#F9FAFB',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            
            // Activity Timeline Chart
            charts.timeline = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'User Activity',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Update charts with backend data
        function updateCharts(users, chartData = null) {
            // Use backend chart data if provided
            if (chartData) {
                if (chartData.registration_trend) {
                    charts.registration.data.labels = chartData.registration_trend.labels || [];
                    charts.registration.data.datasets[0].data = chartData.registration_trend.data || [];
                    charts.registration.update();
                }
                
                if (chartData.activity_distribution) {
                    charts.activity.data.datasets[0].data = [
                        chartData.activity_distribution.high || 0,
                        chartData.activity_distribution.medium || 0,
                        chartData.activity_distribution.low || 0
                    ];
                    charts.activity.update();
                }
                
                if (chartData.role_distribution) {
                    charts.role.data.datasets[0].data = [
                        chartData.role_distribution.admins || 0,
                        chartData.role_distribution.users || 0
                    ];
                    charts.role.update();
                }
                
                if (chartData.activity_timeline) {
                    charts.timeline.data.labels = chartData.activity_timeline.labels || [];
                    charts.timeline.data.datasets[0].data = chartData.activity_timeline.data || [];
                    charts.timeline.update();
                }
            } else {
                // Fallback to frontend calculations if no chart data provided
                // Update registration trend (last 30 days)
                const last30Days = [...Array(30)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                const registrationData = last30Days.map(day => {
                    return users.filter(user => {
                        const userDate = user.created_at.split('T')[0];
                        return userDate === day;
                    }).length;
                });
                
                charts.registration.data.labels = last30Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                charts.registration.data.datasets[0].data = registrationData;
                charts.registration.update();
                
                // Update activity distribution
                const highActivity = users.filter(user => (user.announcements_count + user.assignments_count) > 10).length;
                const mediumActivity = users.filter(user => {
                    const activity = user.announcements_count + user.assignments_count;
                    return activity > 3 && activity <= 10;
                }).length;
                const lowActivity = users.filter(user => (user.announcements_count + user.assignments_count) <= 3).length;
                
                charts.activity.data.datasets[0].data = [highActivity, mediumActivity, lowActivity];
                charts.activity.update();
                
                // Update role distribution
                const adminCount = users.filter(user => user.is_admin).length;
                const userCount = users.length - adminCount;
                
                charts.role.data.datasets[0].data = [adminCount, userCount];
                charts.role.update();
                
                // Update activity timeline (last 7 days)
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                // Calculate activity for each day
                const activityData = last7Days.map(day => {
                    return users.filter(user => {
                        const userDate = new Date(user.created_at).toISOString().split('T')[0];
                        return userDate === day;
                    }).length;
                });
                
                charts.timeline.data.labels = last7Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                charts.timeline.data.datasets[0].data = activityData;
                charts.timeline.update();
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function formatRelativeTime(dateString) {
            if (!dateString) return 'N/A';
        
            // Convert to Date and shift to UTC+3 (Nairobi)
            const dateUTC = new Date(dateString);
            const date = new Date(dateUTC.getTime() + 3 * 60 * 60 * 1000);
        
            // Compare with current Nairobi time
            const nowUTC = new Date();
            const now = new Date(nowUTC.getTime() + 3 * 60 * 60 * 1000);
        
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
        
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(date.toISOString());
        }

        function updateLastUpdated() {
            // Show Nairobi time in the "Last updated" area
            const nowUTC = new Date();
            const nowNairobi = new Date(nowUTC.getTime());
        
            document.getElementById('last-updated-text').textContent =
                `Last updated: ${nowNairobi.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })}`;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');

            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });

        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });        

        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
        
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                    <button class="toast-close absolute -top-0 -right-0 bg-gray-800 hover:bg-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-white border border-gray-600 transition-all" onclick="removeToast('${toastId}')">
                        <i class="fas fa-times text-xs"></i>
                    </button>                    
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with slight delay to allow DOM update
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
        
            // Auto remove after duration (if not already closed)
            const autoRemove = setTimeout(() => {
                removeToast(toastId);
            }, duration);
        
            // Store timeout ID for potential cleanup
            toast.dataset.timeoutId = autoRemove;
        
            return toastId;
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (!toast) return;

            // Clear the auto-remove timeout if it exists
            if (toast.dataset.timeoutId) {
                clearTimeout(parseInt(toast.dataset.timeoutId));
            }

            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }        

        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // Fetch online users
        async function fetchOnlineUsers() {
            try {
                const response = await fetch(ONLINE_USERS_ENDPOINT);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                return [];
            }
        }


        // Display online users
        function displayOnlineUsers(users) {
            const container = document.getElementById('online-users-list');
            const countElement = document.getElementById('online-count');
            const quickStatElement = document.getElementById('online-users');
            
            onlineUsers = users;
            quickStatElement.textContent = users.length;
            countElement.textContent = `(${users.length})`;
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-4">
                        <i class="fas fa-users-slash text-2xl mb-2"></i>
                        <p>No users online</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = users.map(user => `
                <div class="online-user-item">
                    <div class="online-indicator"></div>
                    <div class="flex-1">
                        <div class="font-medium">${user.username || 'Unknown User'}</div>
                        <div class="text-xs text-gray-400">
                            ${user.is_admin ? 'Admin' : 'User'}  ${user.current_room || 'general'}
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${formatRelativeTime(user.last_seen)}
                    </div>
                </div>
            `).join('');
        }

        // Refresh online users
        async function refreshOnlineUsers() {
            try {
                const users = await fetchOnlineUsers();
                displayOnlineUsers(users);
                showToast('Online users updated', 'success');
            } catch (error) {
                showToast('Failed to update online users', 'error');
            }
        }

        // rapidly Refresh online users
        async function rapidRefreshOnlineUsers() {
            try {
                const users = await fetchOnlineUsers();
                displayOnlineUsers(users);
            } catch (error) {
                console.log("Failed to Refresh User");
            }
        }

        // Enhanced user search and filtering
        function filterUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const activityFilter = document.getElementById('activity-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const paymentStatusFilter = document.getElementById('payment-status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            filteredUsers = allUsers.filter(user => {
                // Text search
                const matchesSearch = !searchTerm || 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                    (user.mobile && user.mobile.includes(searchTerm)) ||
                    (user.id && user.id.toString().includes(searchTerm));
                
                // Role filter
                const matchesRole = !roleFilter || 
                    (roleFilter === 'admin' && user.is_admin) ||
                    (roleFilter === 'user' && !user.is_admin);
                    
                // Payment Status filter
                const matchesPayment = !paymentStatusFilter || 
                    (paymentStatusFilter === 'paid' && user.paid) ||
                    (paymentStatusFilter === 'unpaid' && !user.paid);
                    
                // Activity filter
                let matchesActivity = true;
                if (activityFilter) {
                    const totalActivity = user.announcements_count + user.assignments_count;
                    if (activityFilter === 'high') {
                        matchesActivity = totalActivity > 10;
                    } else if (activityFilter === 'medium') {
                        matchesActivity = totalActivity > 3 && totalActivity <= 10;
                    } else if (activityFilter === 'low') {
                        matchesActivity = totalActivity <= 3;
                    }
                }
                
                // Status filter (online/offline)
                let matchesStatus = true;
                if (statusFilter) {
                    const isOnline = onlineUsers.some(onlineUser => onlineUser.user_id === user.id);
                    if (statusFilter === 'online') {
                        matchesStatus = isOnline;
                    } else if (statusFilter === 'offline') {
                        matchesStatus = !isOnline;
                    }
                }
                
                // Date filter
                let matchesDate = true;
                if (dateFilter) {
                    const userDate = new Date(user.created_at);
                    const now = new Date();
                    
                    if (dateFilter === 'today') {
                        matchesDate = userDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = userDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        matchesDate = userDate >= monthAgo;
                    }
                }
                
                return matchesSearch && matchesRole && matchesActivity && matchesStatus && matchesDate;
            });
            
            currentPage = 1;
            updateUserTable();
            updatePagination();
        }

        function updatePagination(paginationData = null) {
            let totalUsers, totalPages;

            if (paginationData) {
                // Use backend pagination data - use total_filtered for accurate page count
                totalUsers = paginationData.total_filtered || paginationData.total || filteredUsers.length;
                totalPages = paginationData.pages || Math.ceil(totalUsers / usersPerPage);
            } else {
                // Fallback to frontend calculation
                totalUsers = filteredUsers.length;
                totalPages = Math.ceil(totalUsers / usersPerPage);
            }

            const startIndex = (currentPage - 1) * usersPerPage + 1;
            const endIndex = Math.min(currentPage * usersPerPage, totalUsers);

            document.getElementById('showing-start').textContent = totalUsers > 0 ? startIndex : 0;
            document.getElementById('showing-end').textContent = endIndex;
            document.getElementById('showing-total').textContent = totalUsers;
            document.getElementById('user-count').textContent = `(${totalUsers})`;

            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;

        }

        function updateStatistics(users, stats = null) {
            if (stats) {
                document.getElementById('total-users').textContent = stats.total_users || 0;
                document.getElementById('admin-users').textContent = stats.admin_users || 0;
                document.getElementById('regular-users').textContent = stats.regular_users || 0;
                document.getElementById('today-users').textContent = stats.today_users || 0;
                document.getElementById('active-today').textContent = stats.active_today || 0;
                document.getElementById('online-users').textContent = stats.online_users || 0;
                document.getElementById('avg-activity').textContent = stats.avg_activity || 0;
                document.getElementById('total-activity').textContent = stats.total_activity || 0;
                document.getElementById('all-subs-users').textContent = stats.total_webpush_users || 0;
            } else {
                const totalUsers = users.length;
                const adminUsers = users.filter(user => user.is_admin).length;
                const regularUsers = totalUsers - adminUsers;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayUsers = users.filter(user => {
                    const userDate = new Date(user.created_at);
                    return userDate >= today;
                }).length;
                
                const activeToday = users.filter(user => {
                    return Math.random() > 0.7; // 30% of users are "active today"
                }).length;
                
                // Calculate average activity
                const totalActivity = users.reduce((sum, user) => {
                    return sum + user.announcements_count + user.assignments_count;
                }, 0);
                const avgActivity = totalUsers > 0 ? (totalActivity / totalUsers).toFixed(1) : 0;

                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('admin-users').textContent = adminUsers;
                document.getElementById('regular-users').textContent = regularUsers;
                document.getElementById('today-users').textContent = todayUsers;
                document.getElementById('active-today').textContent = activeToday;
                document.getElementById('avg-activity').textContent = avgActivity;
                document.getElementById('total-activity').textContent = totalActivity;
            }
        }

        async function fetchUsers(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: usersPerPage
                });

                // Add search and filter parameters if they exist
                const searchTerm = document.getElementById('search-input').value;
                const roleFilter = document.getElementById('role-filter').value;
                const paymentStatusFilter = document.getElementById('payment-status-filter').value;
                const activityFilter = document.getElementById('activity-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const dateFilter = document.getElementById('date-filter').value;

                if (searchTerm) params.append('search', searchTerm);
                if (roleFilter) params.append('role', roleFilter);
                if (paymentStatusFilter) params.append('payment_filter', paymentStatusFilter);
                if (activityFilter) params.append('activity_level', activityFilter);
                if (statusFilter) params.append('status', statusFilter);
                if (dateFilter) params.append('date_filter', dateFilter);

                const response = await fetch(`${USERS_ENDPOINT}?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                showToast('Failed to load users: ' + error.message, 'error');
                return { users: [], pagination: null, stats: null, chart_data: null };
            }
        }

        async function loadUsers(page = 1) {
            if (isRefreshing) return;

            try {
                isRefreshing = true;
                setButtonLoading(document.getElementById('refresh-btn'), true);

                const data = await fetchUsers(page);
                allUsers = data.users || []; // Extract users array from response
                filteredUsers = [...allUsers];
                currentPage = page;

                updateLastUpdated();
                updateStatistics(allUsers, data.stats); // Pass stats to update function
                updateCharts(allUsers, data.chart_data); // Pass chart data to update function
                updateUserTable();
                updatePagination(data.pagination);

                setButtonLoading(document.getElementById('refresh-btn'), false);
                isRefreshing = false;

                if (allUsers.length === 0) {
                    showToast('No users found matching your criteria', 'info');
                } else {
                    showToast(`Loaded ${allUsers.length} users successfully`, 'success');
                }
            } catch (error) {
                document.getElementById('users-table-body').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Error loading users. Please try again.
                            <br><small class="text-gray-400">${error.message}</small>
                        </td>
                    </tr>
                `;
                setButtonLoading(document.getElementById('refresh-btn'), false);
                isRefreshing = false;
                showToast('Failed to load users', 'error');
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-400">
                            <i class="fas fa-users mr-2"></i>
                            No users found.
                        </td>
                    </tr>
                `;
                return;
            }

            container.innerHTML = users.map(user => {
                const isOnline = onlineUsers.some(onlineUser => onlineUser.user_id === user.id);
                const totalActivity = user.announcements_count + user.assignments_count;
                const activityPercentage = Math.min(totalActivity * 5, 100);
                
                return `
                <tr>
                    <td class="font-mono text-sm">#${user.id}</td>
                    <td class="text-center">${user.year || 'N/A'}</td>
                    <td>
                        <div class="font-medium">${user.username || 'N/A'}</div>
                        <div class="text-xs text-gray-400">ID: ${user.id}</div>
                    </td>
                    <td>${user.mobile || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${user.is_admin ? 'status-admin' : 'status-user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>
                        ${(() => {
                            const status = (user.status === true || user.status === 'true' || user.status === 1);
                        
                            return `
                                <span class="status-badge ${status ? 'status-allowed' : 'status-banned'}">
                                    ${status ? 'Allowed' : 'Banned'}
                                </span>
                            `;
                        })()}
                    </td>
                    <td>
                        ${(() => {
                            const paid = (user.paid === true || user.paid === 'true' || user.paid === 1);
                        
                            return `
                                <span class="status-badge ${paid ? 'status-allowed' : 'status-banned'}">
                                    ${paid ? 'Paid' : 'Unpaid'}
                                </span>
                            `;
                        })()}
                    </td>
                    <td>
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-user'}">
                            ${isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>
                        <div class="text-sm">${formatDate(user.created_at)}</div>
                        <div class="text-xs text-gray-400">${formatRelativeTime(user.created_at)}</div>
                    </td>
                    <td>
                        <div class="text-sm">
                            <i class="fas fa-bullhorn mr-1 text-blue-400"></i> ${user.announcements_count}
                            <i class="fas fa-tasks ml-3 mr-1 text-green-400"></i> ${user.assignments_count}
                        </div>
                        <div class="activity-bar">
                            <div class="activity-progress" style="width: ${activityPercentage}%"></div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${user.is_admin ? 
                                `<button class="btn btn-warning btn-sm toggle-admin-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-minus mr-1"></i> Remove Admin
                                </button>` :
                                `<button class="btn btn-warning btn-sm toggle-admin-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-shield mr-1"></i> Make Admin
                                </button>`
                            }
                            ${!user.is_admin ? 
                                `<button class="btn btn-danger btn-sm delete-user-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>` :
                                `<button class="btn btn-secondary btn-sm" disabled>
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>`
                            }
                            ${(() => {
                                
                                const status = (user.status === true || user.status === 'true' || user.status === 1);

                                return status ? 
                                    `<button class="btn btn-danger btn-sm toggle-status-btn" data-user-id="${user.id}">
                                        <span class="btn-spinner"></span>
                                        <i class="fas fa-user-slash mr-1"></i> Ban
                                    </button>` :
                                    `<button class="btn btn-success btn-sm toggle-status-btn" data-user-id="${user.id}">
                                        <span class="btn-spinner"></span>
                                        <i class="fas fa-user-check mr-1"></i> Unban
                                    </button>`;
                            })()}
                            ${(() => {
                                
                                const paid = (user.paid === true || user.paid === 'true' || user.paid === 1);

                                return paid ? 
                                    `<button class="btn btn-danger btn-sm toggle-pay-btn" data-user-id="${user.id}">
                                        <span class="btn-spinner"></span>
                                        <i class="fas fa-user-slash mr-1"></i> Unpay
                                    </button>` :
                                    `<button class="btn btn-success btn-sm toggle-pay-btn" data-user-id="${user.id}">
                                        <span class="btn-spinner"></span>
                                        <i class="fas fa-user-check mr-1"></i> Pay
                                    </button>`;
                            })()}
                            ${user.year === 5 ? 
                                `<div class="relative group">
                                    <button disabled 
                                            class="btn btn-secondary btn-sm cursor-not-allowed">
                                        <i class="fas fa-lock mr-1.5"></i>
                                        Modify
                                    </button>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-gray-300 text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                                        System accounts cannot be modified
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-gray-900"></div>
                                    </div>
                                </div>` :
                                `<button onclick="window.location.href='/admin/${user.id}/modify'" 
                                   class="btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white btn-sm">
                                    <i class="fas fa-edit mr-1.5"></i>
                                    Modify
                                </button>`
                            }                            
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            document.querySelectorAll('.toggle-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    toggleAdmin(userId, this);
                });
            });
            
            document.querySelectorAll('.toggle-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    toggleStatus(userId, this);
                });
            });

            document.querySelectorAll('.toggle-pay-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    togglePay(userId, this);
                });
            });

            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    confirmDelete(userId, this);
                });
            });
        }

        function updateUserTable() {
            displayUsers(filteredUsers);
        }

        function filterUsers() {
            
            currentPage = 1;
            loadUsers(currentPage);
        }

        // Update user status for control
        async function toggleStatus(userId, button) {
            if (!userId) return;
            
            try {
                setButtonLoading(button, true);

                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()    
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update user status');
                }

                const result = await response.json();
                showToast(`User status updated successfully`, 'success');
                await loadUsers(); //Refresh list
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                setButtonLoading(button, false);
            }
        }

        // Update user pay for control
        async function togglePay(userId, button) {
            if (!userId) return;
            
            try {
                setButtonLoading(button, true);

                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-pay`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()    
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update user paid status');
                }

                const result = await response.json();
                showToast(`User Paid Status updated successfully`, 'success');
                await loadUsers(); //Refresh list
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                setButtonLoading(button, false);
            }
        }

        async function toggleAdmin(userId, button) {
            if (!userId) return;
            
            try {
                setButtonLoading(button, true);
                
                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-admin`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update admin status');
                }
                
                const result = await response.json();
                showToast(`Admin status updated successfully`, 'success');
                await loadUsers(); // Refresh list
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                setButtonLoading(button, false);
            }
        }

        // Get CSRF token for Flask-WTF protection
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }

        // Confirm delete
        function confirmDelete(userId, button) {
            currentUserId = userId;
            currentButton = button;
            document.getElementById('confirm-title').textContent = 'Confirm User Deletion';
            document.getElementById('confirm-message').textContent = 
                'Are you sure you want to delete this user? This action cannot be undone.';
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = () => deleteUser(button);
            
            openModal('confirm-modal');
        }

        async function deleteUser(button) {
            if (!currentUserId) return;
            
            try {
                setButtonLoading(document.getElementById('confirm-action-btn'), true);
                
                const response = await fetch(`${USERS_ENDPOINT}/${currentUserId}/delete`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }
                
                closeModal('confirm-modal');
                showToast('User deleted successfully', 'success');
                await loadUsers(); // Refresh list
                currentUserId = null;
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                setButtonLoading(document.getElementById('confirm-action-btn'), false);
                closeModal('confirm-modal');
            }
        }

        function refreshUsers() {
            loadUsers(currentPage);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            setButtonLoading(document.getElementById('confirm-action-btn'), false);
        }

        function exportUserData() {
            showToast('Preparing user data for export...', 'info', 3000);
            setTimeout(() => {
                window.location.href = '/admin/users-manager';
            }, 2000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                setButtonLoading(document.getElementById('confirm-action-btn'), false);
            }
        }

        function logout() {
            showToast("Logging out...", 'info', 2000);
            setTimeout(() => {
              window.location.href = '/logout';  
            }, 1500);
        }

        function stopAllPolling() {
            if (pollInterval) clearInterval(pollInterval);
            if (rapidPolling) clearInterval(rapidPolling);
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAllPolling();
            } else {
                // refresh immediately upon page unhidding/visible
                refreshOnlineUsers();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeCharts();
            
            // Load initial data
            loadUsers();
            refreshOnlineUsers();
            
            // Set up event listeners for search and filters
            document.getElementById('search-input').addEventListener('input', filterUsers);
            document.getElementById('role-filter').addEventListener('change', filterUsers);
            document.getElementById('payment-status-filter').addEventListener('change', filterUsers);
            document.getElementById('activity-filter').addEventListener('change', filterUsers);
            document.getElementById('status-filter').addEventListener('change', filterUsers);
            document.getElementById('date-filter').addEventListener('change', filterUsers);
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.getElementById('search-input').value = '';
                document.getElementById('role-filter').value = '';
                document.getElementById('payment-status-filter').value = '';
                document.getElementById('activity-filter').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('date-filter').value = '';
                filterUsers();
            });
            
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    loadUsers(currentPage - 1);
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                loadUsers(currentPage + 1);
            });
            
            // Export button
            document.getElementById('export-btn').addEventListener('click', exportUserData);
            
            // Auto-refresh
            pollInterval = setInterval(() => {
                loadUsers(currentPage);
                refreshOnlineUsers();
            }, 120000);
            
            // Auto Rapid Poll
            rapidPolling = setInterval(() => {
                rapidRefreshOnlineUsers();
            }, 10000); //10s

            window.addEventListener('beforeunload', function() {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    clearInterval(rapidPolling);
                }
            });
        });
    </script>
</body>
</html>