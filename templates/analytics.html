<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard | LyxNexus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827;
            --text-color: #F9FAFB;
            --accent-color: #4A90E2;
            --secondary-color: #8B5CF6;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-morph {
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 31, 135, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .glass-morph:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 31, 135, 0.3);
        }
        
        .btn {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(30, 30, 40, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #9CA3AF;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .trend-up { color: #10B981; }
        .trend-down { color: #EF4444; }
        
        .chart-container {
            background: rgba(30, 30, 40, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chart-container:hover {
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Fixed chart wrapper sizes */
        .chart-wrapper {
            position: relative;
            width: 100%;
            margin: 0 auto;
        }
        
        .chart-wrapper-large {
            height: 300px;
        }
        
        .chart-wrapper-medium {
            height: 280px;
        }
        
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
        }
        
        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-feed::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .activity-feed::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .activity-feed::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .activity-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .activity-time {
            color: #9CA3AF;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .section-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3B82F6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #10B981;
            font-weight: 600;
        }
        
        .card-hover-lift {
            transition: all 0.3s ease;
        }
        
        .card-hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .text-shimmer {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #3B82F6);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s infinite linear;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .count-up {
            animation: countUp 1.5s ease-out;
        }
        
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Header -->
    <header class="glass-morph sticky top-0 z-50 mb-8 floating">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-4 md:mb-0 slide-in-left">
                    <div class="logo-container bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-2 glow">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">Analytics Dashboard</h1>
                        <div class="flex items-center space-x-2">
                            <p class="text-sm text-gray-400">Real-time user activity tracking</p>
                            <div class="live-indicator">
                                <div class="pulse-dot"></div>
                                <span>LIVE</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 slide-in-right">
                    <span class="text-sm text-gray-400 hidden md:block">Last 24 hours</span>
                    <button onclick="refreshAnalytics()" class="btn flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Stats Grid -->
        <div class="analytics-grid">
            <div class="stat-card border-l-blue-500 card-hover-lift fade-in" style="animation-delay: 0.1s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="total-visits">0</div>
                        <div class="stat-label">Total Visits</div>
                        <div class="stat-trend trend-up" id="visits-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-blue-500/20 rounded-xl">
                        <i class="fas fa-users text-blue-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-green-500 card-hover-lift fade-in" style="animation-delay: 0.2s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="unique-visitors">0</div>
                        <div class="stat-label">Unique Visitors</div>
                        <div class="stat-trend trend-up" id="visitors-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-green-500/20 rounded-xl">
                        <i class="fas fa-user-check text-green-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-purple-500 card-hover-lift fade-in" style="animation-delay: 0.3s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="active-sections">0</div>
                        <div class="stat-label">Active Sections</div>
                        <div class="stat-trend trend-up" id="sections-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-purple-500/20 rounded-xl">
                        <i class="fas fa-layer-group text-purple-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-yellow-500 card-hover-lift fade-in" style="animation-delay: 0.4s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="peak-hour">--:--</div>
                        <div class="stat-label">Peak Activity Hour</div>
                        <div class="stat-trend trend-up" id="peak-trend">Most active</div>
                    </div>
                    <div class="p-3 bg-yellow-500/20 rounded-xl">
                        <i class="fas fa-chart-line text-yellow-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
            <!-- Visits per Hour -->
            <div class="chart-container xl:col-span-2 card-hover-lift fade-in" style="animation-delay: 0.5s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer">Visits per Hour (Last 24h)</h3>
                    <div class="flex space-x-2">
                        <button class="text-xs px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full font-medium transition-all hover:scale-105">24H</button>
                        <button class="text-xs px-3 py-1 bg-gray-700 text-gray-400 rounded-full font-medium transition-all hover:scale-105" onclick="switchToWeeklyView()">7D</button>
                    </div>
                </div>
                <div class="chart-wrapper chart-wrapper-large">
                    <canvas id="visitsChart"></canvas>
                </div>
            </div>
            
            <!-- Section Popularity -->
            <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.6s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer">Section Popularity</h3>
                    <i class="fas fa-chart-pie text-purple-400 floating"></i>
                </div>
                <div class="chart-wrapper chart-wrapper-medium">
                    <canvas id="sectionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Activity & Quick Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Activity Feed -->
            <div class="chart-container lg:col-span-2 card-hover-lift fade-in" style="animation-delay: 0.7s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer">Recent User Activity</h3>
                    <span class="text-sm text-gray-400" id="activity-count">0 activities</span>
                </div>
                <div class="activity-feed" id="activity-feed">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats & Top Sections -->
            <div class="space-y-6">
                <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.8s">
                    <h3 class="text-xl font-bold text-shimmer mb-4">Top Sections</h3>
                    <div id="top-sections">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Overview -->
                <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.9s">
                    <h3 class="text-xl font-bold text-shimmer mb-4">Platform Overview</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Most Popular</span>
                            <span class="font-semibold text-blue-400" id="popular-section">--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Avg. Visits/Hour</span>
                            <span class="font-semibold text-green-400" id="avg-visits-hour">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Data Last Updated</span>
                            <span class="font-semibold text-purple-400" id="last-updated">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let visitsChart, sectionsChart;
        let refreshInterval;
        let currentView = '24h';
        
        // Enhanced chart configuration with animations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: '#e5e7eb',
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 11
                        }
                    }
                }
            }
        };
        
        async function loadAnalytics() {
            try {
                showLoadingStates();
                
                const response = await fetch('/api/analytics/visits');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                console.log('Analytics Data:', data); // Debug log
                
                // Animate stats counting up
                animateStats(data);
                updateCharts(data);
                updateActivityFeed(data);
                updateTopSections(data);
                updateQuickStats(data);
                
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                showErrorStates();
            } finally {
                hideLoadingStates();
            }
        }
        
        function animateStats(data) {
            // Animate total visits
            animateValue('total-visits', 0, data.total_visits || 0, 1500);
            // Animate unique visitors
            animateValue('unique-visitors', 0, data.unique_visitors || 0, 1500);
            // Update other stats
            const activeSections = data.section_stats?.length || 0;
            document.getElementById('active-sections').textContent = activeSections;
            
            if (data.visits_per_hour && data.visits_per_hour.length > 0) {
                const peak = data.visits_per_hour.reduce((max, curr) => curr.count > max.count ? curr : max, data.visits_per_hour[0]);
                document.getElementById('peak-hour').textContent = `${peak.hour.toString().padStart(2, '0')}:00`;
            }
            
            updateTrends(data);
        }
        
        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current.toLocaleString();
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
        
        function showLoadingStates() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'flex';
            });
        }
        
        function hideLoadingStates() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        function showErrorStates() {
            document.getElementById('activity-feed').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
                    <p class="text-gray-400 mb-2">Failed to load analytics data</p>
                    <button onclick="loadAnalytics()" class="text-blue-400 hover:text-blue-300 text-sm">
                        <i class="fas fa-redo mr-1"></i> Retry
                    </button>
                </div>
            `;
        }
        
        function updateTrends(data) {
            const visitsTrend = data.total_visits > 50 ? '↑ High traffic' : data.total_visits > 20 ? '↑ Normal traffic' : '↑ Low traffic';
            const visitorsTrend = data.unique_visitors > 10 ? '↑ Many users' : data.unique_visitors > 5 ? '↑ Steady growth' : '↑ Starting up';
            const sectionsTrend = data.section_stats?.length > 3 ? '↑ Good engagement' : data.section_stats?.length > 1 ? '↑ Balanced usage' : '↑ Focused usage';
            
            document.getElementById('visits-trend').textContent = visitsTrend;
            document.getElementById('visitors-trend').textContent = visitorsTrend;
            document.getElementById('sections-trend').textContent = sectionsTrend;
        }
        
        function updateCharts(data) {
            updateVisitsChart(data);
            updateSectionsChart(data);
        }
        
        function updateVisitsChart(data) {
            const visitsCtx = document.getElementById('visitsChart').getContext('2d');
            if (visitsChart) visitsChart.destroy();
            
            // Prepare visits data - ensure we have data for all 24 hours
            let visitsData = [];
            if (data.visits_per_hour && data.visits_per_hour.length > 0) {
                console.log('Raw visits per hour:', data.visits_per_hour); // Debug log
                
                // Create a map for easier lookup - handle both string and number hours
                const visitsMap = new Map();
                data.visits_per_hour.forEach(v => {
                    const hour = typeof v.hour === 'string' ? parseInt(v.hour) : v.hour;
                    visitsMap.set(hour, v.count);
                });
                
                // Fill in all 24 hours with proper data
                for (let hour = 0; hour < 24; hour++) {
                    visitsData.push({
                        hour: hour,
                        count: visitsMap.get(hour) || 0
                    });
                }
            } else {
                // Fallback to zero data for all hours
                visitsData = Array.from({length: 24}, (_, i) => ({
                    hour: i,
                    count: 0
                }));
            }
            
            // Sort by hour to ensure correct order
            visitsData.sort((a, b) => a.hour - b.hour);
            
            console.log('Processed visits data:', visitsData); // Debug log
            
            visitsChart = new Chart(visitsCtx, {
                type: 'line',
                data: {
                    labels: visitsData.map(v => `${v.hour.toString().padStart(2, '0')}:00`),
                    datasets: [{
                        label: 'Visits',
                        data: visitsData.map(v => v.count),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e7eb',
                            borderColor: '#3B82F6',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Hour: ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    return `Visits: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 9 },
                                maxTicksLimit: 12
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }
        
        function updateSectionsChart(data) {
            const sectionsCtx = document.getElementById('sectionsChart').getContext('2d');
            if (sectionsChart) sectionsChart.destroy();
            
            const sectionsData = data.section_stats || [];
            
            console.log('Section stats:', sectionsData); // Debug log
            
            // Format section names and ensure we have data
            const formattedSections = sectionsData.map(s => {
                const sectionName = s.section || 'unknown';
                return sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            });
            
            // If no section data, show a placeholder
            if (sectionsData.length === 0) {
                sectionsData.push({ section: 'No Data', count: 1 });
                formattedSections.push('No Data');
            }
            
            sectionsChart = new Chart(sectionsCtx, {
                type: 'doughnut',
                data: {
                    labels: formattedSections,
                    datasets: [{
                        data: sectionsData.map(s => s.count),
                        backgroundColor: [
                            '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444',
                            '#6366F1', '#EC4899', '#14B8A6', '#F97316', '#6B7280'
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...chartConfig,
                    cutout: '60%',
                    plugins: {
                        ...chartConfig.plugins,
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e7eb',
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });
        }
        
        function updateActivityFeed(data) {
            const feed = document.getElementById('activity-feed');
            const activities = data.recent_activity || [];
            
            document.getElementById('activity-count').textContent = `${activities.length} activities`;
            
            if (activities.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">No recent activity in the last 24 hours</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = activities.map((activity, index) => `
                <div class="activity-item glass-morph" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center gap-4">
                        <div class="user-avatar">
                            ${activity.username ? activity.username.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <div class="font-semibold text-white truncate">${activity.username || 'Unknown User'}</div>
                                <div class="activity-time">${formatActivityTime(activity.timestamp)}</div>
                            </div>
                            <div class="text-sm text-gray-300 flex items-center flex-wrap gap-1">
                                <span>${getActionText(activity.action, activity.target)}</span>
                                ${activity.target && activity.target !== 'main_page' && activity.target !== 'null' ? 
                                    `<span class="section-badge">${formatSectionName(activity.target)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTopSections(data) {
            const container = document.getElementById('top-sections');
            const sections = data.section_stats || [];
            
            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar text-2xl text-gray-600 mb-2"></i>
                        <p class="text-gray-400 text-sm">No section data available</p>
                    </div>
                `;
                return;
            }
            
            // Sort by count and take top 5
            const topSections = sections
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            container.innerHTML = topSections.map((section, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg mb-2 last:mb-0 transition-all hover:bg-gray-800/50 hover:scale-105" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm font-bold">
                            ${index + 1}
                        </div>
                        <span class="font-medium text-sm">${formatSectionName(section.section)}</span>
                    </div>
                    <span class="text-blue-400 font-semibold">${section.count}</span>
                </div>
            `).join('');
        }
        
        function updateQuickStats(data) {
            const sections = data.section_stats || [];
            const visits = data.visits_per_hour || [];
            
            // Most popular section
            if (sections.length > 0) {
                const popular = sections.reduce((max, curr) => curr.count > max.count ? curr : max, sections[0]);
                document.getElementById('popular-section').textContent = formatSectionName(popular.section);
            } else {
                document.getElementById('popular-section').textContent = 'None';
            }
            
            // Average visits per hour
            if (visits.length > 0) {
                const totalVisits = visits.reduce((sum, curr) => sum + curr.count, 0);
                const avgVisits = Math.round((totalVisits / visits.length) * 10) / 10;
                document.getElementById('avg-visits-hour').textContent = avgVisits;
            } else {
                document.getElementById('avg-visits-hour').textContent = '0';
            }
        }
        
        function formatSectionName(section) {
            if (!section || section === 'null') return 'Unknown';
            return section.charAt(0).toUpperCase() + section.slice(1);
        }
        
        function getActionText(action, target) {
            const actions = {
                'page_view': `Viewed main page`,
                'section_view': `Navigated to ${formatSectionName(target) || 'unknown section'}`,
                'file_download': `Downloaded file`,
                'page_exit': `Session ended`
            };
            return actions[action] || `${action} ${target || ''}`;
        }
        
        function formatActivityTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }
        
        function refreshAnalytics() {
            const btn = event?.target || document.querySelector('button[onclick="refreshAnalytics()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Refreshing...';
            btn.disabled = true;
            
            // Add refresh animation to stats
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.add('glow');
                setTimeout(() => card.classList.remove('glow'), 2000);
            });
            
            loadAnalytics().finally(() => {
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 1000);
            });
        }
        
        function switchToWeeklyView() {
            // This would switch to weekly view - for future implementation
            alert('Weekly view coming soon! Currently showing last 24 hours.');
        }
        
        // Initialize analytics
        document.addEventListener('DOMContentLoaded', function() {
            // Staggered loading animation
            setTimeout(() => {
                loadAnalytics();
            }, 500);

            // Auto-refresh every 1 minute
            refreshInterval = setInterval(loadAnalytics, 60000);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (visitsChart) {
                visitsChart.resize();
            }
            if (sectionsChart) {
                sectionsChart.resize();
            }
        });
    </script>
</body>
</html>