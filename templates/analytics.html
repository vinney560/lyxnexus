<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | LyxNexus Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827;
            --text-color: #F9FAFB;
            --accent-color: #4A90E2;
            --secondary-color: #8B5CF6;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-morph {
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 31, 135, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .glass-morph:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 31, 135, 0.3);
        }
        
        .btn {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            color: white;
            border: none;
            padding: 10px 19px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(30, 30, 40, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #9CA3AF;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .trend-up { color: #10B981; }
        .trend-down { color: #EF4444; }
        
        .chart-container {
            background: rgba(30, 30, 40, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chart-container:hover {
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Fixed chart wrapper sizes */
        .chart-wrapper {
            position: relative;
            width: 100%;
            margin: 0 auto;
        }
        
        .chart-wrapper-large {
            height: 300px;
        }
        
        .chart-wrapper-medium {
            height: 280px;
        }
        
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
        }
        
        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-feed::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .activity-feed::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .activity-feed::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .activity-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(5px);
        }
        
        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .activity-time {
            color: #9CA3AF;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .section-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3B82F6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #10B981;
            font-weight: 600;
        }
        
        .card-hover-lift {
            transition: all 0.3s ease;
        }
        
        .card-hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .text-shimmer {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #3B82F6);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s infinite linear;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .count-up {
            animation: countUp 1.5s ease-out;
        }
        
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-overlay::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .modal-overlay::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .modal-overlay::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        .modal-content {
            background: var(--bg-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .user-select-container {
            position: relative;
        }
        
        .user-select-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .user-select-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .user-select-container::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .user-select-container::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 40, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .user-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        
        .user-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .user-dropdown::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .user-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .user-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }
        
        .user-option:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .user-option:last-child {
            border-bottom: none;
        }
        
        .time-range-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .time-range-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            background: rgba(30, 30, 40, 0.7);
            color: #9CA3AF;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-range-btn.active {
            background: rgba(59, 130, 246, 0.3);
            color: #3B82F6;
            border-color: #3B82F6;
        }
        
        .time-range-btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .user-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .user-detail-card {
            background: rgba(30, 30, 40, 0.7);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid #3B82F6;
        }
        
        .user-detail-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-detail-label {
            color: #9CA3AF;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Header -->
    <header class="glass-morph sticky top-0 z-50 mb-8 floating">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-4 md:mb-0 slide-in-left">
                    <div class="logo-container bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-2 glow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                            <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                            <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">Analytics Dashboard</h1>
                        <div class="flex items-center space-x-2">
                            <p class="text-sm text-gray-400">Real-time user activity tracking</p>
                            <div class="live-indicator">
                                <div class="pulse-dot"></div>
                                <span>LIVE</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 slide-in-right items-center">
                    <span class="text-sm text-gray-400 hidden md:block" id="current-range-display">Last 24 hours</span>
                    <button onclick="showUserAnalyticsModal()" class="btn btn-secondary flex items-center space-x-2">
                        <i class="fas fa-user mr-2"></i> User Visit
                    </button>
                    <button onclick="refreshAnalytics()" id="refreshData" class="btn flex items-center space-x-2">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                    <button class="btn flex items-center space-x-2" id="backBtn">
                        <i class="fas fa-arrow-left mr-2"></i> Go Back
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Time Range Selector -->
        <div class="time-range-selector justify-center mb-6">
            <button class="time-range-btn active" data-range="24h" onclick="switchTimeRange('24h')">24 Hours</button>
            <button class="time-range-btn" data-range="7d" onclick="switchTimeRange('7d')">7 Days</button>
            <button class="time-range-btn" data-range="30d" onclick="switchTimeRange('30d')">30 Days</button>
        </div>

        <!-- Stats Grid -->
        <div class="analytics-grid">
            <div class="stat-card border-l-blue-500 card-hover-lift fade-in" style="animation-delay: 0.1s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="total-visits">0</div>
                        <div class="stat-label">Total Visits</div>
                        <div class="stat-trend trend-up" id="visits-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-blue-500/20 rounded-xl">
                        <i class="fas fa-users text-blue-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-green-500 card-hover-lift fade-in" style="animation-delay: 0.2s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="unique-visitors">0</div>
                        <div class="stat-label">Unique Visitors</div>
                        <div class="stat-trend trend-up" id="visitors-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-green-500/20 rounded-xl">
                        <i class="fas fa-user-check text-green-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-purple-500 card-hover-lift fade-in" style="animation-delay: 0.3s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="active-sections">0</div>
                        <div class="stat-label">Active Sections</div>
                        <div class="stat-trend trend-up" id="sections-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-purple-500/20 rounded-xl">
                        <i class="fas fa-layer-group text-purple-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card border-l-yellow-500 card-hover-lift fade-in" style="animation-delay: 0.4s">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-number count-up" id="total-duration">0</div>
                        <div class="stat-label">Total Session Duration</div>
                        <div class="stat-trend trend-up" id="duration-trend">↑ Loading...</div>
                    </div>
                    <div class="p-3 bg-yellow-500/20 rounded-xl">
                        <i class="fas fa-clock text-yellow-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
            <!-- Visits per Time -->
            <div class="chart-container xl:col-span-2 card-hover-lift fade-in" style="animation-delay: 0.5s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer" id="visits-chart-title">Visits per Hour (Last 24h)</h3>
                    <div class="flex space-x-2">
                        <button class="time-range-btn active" data-range="24h" onclick="switchTimeRange('24h')">24H</button>
                        <button class="time-range-btn" data-range="7d" onclick="switchTimeRange('7d')">7D</button>
                        <button class="time-range-btn" data-range="30d" onclick="switchTimeRange('30d')">30D</button>
                    </div>
                </div>
                <div class="chart-wrapper chart-wrapper-large">
                    <canvas id="visitsChart"></canvas>
                </div>
            </div>
            
            <!-- Section Popularity -->
            <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.6s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer">Section Popularity</h3>
                    <i class="fas fa-chart-pie text-purple-400 floating"></i>
                </div>
                <div class="chart-wrapper chart-wrapper-medium">
                    <canvas id="sectionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Activity & Quick Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Activity Feed -->
            <div class="chart-container lg:col-span-2 card-hover-lift fade-in" style="animation-delay: 0.7s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-shimmer">Recent Activity</h3>
                    <span class="text-sm text-gray-400" id="activity-count">0 activities</span>
                </div>
                <div class="activity-feed" id="activity-feed">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats & Top Sections -->
            <div class="space-y-6">
                <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.8s">
                    <h3 class="text-xl font-bold text-shimmer mb-4">Top Sections</h3>
                    <div id="top-sections">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Overview -->
                <div class="chart-container card-hover-lift fade-in" style="animation-delay: 0.9s">
                    <h3 class="text-xl font-bold text-shimmer mb-4">Platform Overview</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Most Popular</span>
                            <span class="font-semibold text-blue-400" id="popular-section">--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Avg. Duration</span>
                            <span class="font-semibold text-green-400" id="avg-duration">0s</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg transition-all hover:bg-gray-800/70">
                            <span class="text-gray-400">Data Last Updated</span>
                            <span class="font-semibold text-purple-400" id="last-updated">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Analytics Modal -->
    <div id="userAnalyticsModal" class="modal-overlay hidden">
        <div class="modal-content glass-morph w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold gradient-text">User Analytics</h2>
                <button onclick="hideUserAnalyticsModal()" class="text-gray-400 hover:text-white text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="user-select-container mb-6">
                <label class="block text-gray-400 mb-2">Select User</label>
                <input type="text" id="userSearch" placeholder="Search users..." 
                       class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                       onfocus="loadUsersList()" oninput="filterUsers()">
                <div id="userDropdown" class="user-dropdown hidden"></div>
            </div>
            
            <div id="userAnalyticsContent" class="hidden">
                <!-- User Details -->
                <div class="user-detail-grid mb-6">
                    <div class="user-detail-card">
                        <div class="user-detail-value" id="user-visit-count">0</div>
                        <div class="user-detail-label">Total Visits</div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-value" id="user-total-duration">0s</div>
                        <div class="user-detail-label">Session Duration</div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-value" id="user-favorite-section">--</div>
                        <div class="user-detail-label">Favorite Section</div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-value" id="user-favorite-count">0</div>
                        <div class="user-detail-label">Favorite Visits</div>
                    </div>
                </div>
                
                <!-- User Time Range Selector -->
                <div class="time-range-selector mb-4">
                    <button class="time-range-btn active" data-range="24h" onclick="switchUserTimeRange('24h')">24 Hours</button>
                    <button class="time-range-btn" data-range="7d" onclick="switchUserTimeRange('7d')">7 Days</button>
                    <button class="time-range-btn" data-range="30d" onclick="switchUserTimeRange('30d')">30 Days</button>
                </div>
                
                <!-- User Visits Chart -->
                <div class="chart-container mb-6">
                    <h3 class="text-xl font-bold text-shimmer mb-4" id="user-chart-title">User Visits Pattern</h3>
                    <div class="chart-wrapper chart-wrapper-medium">
                        <canvas id="userVisitsChart"></canvas>
                    </div>
                </div>
                
                <!-- User Activity -->
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-shimmer mb-4">Recent Activity</h3>
                    <div class="activity-feed" style="max-height: 300px;" id="user-activity-feed">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="userAnalyticsPlaceholder" class="text-center py-8">
                <i class="fas fa-user-chart text-4xl text-gray-600 mb-4"></i>
                <p class="text-gray-400">Select a user to view their analytics</p>
            </div>
        </div>
    </div>

    <script>
        const backBtn = document.getElementById('backBtn');
        backBtn.addEventListener('click', () => {
            backBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> exiting...';
            window.location.href = '/admin/users'
            setTimeout(() => {
                backBtn.innerHTML = '<i class="fas fa-arrow-left mr-2"></i> Go Back';
            }, 1200);
        });
    </script>
    <script>
        let visitsChart, sectionsChart, userVisitsChart;
        let refreshInterval;
        let currentRange = '24h';
        let currentUserRange = '24h';
        let selectedUserId = null;
        let allUsers = [];
        
        // Enhanced chart configuration with animations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: '#e5e7eb',
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 11
                        }
                    }
                }
            }
        };
        
        async function loadAnalytics(range = currentRange) {
            try {
                showLoadingStates();
                
                const response = await fetch(`/api/analytics/visits?range=${range}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update current range display
                updateRangeDisplay(range);
                
                // Animate stats counting up
                animateStats(data);
                updateCharts(data, range);
                updateActivityFeed(data);
                updateTopSections(data);
                updateQuickStats(data);
                
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                showErrorStates();
            } finally {
                hideLoadingStates();
            }
        }
        
        function updateRangeDisplay(range) {
            const rangeTexts = {
                '24h': 'Last 24 hours',
                '7d': 'Last 7 days', 
                '30d': 'Last 30 days'
            };
            document.getElementById('current-range-display').textContent = rangeTexts[range] || 'Last 24 hours';
            document.getElementById('visits-chart-title').textContent = `Visits ${range === '24h' ? 'per Hour' : 'per Day'} (${rangeTexts[range]})`;
        }
        
        function animateStats(data) {
            // Animate total visits
            animateValue('total-visits', 0, data.total_visits || 0, 1500);
            // Animate unique visitors
            animateValue('unique-visitors', 0, data.unique_visitors || 0, 1500);
            // Update other stats
            const activeSections = data.section_stats?.length || 0;
            document.getElementById('active-sections').textContent = activeSections;
            
            // Total duration
            const totalDuration = data.platform_stats?.total_duration || 0;
            document.getElementById('total-duration').textContent = formatDuration(totalDuration);
            
            updateTrends(data);
        }
        
        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current.toLocaleString();
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
        
        function showLoadingStates() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'flex';
            });
        }
        
        function hideLoadingStates() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        function showErrorStates() {
            document.getElementById('activity-feed').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
                    <p class="text-gray-400 mb-2">Failed to load analytics data</p>
                    <button onclick="loadAnalytics()" class="text-blue-400 hover:text-blue-300 text-sm">
                        <i class="fas fa-redo mr-1"></i> Retry
                    </button>
                </div>
            `;
        }
        
        function updateTrends(data) {
            const visitsTrend = data.total_visits > 50 ? '↑ High traffic' : data.total_visits > 20 ? '↑ Normal traffic' : '↑ Low traffic';
            const visitorsTrend = data.unique_visitors > 10 ? '↑ Many users' : data.unique_visitors > 5 ? '↑ Steady growth' : '↑ Starting up';
            const sectionsTrend = data.section_stats?.length > 3 ? '↑ Good engagement' : data.section_stats?.length > 1 ? '↑ Balanced usage' : '↑ Focused usage';
            const durationTrend = data.platform_stats?.total_duration > 3600 ? '↑ High engagement' : data.platform_stats?.total_duration > 1800 ? '↑ Good engagement' : '↑ Normal usage';
            
            document.getElementById('visits-trend').textContent = visitsTrend;
            document.getElementById('visitors-trend').textContent = visitorsTrend;
            document.getElementById('sections-trend').textContent = sectionsTrend;
            document.getElementById('duration-trend').textContent = durationTrend;
        }
        
        function updateCharts(data, range) {
            updateVisitsChart(data, range);
            updateSectionsChart(data);
        }
        
        function updateVisitsChart(data, range) {
            const visitsCtx = document.getElementById('visitsChart').getContext('2d');
            if (visitsChart) visitsChart.destroy();
            
            let visitsData = [];
            let labels = [];
            
            if (data.visits_per_time && data.visits_per_time.length > 0) {
                
                if (range === '24h') {
                    // Create a map for 24 hours
                    const visitsMap = new Map();
                    data.visits_per_time.forEach(v => {
                        const hour = typeof v.time_unit === 'string' ? parseInt(v.time_unit) : v.time_unit;
                        visitsMap.set(hour, v.count);
                    });
                    
                    // Fill in all 24 hours
                    for (let hour = 0; hour < 24; hour++) {
                        visitsData.push(visitsMap.get(hour) || 0);
                        labels.push(`${hour.toString().padStart(2, '0')}:00`);
                    }
                } else {
                    // For 7d and 30d, use the dates directly
                    data.visits_per_time.forEach(v => {
                        visitsData.push(v.count);
                        const date = new Date(v.time_unit);
                        labels.push(date.toLocaleDateString());
                    });
                }
            } else {
                // Fallback to zero data
                if (range === '24h') {
                    visitsData = Array(24).fill(0);
                    labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                } else {
                    const days = range === '7d' ? 7 : 30;
                    visitsData = Array(days).fill(0);
                    labels = Array.from({length: days}, (_, i) => {
                        const date = new Date();
                        date.setDate(date.getDate() - (days - i - 1));
                        return date.toLocaleDateString();
                    });
                }
            }
            
            visitsChart = new Chart(visitsCtx, {
                type: range === '24h' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visits',
                        data: visitsData,
                        borderColor: '#3B82F6',
                        backgroundColor: range === '24h' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.6)',
                        borderWidth: range === '24h' ? 3 : 1,
                        fill: range === '24h',
                        tension: 0.4,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: range === '24h' ? 4 : 3,
                        pointHoverRadius: range === '24h' ? 6 : 5
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e7eb',
                            borderColor: '#3B82F6',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `${range === '24h' ? 'Hour' : 'Date'}: ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    return `Visits: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: range === '24h' ? 9 : 8 },
                                maxTicksLimit: range === '24h' ? 12 : 10
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }
        
        function updateSectionsChart(data) {
            const sectionsCtx = document.getElementById('sectionsChart').getContext('2d');
            if (sectionsChart) sectionsChart.destroy();
            
            const sectionsData = data.section_stats || [];
            
            // Format section names and ensure we have data
            const formattedSections = sectionsData.map(s => {
                const sectionName = s.section || 'unknown';
                return sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            });
            
            // If no section data, show a placeholder
            if (sectionsData.length === 0) {
                sectionsData.push({ section: 'No Data', count: 1 });
                formattedSections.push('No Data');
            }
            
            sectionsChart = new Chart(sectionsCtx, {
                type: 'doughnut',
                data: {
                    labels: formattedSections,
                    datasets: [{
                        data: sectionsData.map(s => s.count),
                        backgroundColor: [
                            '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444',
                            '#6366F1', '#EC4899', '#14B8A6', '#F97316', '#6B7280'
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...chartConfig,
                    cutout: '60%',
                    plugins: {
                        ...chartConfig.plugins,
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e7eb',
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });
        }
        
        function updateActivityFeed(data) {
            const feed = document.getElementById('activity-feed');
            const activities = data.recent_activity || [];
            
            document.getElementById('activity-count').textContent = `${activities.length} activities`;
            
            if (activities.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">No recent activity</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = activities.map((activity, index) => `
                <div class="activity-item glass-morph" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center gap-4">
                        <div class="user-avatar cursor-pointer" onclick="loadUserAnalytics(${activity.user_id})" title="View user analytics">
                            ${activity.username ? activity.username.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <div class="font-semibold text-white truncate cursor-pointer hover:text-blue-400" onclick="loadUserAnalytics(${activity.user_id})">
                                    ${activity.username || 'Unknown User'}
                                </div>
                                <div class="activity-time">${formatActivityTime(activity.timestamp)}</div>
                            </div>
                            <div class="text-sm text-gray-300 flex items-center flex-wrap gap-1">
                                <span>${getActionText(activity.action, activity.target, activity.duration)}</span>
                                ${activity.target && activity.target !== 'main_page' && activity.target !== 'null' ? 
                                    `<span class="section-badge">${formatSectionName(activity.target)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTopSections(data) {
            const container = document.getElementById('top-sections');
            const sections = data.section_stats || [];
            
            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar text-2xl text-gray-600 mb-2"></i>
                        <p class="text-gray-400 text-sm">No section data available</p>
                    </div>
                `;
                return;
            }
            
            // Sort by count and take top 5
            const topSections = sections
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            container.innerHTML = topSections.map((section, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg mb-2 last:mb-0 transition-all hover:bg-gray-800/50 hover:scale-105" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm font-bold">
                            ${index + 1}
                        </div>
                        <span class="font-medium text-sm">${formatSectionName(section.section)}</span>
                    </div>
                    <span class="text-blue-400 font-semibold">${section.count}</span>
                </div>
            `).join('');
        }
        
        function updateQuickStats(data) {
            const sections = data.section_stats || [];
            const platformStats = data.platform_stats || {};
            
            // Most popular section
            if (sections.length > 0) {
                const popular = sections.reduce((max, curr) => curr.count > max.count ? curr : max, sections[0]);
                document.getElementById('popular-section').textContent = formatSectionName(popular.section);
            } else {
                document.getElementById('popular-section').textContent = 'None';
            }
            
            // Average duration
            const avgDuration = platformStats.avg_duration || 0;
            document.getElementById('avg-duration').textContent = formatDuration(avgDuration);
        }
        
        function formatSectionName(section) {
            if (!section || section === 'null') return 'Unknown';
            return section.charAt(0).toUpperCase() + section.slice(1);
        }
        
        function getActionText(action, target, duration) {
            const actions = {
                'page_view': `Viewed main page`,
                'section_view': `Navigated to ${formatSectionName(target) || 'unknown section'}`,
                'file_download': `Downloaded file`,
                'page_exit': `Session ended${duration ? ` (${formatDuration(duration)})` : ''}`
            };
            return actions[action] || `${action} ${target || ''}`;
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '0s';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            if (minutes < 60) return `${minutes}m ${remainingSeconds}s`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}h ${remainingMinutes}m`;
        }
        
        function formatActivityTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }
        
        function switchTimeRange(range) {
            currentRange = range;
            
            // Update active button
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === range);
            });
            
            // Refresh data
            refreshAnalytics();
        }
        
        function refreshAnalytics() {
            const btn = document.getElementById('refreshData');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
            btn.disabled = true;
            
            // Add refresh animation to stats
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.add('glow');
                setTimeout(() => card.classList.remove('glow'), 2000);
            });
            
            loadAnalytics(currentRange).finally(() => {
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 1000);
            });
        }
        
        // User Analytics Functions
        function showUserAnalyticsModal() {
            document.getElementById('userAnalyticsModal').classList.remove('hidden');
        }
        
        function hideUserAnalyticsModal() {
            document.getElementById('userAnalyticsModal').classList.add('hidden');
            selectedUserId = null;
            document.getElementById('userAnalyticsContent').classList.add('hidden');
            document.getElementById('userAnalyticsPlaceholder').classList.remove('hidden');
            document.getElementById('userSearch').value = '';
        }
        
        async function loadUsersList() {
            try {
                const response = await fetch('/api/analytics/users/list');
                if (!response.ok) throw new Error('Failed to load users');
                const data = await response.json();
                allUsers = data.users;
                showUserDropdown(allUsers);
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }
        
        function showUserDropdown(users) {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = users.map(user => `
                <div class="user-option" onclick="selectUser(${user.id}, '${user.username}')">
                    <div class="font-medium">${user.username}</div>
                    <div class="text-xs text-gray-400">${user.mobile}</div>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) || 
                user.mobile.toLowerCase().includes(searchTerm)
            );
            showUserDropdown(filteredUsers);
        }
        
        function selectUser(userId, username) {
            selectedUserId = userId;
            document.getElementById('userSearch').value = username;
            document.getElementById('userDropdown').classList.add('hidden');
            document.getElementById('userAnalyticsPlaceholder').classList.add('hidden');
            document.getElementById('userAnalyticsContent').classList.remove('hidden');
            loadUserAnalytics(userId);
        }
        
        async function loadUserAnalytics(userId = selectedUserId, range = currentUserRange) {
            if (!userId) return;
            
            try {
                showUserLoadingStates();
                const response = await fetch(`/api/analytics/user/${userId}?range=${range}`);
                if (!response.ok) throw new Error('Failed to load user analytics');
                const data = await response.json();
                
                updateUserStats(data);
                updateUserChart(data, range);
                updateUserActivityFeed(data);
                
            } catch (error) {
                console.error('Failed to load user analytics:', error);
                document.getElementById('user-activity-feed').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-yellow-400 mb-2"></i>
                        <p class="text-gray-400 text-sm">Failed to load user data</p>
                    </div>
                `;
            } finally {
                hideUserLoadingStates();
            }
        }
        
        function showUserLoadingStates() {
            document.getElementById('user-activity-feed').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
        }
        
        function hideUserLoadingStates() {
            // Loading states are replaced with content
        }
        
        function updateUserStats(data) {
            document.getElementById('user-visit-count').textContent = data.visit_count;
            document.getElementById('user-total-duration').textContent = formatDuration(data.total_duration);
            document.getElementById('user-favorite-section').textContent = formatSectionName(data.favorite_section);
            document.getElementById('user-favorite-count').textContent = data.favorite_section_count || 0;
        }
        
        function updateUserChart(data, range) {
            const userVisitsCtx = document.getElementById('userVisitsChart').getContext('2d');
            if (userVisitsChart) userVisitsChart.destroy();
            
            document.getElementById('user-chart-title').textContent = `User Visits Pattern (${range === '24h' ? 'Last 24 hours' : range === '7d' ? 'Last 7 days' : 'Last 30 days'})`;
            
            let visitsData = [];
            let labels = [];
            
            if (data.visits_pattern && data.visits_pattern.length > 0) {
                if (range === '24h') {
                    // Create a map for 24 hours
                    const visitsMap = new Map();
                    data.visits_pattern.forEach(v => {
                        const hour = typeof v.time_unit === 'string' ? parseInt(v.time_unit) : v.time_unit;
                        visitsMap.set(hour, v.count);
                    });
                    
                    // Fill in all 24 hours
                    for (let hour = 0; hour < 24; hour++) {
                        visitsData.push(visitsMap.get(hour) || 0);
                        labels.push(`${hour.toString().padStart(2, '0')}:00`);
                    }
                } else {
                    // For 7d and 30d, use the dates directly
                    data.visits_pattern.forEach(v => {
                        visitsData.push(v.count);
                        const date = new Date(v.time_unit);
                        labels.push(date.toLocaleDateString());
                    });
                }
            } else {
                // Fallback to zero data
                if (range === '24h') {
                    visitsData = Array(24).fill(0);
                    labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                } else {
                    const days = range === '7d' ? 7 : 30;
                    visitsData = Array(days).fill(0);
                    labels = Array.from({length: days}, (_, i) => {
                        const date = new Date();
                        date.setDate(date.getDate() - (days - i - 1));
                        return date.toLocaleDateString();
                    });
                }
            }
            
            userVisitsChart = new Chart(userVisitsCtx, {
                type: range === '24h' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visits',
                        data: visitsData,
                        borderColor: '#8B5CF6',
                        backgroundColor: range === '24h' ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.6)',
                        borderWidth: range === '24h' ? 3 : 1,
                        fill: range === '24h',
                        tension: 0.4,
                        pointBackgroundColor: '#8B5CF6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: range === '24h' ? 4 : 3,
                        pointHoverRadius: range === '24h' ? 6 : 5
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e7eb',
                            borderColor: '#8B5CF6',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `${range === '24h' ? 'Hour' : 'Date'}: ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    return `Visits: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [3, 3]
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: range === '24h' ? 9 : 8 },
                                maxTicksLimit: range === '24h' ? 12 : 10
                            }
                        }
                    }
                }
            });
        }
        
        function updateUserActivityFeed(data) {
            const feed = document.getElementById('user-activity-feed');
            const activities = data.activities || [];
            
            if (activities.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox text-2xl text-gray-600 mb-2"></i>
                        <p class="text-gray-400 text-sm">No recent activity</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = activities.map((activity, index) => `
                <div class="activity-item" style="animation-delay: ${index * 0.1}s">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-semibold text-white">${getActionText(activity.action, activity.target, activity.duration)}</div>
                        <div class="activity-time">${formatActivityTime(activity.timestamp)}</div>
                    </div>
                    ${activity.target && activity.target !== 'main_page' && activity.target !== 'null' ? 
                        `<div class="text-xs"><span class="section-badge">${formatSectionName(activity.target)}</span></div>` : ''}
                </div>
            `).join('');
        }
        
        function switchUserTimeRange(range) {
            currentUserRange = range;
            
            // Update active button
            document.querySelectorAll('#userAnalyticsContent .time-range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === range);
            });
            
            // Refresh user data
            if (selectedUserId) {
                loadUserAnalytics(selectedUserId, range);
            }
        }
        
        // Initialize analytics
        document.addEventListener('DOMContentLoaded', function() {
            // Staggered loading animation
            setTimeout(() => {
                loadAnalytics();
            }, 500);

            // Auto-refresh every 1 minute
            refreshInterval = setInterval(() => loadAnalytics(currentRange), 60000);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-select-container')) {
                    document.getElementById('userDropdown').classList.add('hidden');
                }
            });
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (visitsChart) visitsChart.resize();
            if (sectionsChart) sectionsChart.resize();
            if (userVisitsChart) userVisitsChart.resize();
        });
    </script>
</body>
</html>