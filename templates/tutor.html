<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>User Management | LyxNexus Admin</title>
    
    <!-- Preload critical assets -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    
    <!-- Optimized CSS loading -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #111827;
            --text-color: #F9FAFB;
            --accent-color: #4A90E2;
            --secondary-color: #8B5CF6;
            --primary: #6366f1;
            --primary-400: #60a5fa;
            --primary-600: #2563eb;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --secondary-600: #9333ea;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(59, 130, 246, 0.15);
            --glass-border-hover: rgba(59, 130, 246, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        .glass-morph {
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            transition: all 0.2s ease;
        }

        .glass-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            padding: 12px 24px;
        }

        .header-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            border-radius: 16px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-container svg {
            width: 28px;
            height: 28px;
            stroke: white;
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .menu-toggle {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .menu-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
        }

        .menu-toggle i {
            transition: transform 0.3s ease;
        }

        .menu-toggle:hover i {
            transform: rotate(90deg);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .last-updated {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.85rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh {
            background: rgba(59, 130, 246, 0.15);
            color: #3B82F6;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.85rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1b204a 0%, #0d0d0d 100%);
            border-right: 1px solid rgba(59, 130, 246, 0.2);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 10px 0 30px -10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .nav-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 0 12px;
        }

        .nav-buttons-container .btn {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid transparent;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
            color: var(--gray-400);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .nav-buttons-container .btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: white;
            transform: translateX(4px);
        }

        .nav-buttons-container .btn i {
            width: 20px;
            font-size: 1.1rem;
        }

        .nav-buttons-container .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .nav-buttons-container .btn-phone { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .nav-buttons-container .btn-events { 
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        .nav-buttons-container .btn-dashboard { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .nav-buttons-container .btn-shares { 
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
        }
        .nav-buttons-container .btn-notify { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .nav-buttons-container .btn-ai { 
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        .nav-buttons-container .btn-info { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        .nav-buttons-container .btn-money { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }

        .sidebar-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            margin: 16px 0;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-info i {
            font-size: 2rem;
            color: #667eea;
        }

        .user-info span {
            font-size: 0.9rem;
            color: var(--gray-400);
        }

        .footer-buttons {
            display: flex;
            gap: 8px;
        }

        .footer-btn {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(255, 255, 255, 0.03);
            color: var(--gray-400);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .footer-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            color: white;
        }

        .footer-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--gray-500);
            font-size: 1rem;
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .quick-stat {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .quick-stat:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .stats-icon {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #3B82F6;
        }

        .quick-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .quick-stat-label {
            color: var(--gray-500);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .highlight-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 20px;
            height: 350px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-300);
        }

        .chart-wrapper {
            height: calc(100% - 40px);
            width: 100%;
        }

        .online-users-panel {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-subtitle {
            color: var(--gray-500);
            font-size: 0.85rem;
        }

        .online-user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 16px;
            margin-bottom: 8px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            margin-right: 12px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .filters-panel {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 40px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .search-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filter-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 30px;
            padding: 10px 18px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1 1 auto;
            min-width: 140px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .filter-select:hover {
            border-color: #3B82F6;
        }

        .glass-morph {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .action-buttons-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(90deg, #10B981, #059669);
        }

        .btn-warning {
            background: linear-gradient(90deg, #F59E0B, #D97706);
        }

        .btn-danger {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }

        .btn-secondary {
            background: linear-gradient(90deg, #6B7280, #4B5563);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            min-height: 32px;
        }

        .overflow-x-auto {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 16px;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
        }

        .user-table th {
            text-align: left;
            padding: 16px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #3B82F6;
            background: rgba(30, 30, 40, 0.8);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .user-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            color: var(--gray-300);
        }

        .user-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-admin {
            background: linear-gradient(90deg, #8B5CF6, #7C3AED);
            color: white;
        }

        .status-allowed {
            background-color: #16a34a;
            color: white;
        }

        .status-banned {
            background-color: #dc2626;
            color: white;
        }

        .status-user {
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            border: 1px solid #3B82F6;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
            border: 1px solid #10B981;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-width: 240px;
        }

        .activity-bar {
            width: 100px;
            height: 6px;
            background: rgba(75, 85, 99, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .activity-progress {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 20px;
        }

        .pagination-info {
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-color);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 450px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: white;
        }

        .modal-content p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            position: relative;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-close {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(31, 41, 55, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            opacity: 0.8;
            transition: all 0.2s ease;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .toast-close:hover {
            opacity: 1;
            background: rgba(55, 65, 81, 0.9);
            transform: scale(1.1);
        }

        .toast-success {
            background: linear-gradient(90deg, #10B981, #059669);
        }

        .toast-error {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }

        .toast-info {
            background: linear-gradient(90deg, #3B82F6, #1D4ED8);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3B82F6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .btn-loading .btn-spinner {
            display: inline-block;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }

            .logo-text {
                display: none;
            }

            .auto-refresh span {
                display: none;
            }

            .main-content {
                padding: 16px;
            }

            .page-header h1 {
                font-size: 1.8rem;
            }

            .quick-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .search-filters {
                flex-direction: column;
            }

            .filter-select {
                width: 100%;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .action-buttons-group {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .pagination {
                flex-direction: column;
                align-items: flex-start;
            }

            .pagination-controls {
                width: 100%;
            }

            .modal-content {
                padding: 24px;
                margin: 16px;
            }
        }

        @media (max-width: 480px) {
            .quick-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .nav-section {
            padding: 8px 16px;
        }

        .nav-section-title {
            color: var(--gray-500);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin: 2px 8px;
            border-radius: 14px;
            color: var(--gray-400);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            border-color: var(--glass-border-hover);
            transform: translateX(4px);
        }

        .nav-item i {
            width: 20px;
            font-size: 1.1rem;
            color: var(--primary-400);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(168, 85, 247, 0.15));
            border-color: var(--glass-border-hover);
            color: white;
        }

        .page-btn {
            padding: 10px 18px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            color: var(--gray-300);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--glass-border-hover);
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-details h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-container">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                        <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                        <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    <span class="logo-text">Students Management</span>
                </div>
            </div>
            <div class="header-right">
                <div class="last-updated">
                    <i class="fas fa-sync-alt"></i>
                    <span id="last-updated-text">Last updated: Just now</span>
                </div>
                <div class="auto-refresh">
                    <i class="fas fa-clock"></i>
                    <span>Auto-refresh 120s</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar - Scrollable -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigation</h3>
            <p>v2.0 â€¢ Admin</p>
        </div>

        <div class="sidebar-content">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item active" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="window.location.reload()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/analytics'">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <div class="nav-item" onclick="window.location.href='/konami/'">
                    <i class="fas fa-gamepad"></i>
                    <span>Konami</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/4123/payment-monitor'">
                    <i class="fas fa-coins"></i>
                    <span>Payments</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/events/admin/events'">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/shares'">
                    <i class="fas fa-share-alt"></i>
                    <span>Shares</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/notifications'">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Tools</div>
                <div class="nav-item" onclick="window.location.href='/ai-chat'">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/phone'">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Phones</span>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    A
                </div>
                <div class="user-details">
                    <h4>Admin User</h4>
                    <p>administrator</p>
                </div>
            </div>
            <div class="footer-buttons">
                <button class="footer-btn" onclick="window.location.href='/admin'">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back</span>
                </button>
                <button class="footer-btn danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>User Management</h1>
            <p>Manage system users and administrator privileges</p>
        </div>

        <!-- Quick Stats Grid - Using original IDs -->
        <div class="quick-stats-grid">
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-users"></i></div>
                <div class="quick-stat-value" id="total-users">0</div>
                <div class="quick-stat-label">Total Users</div>
            </div>
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-user-shield"></i></div>
                <div class="quick-stat-value" id="admin-users">0</div>
                <div class="quick-stat-label">Administrators</div>
            </div>
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-user"></i></div>
                <div class="quick-stat-value" id="regular-users">0</div>
                <div class="quick-stat-label">Regular Users</div>
            </div>
            <div class="quick-stat highlight-card">
                <div class="stats-icon"><i class="fas fa-user-plus"></i></div>
                <div class="quick-stat-value" id="today-users">0</div>
                <div class="quick-stat-label">Today's Registrations</div>
            </div>
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-chart-line"></i></div>
                <div class="quick-stat-value" id="active-today">0</div>
                <div class="quick-stat-label">Active Today</div>
            </div>
            <div class="quick-stat highlight-card">
                <div class="stats-icon"><i class="fas fa-circle"></i></div>
                <div class="quick-stat-value" id="online-users">0</div>
                <div class="quick-stat-label">Online Now</div>
            </div>
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-bolt"></i></div>
                <div class="quick-stat-value" id="avg-activity">0</div>
                <div class="quick-stat-label">Avg. Activity</div>
            </div>
            <div class="quick-stat">
                <div class="stats-icon"><i class="fas fa-fire"></i></div>
                <div class="quick-stat-value" id="total-activity">0</div>
                <div class="quick-stat-label">Total Activities</div>
            </div>
            <div class="quick-stat highlight-card">
                <div class="stats-icon"><i class="fas fa-bell"></i></div>
                <div class="quick-stat-value" id="all-subs-users">0</div>
                <div class="quick-stat-label">Enabled WebPush</div>
            </div>
        </div>

        <!-- Online Users Panel -->
        <div class="online-users-panel">
            <div class="card-header">
                <h3 class="section-title">
                    <i class="fas fa-circle" style="color:#10B981"></i> Online Users
                    <span style="color: var(--gray-400); font-size:0.9rem; margin-left:8px;" id="online-count">(0)</span>
                </h3>
                <p class="section-subtitle">Users currently active in the system</p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <button class="btn btn-sm" onclick="refreshOnlineUsers()">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
            <div id="online-users-list" style="max-height: 200px; overflow-y: auto;">
                <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 12px;">Loading online users...</p>
                </div>
            </div>
        </div>

        <!-- Data Analysis Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="chart-title">User Registration Trend</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="registration-chart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="chart-title">User Activity Distribution</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="chart-title">Admin vs Regular Users</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="role-chart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="chart-title">User Activity Timeline</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="timeline-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Search & Filters -->
        <div class="filters-panel">
            <div class="card-header">
                <h3 class="section-title">
                    <i class="fas fa-search mr-2"></i> User Search & Filters
                </h3>
                <p class="section-subtitle">Find users by name, ID, role, or activity level</p>
            </div>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search users by username, mobile, ID, or role...">
            </div>
            
            <div class="search-filters">
                <select id="role-filter" class="filter-select">
                    <option value="">All Roles</option>
                    <option value="admin">Administrators</option>
                    <option value="user">Regular Users</option>
                </select>
                
                <select id="activity-filter" class="filter-select">
                    <option value="">All Activity Levels</option>
                    <option value="high">High Activity</option>
                    <option value="medium">Medium Activity</option>
                    <option value="low">Low Activity</option>
                </select>
                
                <select id="status-filter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                </select>

                <select id="payment-status-filter" class="filter-select">
                    <option value="">All Payment Status</option>
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                </select>
                
                <select id="date-filter" class="filter-select">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
                
                <button class="btn btn-secondary" id="clear-filters">
                    <i class="fas fa-times mr-2"></i> Clear Filters
                </button>
            </div>
        </div>

        <!-- User Table -->
        <div class="glass-morph">
            <div class="table-header">
                <h2 class="section-title">All Users <span style="color: var(--gray-400); margin-left:8px;" id="user-count">(0)</span></h2>
                <div class="action-buttons-group">
                    <button class="btn" id="refresh-btn">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                    <button class="btn btn-success" id="export-btn">
                        <i class="fas fa-download mr-1"></i>Export Data
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Year</th>
                            <th>Username</th>
                            <th>Mobile</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Seen</th>
                            <th>Created</th>
                            <th>Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 40px;">
                                <div class="spinner" style="margin: 0 auto;"></div>
                                <p style="color: var(--gray-500); margin-top: 16px;">Loading users...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">
                    Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="showing-total">0</span> users
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" id="prev-page" disabled>
                        <i class="fas fa-chevron-left mr-2"></i> Previous
                    </button>
                    <button class="page-btn" id="next-page" disabled>
                        Next <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">Confirm Action</h3>
            <p id="confirm-message">Are you sure you want to perform this action?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="btn btn-danger" id="confirm-action-btn">
                    <span class="btn-spinner"></span>
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const USERS_ENDPOINT = `${API_BASE}/users`;
        const ONLINE_USERS_ENDPOINT = `${API_BASE}/online-users`;
        let currentUserId = null;
        let pollInterval;
        let rapidPolling;
        let isRefreshing = false;
        let allUsers = [];
        let filteredUsers = [];
        let onlineUsers = [];        
        let currentPage = 1;
        const usersPerPage = 10;
        let charts = {};

        // DOM Elements
        const elements = {
            menuToggle: document.getElementById('menuToggle'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebarOverlay'),
            lastUpdated: document.getElementById('last-updated-text'),
            onlineUsersList: document.getElementById('online-users-list'),
            onlineCount: document.getElementById('online-count'),
            usersTableBody: document.getElementById('users-table-body'),
            searchInput: document.getElementById('search-input'),
            roleFilter: document.getElementById('role-filter'),
            statusFilter: document.getElementById('status-filter'),
            paymentFilter: document.getElementById('payment-status-filter'),
            activityFilter: document.getElementById('activity-filter'),
            dateFilter: document.getElementById('date-filter'),
            clearFilters: document.getElementById('clear-filters'),
            refreshBtn: document.getElementById('refresh-btn'),
            exportBtn: document.getElementById('export-btn'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            showingStart: document.getElementById('showing-start'),
            showingEnd: document.getElementById('showing-end'),
            showingTotal: document.getElementById('showing-total'),
            userCount: document.getElementById('user-count'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmActionBtn: document.getElementById('confirm-action-btn'),
            toastContainer: document.getElementById('toast-container')
        };

        function initializeCharts() {
            const registrationCtx = document.getElementById('registration-chart').getContext('2d');
            const activityCtx = document.getElementById('activity-chart').getContext('2d');
            const roleCtx = document.getElementById('role-chart').getContext('2d');
            const timelineCtx = document.getElementById('timeline-chart').getContext('2d');
            
            charts.registration = new Chart(registrationCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'User Registrations',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
            
            charts.activity = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High Activity', 'Medium Activity', 'Low Activity'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(107, 114, 128, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#F9FAFB', font: { size: 11 } }
                        }
                    }
                }
            });
            
            charts.role = new Chart(roleCtx, {
                type: 'pie',
                data: {
                    labels: ['Administrators', 'Regular Users'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgba(139, 92, 246, 1)',
                            'rgba(59, 130, 246, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#F9FAFB', font: { size: 11 } }
                        }
                    }
                }
            });
            
            charts.timeline = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'User Activity',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateCharts(users, chartData = null) {
            if (chartData) {
                if (chartData.registration_trend) {
                    charts.registration.data.labels = chartData.registration_trend.labels || [];
                    charts.registration.data.datasets[0].data = chartData.registration_trend.data || [];
                    charts.registration.update();
                }
                
                if (chartData.activity_distribution) {
                    charts.activity.data.datasets[0].data = [
                        chartData.activity_distribution.high || 0,
                        chartData.activity_distribution.medium || 0,
                        chartData.activity_distribution.low || 0
                    ];
                    charts.activity.update();
                }
                
                if (chartData.role_distribution) {
                    charts.role.data.datasets[0].data = [
                        chartData.role_distribution.admins || 0,
                        chartData.role_distribution.users || 0
                    ];
                    charts.role.update();
                }
                
                if (chartData.activity_timeline) {
                    charts.timeline.data.labels = chartData.activity_timeline.labels || [];
                    charts.timeline.data.datasets[0].data = chartData.activity_timeline.data || [];
                    charts.timeline.update();
                }
            } else {
                // Fallback calculations
                const last30Days = [...Array(30)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                const registrationData = last30Days.map(day => {
                    return users.filter(user => {
                        const userDate = user.created_at?.split('T')[0];
                        return userDate === day;
                    }).length;
                });
                
                charts.registration.data.labels = last30Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                charts.registration.data.datasets[0].data = registrationData;
                charts.registration.update();
                
                const highActivity = users.filter(user => (user.announcements_count + user.assignments_count) > 10).length;
                const mediumActivity = users.filter(user => {
                    const activity = user.announcements_count + user.assignments_count;
                    return activity > 3 && activity <= 10;
                }).length;
                const lowActivity = users.filter(user => (user.announcements_count + user.assignments_count) <= 3).length;
                
                charts.activity.data.datasets[0].data = [highActivity, mediumActivity, lowActivity];
                charts.activity.update();
                
                const adminCount = users.filter(user => user.is_admin).length;
                const userCount = users.length - adminCount;
                
                charts.role.data.datasets[0].data = [adminCount, userCount];
                charts.role.update();
                
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                const activityData = last7Days.map(day => {
                    return users.filter(user => {
                        const userDate = new Date(user.created_at).toISOString().split('T')[0];
                        return userDate === day;
                    }).length;
                });
                
                charts.timeline.data.labels = last7Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                charts.timeline.data.datasets[0].data = activityData;
                charts.timeline.update();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function formatRelativeTime(dateString) {
            if (!dateString) return 'N/A';
            const dateUTC = new Date(dateString);
            const date = new Date(dateUTC.getTime() + 3 * 60 * 60 * 1000);
            const nowUTC = new Date();
            const now = new Date(nowUTC.getTime() + 3 * 60 * 60 * 1000);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
        
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(date.toISOString());
        }

        function updateLastUpdated() {
            const nowUTC = new Date();
            elements.lastUpdated.textContent = `Last update: ${nowUTC.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })}`;
        }

        // Toggle Sidebar
        function toggleSidebar() {
            elements.sidebar.classList.toggle('open');
            elements.overlay.classList.toggle('active');
            document.body.style.overflow = elements.sidebar.classList.contains('open') ? 'hidden' : '';
        }

        elements.menuToggle.addEventListener('click', toggleSidebar);
        elements.overlay.addEventListener('click', toggleSidebar);

        // Close on escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (elements.sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
                closeModal('confirm-modal');
            }
        });

        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                if (elements.sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });

        function showToast(message, type = 'info', duration = 5000) {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                    <button class="toast-close" onclick="removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            
            const autoRemove = setTimeout(() => removeToast(toastId), duration);
            toast.dataset.timeoutId = autoRemove;
        }

        window.removeToast = function(toastId) {
            const toast = document.getElementById(toastId);
            if (!toast) return;
            if (toast.dataset.timeoutId) clearTimeout(parseInt(toast.dataset.timeoutId));
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 300);
        };

        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // Fetch online users
        async function fetchOnlineUsers() {
            try {
                const response = await fetch(ONLINE_USERS_ENDPOINT);
                if (!response.ok) return [];
                return await response.json();
            } catch (error) {
                return [];
            }
        }

        // Display online users
        function displayOnlineUsers(users) {
            onlineUsers = users;
            document.getElementById('online-users').textContent = users.length;
            elements.onlineCount.textContent = `(${users.length})`;
            
            if (users.length === 0) {
                elements.onlineUsersList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                        <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 8px;"></i>
                        <p>No users online</p>
                    </div>
                `;
                return;
            }
            
            elements.onlineUsersList.innerHTML = users.map(user => `
                <div class="online-user-item">
                    <div class="online-indicator"></div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${user.username || 'Unknown User'}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">
                            ${user.is_admin ? 'Admin' : 'User'} â€¢ ${user.current_room || 'general'}
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                        ${formatRelativeTime(user.last_seen)}
                    </div>
                </div>
            `).join('');
        }

        // Refresh online users
        window.refreshOnlineUsers = async function() {
            const users = await fetchOnlineUsers();
            displayOnlineUsers(users);
            showToast('Online users updated', 'success');
        };

        async function rapidRefreshOnlineUsers() {
            const users = await fetchOnlineUsers();
            displayOnlineUsers(users);
        }

        function filterUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const activityFilter = document.getElementById('activity-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const paymentStatusFilter = document.getElementById('payment-status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;

            filteredUsers = allUsers.filter(user => {
                // Text search
                const matchesSearch = !searchTerm || 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                    (user.mobile && user.mobile.includes(searchTerm)) ||
                    (user.id && user.id.toString().includes(searchTerm));

                // Role filter
                const matchesRole = !roleFilter || 
                    (roleFilter === 'admin' && user.is_admin) ||
                    (roleFilter === 'user' && !user.is_admin);

                // Payment Status filter
                const matchesPayment = !paymentStatusFilter || 
                    (paymentStatusFilter === 'paid' && user.paid) ||
                    (paymentStatusFilter === 'unpaid' && !user.paid);

                // Activity filter
                let matchesActivity = true;
                if (activityFilter) {
                    const totalActivity = user.announcements_count + user.assignments_count;
                    if (activityFilter === 'high') {
                        matchesActivity = totalActivity > 10;
                    } else if (activityFilter === 'medium') {
                        matchesActivity = totalActivity > 3 && totalActivity <= 10;
                    } else if (activityFilter === 'low') {
                        matchesActivity = totalActivity <= 3;
                    }
                }

                // Status filter (online/offline)
                let matchesStatus = true;
                if (statusFilter) {
                    const isOnline = onlineUsers.some(onlineUser => onlineUser.user_id === user.id);
                    if (statusFilter === 'online') {
                        matchesStatus = isOnline;
                    } else if (statusFilter === 'offline') {
                        matchesStatus = !isOnline;
                    }
                }

                // Date filter
                let matchesDate = true;
                if (dateFilter) {
                    const userDate = new Date(user.created_at);
                    const now = new Date();

                    if (dateFilter === 'today') {
                        matchesDate = userDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = userDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        matchesDate = userDate >= monthAgo;
                    }
                }

                return matchesSearch && matchesRole && matchesActivity && matchesStatus && matchesDate;
            });

            currentPage = 1;
            updateUserTable();
            updatePagination();
        }        

        function updatePagination(paginationData = null) {
            let totalUsers, totalPages;

            if (paginationData) {
                totalUsers = paginationData.total_filtered || paginationData.total || filteredUsers.length;
                totalPages = paginationData.pages || Math.ceil(totalUsers / usersPerPage);
            } else {
                totalUsers = filteredUsers.length;
                totalPages = Math.ceil(totalUsers / usersPerPage);
            }

            const startIndex = (currentPage - 1) * usersPerPage + 1;
            const endIndex = Math.min(currentPage * usersPerPage, totalUsers);

            elements.showingStart.textContent = totalUsers > 0 ? startIndex : 0;
            elements.showingEnd.textContent = endIndex;
            elements.showingTotal.textContent = totalUsers;
            elements.userCount.textContent = `(${totalUsers})`;

            elements.prevPage.disabled = currentPage === 1;
            elements.nextPage.disabled = currentPage === totalPages || totalPages === 0;
        }

        function updateStatistics(users, stats = null) {
            if (stats) {
                document.getElementById('total-users').textContent = stats.total_users || 0;
                document.getElementById('admin-users').textContent = stats.admin_users || 0;
                document.getElementById('regular-users').textContent = stats.regular_users || 0;
                document.getElementById('today-users').textContent = stats.today_users || 0;
                document.getElementById('active-today').textContent = stats.active_today || 0;
                document.getElementById('online-users').textContent = stats.online_users || 0;
                document.getElementById('avg-activity').textContent = stats.avg_activity || 0;
                document.getElementById('total-activity').textContent = stats.total_activity || 0;
                document.getElementById('all-subs-users').textContent = stats.total_webpush_users || 0;
            } else {
                const totalUsers = users.length;
                const adminUsers = users.filter(user => user.is_admin).length;
                const regularUsers = totalUsers - adminUsers;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayUsers = users.filter(user => {
                    const userDate = new Date(user.created_at);
                    return userDate >= today;
                }).length;
                
                const activeToday = users.filter(() => Math.random() > 0.7).length;
                
                const totalActivity = users.reduce((sum, user) => {
                    return sum + (user.announcements_count || 0) + (user.assignments_count || 0);
                }, 0);
                const avgActivity = totalUsers > 0 ? (totalActivity / totalUsers).toFixed(1) : 0;

                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('admin-users').textContent = adminUsers;
                document.getElementById('regular-users').textContent = regularUsers;
                document.getElementById('today-users').textContent = todayUsers;
                document.getElementById('active-today').textContent = activeToday;
                document.getElementById('online-users').textContent = onlineUsers.length;
                document.getElementById('avg-activity').textContent = avgActivity;
                document.getElementById('total-activity').textContent = totalActivity;
                document.getElementById('all-subs-users').textContent = users.filter(u => u.webpush_enabled).length || 0;
            }
        }

        function displayUsers(users) {
            const paginatedUsers = users.slice((currentPage - 1) * usersPerPage, currentPage * usersPerPage);
            
            if (paginatedUsers.length === 0) {
                elements.usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--gray-500);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <p>No users found.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            elements.usersTableBody.innerHTML = paginatedUsers.map(user => {
                const isOnline = onlineUsers.some(onlineUser => onlineUser.user_id === user.id);
                const totalActivity = (user.announcements_count || 0) + (user.assignments_count || 0);
                const activityPercentage = Math.min(totalActivity * 5, 100);
                const status = (user.status === true || user.status === 'true' || user.status === 1);
                const paid = (user.paid === true || user.paid === 'true' || user.paid === 1);
                
                return `
                <tr>
                    <td style="font-family: monospace;">#${user.id}</td>
                    <td style="text-align: center;">${user.year || 'N/A'}</td>
                    <td>
                        <div style="font-weight: 500;">${user.username || 'N/A'}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">ID: ${user.id}</div>
                    </td>
                    <td>${user.mobile || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${user.is_admin ? 'status-admin' : 'status-user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${status ? 'status-allowed' : 'status-banned'}">
                            ${status ? 'Allowed' : 'Banned'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${paid ? 'status-allowed' : 'status-banned'}">
                            ${paid ? 'Paid' : 'Unpaid'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-user'}">
                            ${isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>
                        <div style="font-size: 0.9rem;">${formatDate(user.created_at)}</div>
                        <div style="font-size: 0.7rem; color: var(--gray-500);">${formatRelativeTime(user.created_at)}</div>
                    </td>
                    <td>
                        <div style="font-size: 0.9rem; margin-bottom: 4px;">
                            <i class="fas fa-bullhorn" style="color: #3B82F6;"></i> ${user.announcements_count || 0}
                            <i class="fas fa-tasks" style="color: #10B981; margin-left: 8px;"></i> ${user.assignments_count || 0}
                        </div>
                        <div class="activity-bar">
                            <div class="activity-progress" style="width: ${activityPercentage}%"></div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${user.is_admin ? 
                                `<button class="btn btn-warning btn-sm toggle-admin-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-minus mr-1"></i> Remove Admin
                                </button>` :
                                `<button class="btn btn-warning btn-sm toggle-admin-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-shield mr-1"></i> Make Admin
                                </button>`
                            }
                            ${!user.is_admin ? 
                                `<button class="btn btn-danger btn-sm delete-user-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>` :
                                `<button class="btn btn-secondary btn-sm" disabled>
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>`
                            }
                            ${status ? 
                                `<button class="btn btn-danger btn-sm toggle-status-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-slash mr-1"></i> Ban
                                </button>` :
                                `<button class="btn btn-success btn-sm toggle-status-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-check mr-1"></i> Unban
                                </button>`
                            }
                            ${paid ? 
                                `<button class="btn btn-danger btn-sm toggle-pay-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-slash mr-1"></i> Unpay
                                </button>` :
                                `<button class="btn btn-success btn-sm toggle-pay-btn" data-user-id="${user.id}">
                                    <span class="btn-spinner"></span>
                                    <i class="fas fa-user-check mr-1"></i> Pay
                                </button>`
                            }
                            ${user.year === 5 ? 
                                `<div style="position: relative; display: inline-block;">
                                    <button disabled class="btn btn-secondary btn-sm" style="cursor: not-allowed;">
                                        <i class="fas fa-lock mr-1.5"></i> Modify
                                    </button>
                                </div>` :
                                `<button onclick="window.location.href='/admin/${user.id}/modify'" 
                                   class="btn btn-info btn-sm">
                                    <i class="fas fa-edit mr-1.5"></i> Modify
                                </button>`
                            }                            
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            // Attach event listeners
            document.querySelectorAll('.toggle-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    toggleAdmin(userId, this);
                });
            });
            
            document.querySelectorAll('.toggle-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    toggleStatus(userId, this);
                });
            });

            document.querySelectorAll('.toggle-pay-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    togglePay(userId, this);
                });
            });

            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    confirmDelete(userId, this);
                });
            });
        }

        async function fetchUsers(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: usersPerPage
                });

                if (elements.searchInput.value) params.append('search', elements.searchInput.value);
                if (elements.roleFilter.value) params.append('role', elements.roleFilter.value);
                if (elements.paymentFilter.value) params.append('payment_filter', elements.paymentFilter.value);
                if (elements.activityFilter.value) params.append('activity_level', elements.activityFilter.value);
                if (elements.statusFilter.value) params.append('status', elements.statusFilter.value);
                if (elements.dateFilter.value) params.append('date_filter', elements.dateFilter.value);

                const response = await fetch(`${USERS_ENDPOINT}?${params}`);
                if (!response.ok) throw new Error('Failed to fetch');
                return await response.json();
            } catch (error) {
                showToast('Failed to load users: ' + error.message, 'error');
                return { users: [], pagination: null, stats: null, chart_data: null };
            }
        }

        async function loadUsers(page = 1) {
            if (isRefreshing) return;

            try {
                isRefreshing = true;
                setButtonLoading(elements.refreshBtn, true);

                const data = await fetchUsers(page);
                allUsers = data.users || [];
                filteredUsers = [...allUsers];
                currentPage = page;

                updateLastUpdated();
                updateUserTable();
                updateStatistics(allUsers, data.stats);
                updateCharts(allUsers, data.chart_data);
                displayUsers(filteredUsers);
                updatePagination(data.pagination);

                setButtonLoading(elements.refreshBtn, false);
                isRefreshing = false;

                if (allUsers.length === 0) {
                    showToast('No users found matching your criteria', 'info');
                } else {
                    showToast(`Loaded ${allUsers.length} users successfully`, 'success');
                }
            } catch (error) {
                elements.usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Error loading users. Please try again.
                        </td>
                    </tr>
                `;
                setButtonLoading(elements.refreshBtn, false);
                isRefreshing = false;
                showToast('Failed to load users', 'error');
            }
        }

        async function toggleAdmin(userId, button) {
            if (!userId) return;
            try {
                setButtonLoading(button, true);
                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-admin`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
                });
                if (!response.ok) throw new Error('Failed');
                showToast('Admin status updated', 'success');
                await loadUsers(currentPage);
            } catch (error) {
                showToast('Error updating admin status', 'error');
                setButtonLoading(button, false);
            }
        }

        async function toggleStatus(userId, button) {
            if (!userId) return;
            try {
                setButtonLoading(button, true);
                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
                });
                if (!response.ok) throw new Error('Failed');
                showToast('Status updated', 'success');
                await loadUsers(currentPage);
            } catch (error) {
                showToast('Error updating status', 'error');
                setButtonLoading(button, false);
            }
        }

        async function togglePay(userId, button) {
            if (!userId) return;
            try {
                setButtonLoading(button, true);
                const response = await fetch(`${USERS_ENDPOINT}/${userId}/toggle-pay`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
                });
                if (!response.ok) throw new Error('Failed');
                showToast('Payment status updated', 'success');
                await loadUsers(currentPage);
            } catch (error) {
                showToast('Error updating payment status', 'error');
                setButtonLoading(button, false);
            }
        }

        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }

        function confirmDelete(userId, button) {
            currentUserId = userId;
            elements.confirmTitle.textContent = 'Confirm User Deletion';
            elements.confirmMessage.textContent = 'Are you sure you want to delete this user? This action cannot be undone.';
            elements.confirmActionBtn.onclick = () => deleteUser();
            openModal('confirm-modal');
        }

        async function deleteUser() {
            if (!currentUserId) return;
            try {
                setButtonLoading(elements.confirmActionBtn, true);
                const response = await fetch(`${USERS_ENDPOINT}/${currentUserId}/delete`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                if (!response.ok) throw new Error('Failed');
                closeModal('confirm-modal');
                showToast('User deleted successfully', 'success');
                await loadUsers(currentPage);
                currentUserId = null;
            } catch (error) {
                showToast('Error deleting user', 'error');
                setButtonLoading(elements.confirmActionBtn, false);
                closeModal('confirm-modal');
            }
        }

        window.refreshUsers = function() {
            loadUsers(currentPage);
        };

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
            setButtonLoading(elements.confirmActionBtn, false);
        };

        function exportUserData() {
            showToast('Preparing user data for export...', 'info', 3000);
            setTimeout(() => window.location.href = '/admin/export/users', 2000);
        }

        window.logout = function() {
            showToast("Logging out...", 'info', 2000);
            setTimeout(() => window.location.href = '/logout', 1500);
        };

        function stopAllPolling() {
            if (pollInterval) clearInterval(pollInterval);
            if (rapidPolling) clearInterval(rapidPolling);
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAllPolling();
            } else {
                refreshOnlineUsers();
            }
        });

        // Event Listeners
        elements.searchInput.addEventListener('input', filterUsers);
        elements.roleFilter.addEventListener('change', filterUsers);
        elements.paymentFilter.addEventListener('change', filterUsers);
        elements.activityFilter.addEventListener('change', filterUsers);
        elements.statusFilter.addEventListener('change', filterUsers);
        elements.dateFilter.addEventListener('change', filterUsers);
        
        elements.clearFilters.addEventListener('click', function() {
            elements.searchInput.value = '';
            elements.roleFilter.value = '';
            elements.paymentFilter.value = '';
            elements.activityFilter.value = '';
            elements.statusFilter.value = '';
            elements.dateFilter.value = '';
            filterUsers();
        });
        
        elements.prevPage.addEventListener('click', function() {
            if (currentPage > 1) {
                loadUsers(currentPage - 1);
            }
        });

        elements.nextPage.addEventListener('click', function() {
            loadUsers(currentPage + 1);
        });
        
        elements.refreshBtn.addEventListener('click', () => loadUsers(currentPage));
        elements.exportBtn.addEventListener('click', exportUserData);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadUsers();
            refreshOnlineUsers();
            
            pollInterval = setInterval(() => {
                loadUsers(currentPage);
                refreshOnlineUsers();
            }, 120000);
            
            rapidPolling = setInterval(rapidRefreshOnlineUsers, 10000);

            window.addEventListener('beforeunload', stopAllPolling);
        });
    </script>
</body>
</html>