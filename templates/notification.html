<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyx Nexus - Notification Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #EE5A24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-info {
            background: linear-gradient(45deg, #2980b9, #3498db);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        .token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .users-panel {
            grid-column: 1 / -1;
        }

        .users-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            font-family: monospace;
            font-size: 12px;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        .notification-form {
            display: grid;
            gap: 15px;
        }

        textarea.form-control {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”” Lyx Nexus Notification Dashboard</h1>
            <p>Send push notifications directly from your web app</p>
        </div>

        <div class="dashboard">
            <!-- Notification Setup Card -->
            <div class="card">
                <h2>1. Enable Notifications</h2>
                <button id="enableNotifications" class="btn">Enable Push Notifications</button>
                <div id="notificationStatus" class="status status-info">Click to enable notifications</div>
                
                <div id="tokenSection" class="hidden">
                    <div class="token-display" id="tokenDisplay">Waiting for token...</div>
                    <button onclick="copyToken()" class="btn btn-info">Copy Token</button>
                </div>
            </div>

            <!-- Send Notification Card -->
            <div class="card">
                <h2>2. Send Notification</h2>
                <div class="notification-form">
                    <div class="form-group">
                        <label for="notificationTitle">Title:</label>
                        <input type="text" id="notificationTitle" class="form-control" value="Hello from Lyx Nexus!">
                    </div>
                    <div class="form-group">
                        <label for="notificationBody">Message:</label>
                        <textarea id="notificationBody" class="form-control">This is a test notification sent directly from the dashboard!</textarea>
                    </div>
                    <button onclick="sendNotification()" class="btn btn-success">Send to Me</button>
                    <button onclick="sendToAllUsers()" class="btn btn-info">Send to All Users</button>
                </div>
                <div id="sendStatus" class="status"></div>
            </div>

            <!-- Users Panel -->
            <div class="card users-panel">
                <h2>3. Registered Users</h2>
                <button onclick="loadUsers()" class="btn btn-info">Refresh Users List</button>
                <div class="users-list" id="usersList">
                    No users registered yet
                </div>
                <div id="usersCount" class="status status-info">Loading users...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiySIsbCQ-uNEuqu3ZT1wFUkWkdwD7cbw",
            authDomain: "lyxnexus.firebaseapp.com",
            projectId: "lyxnexus",
            storageBucket: "lyxnexus.firebasestorage.app",
            messagingSenderId: "130771054418",
            appId: "1:130771054418:web:e2c2371cc2844a24e8148b"
        };

        // Your VAPID Key - YOU NEED TO GET THIS FROM FIREBASE CONSOLE
        const VAPID_KEY = "BDULQIsI8FfCFxvWMan3U6qkczWjHox-JvY2MTI6PvukD5D_3OmCCG0F0mrib647v9UyDj8YVVuDM8nY5MzkZgs";

        let app;
        let messaging;
        let currentFCMToken = '';

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                console.log('Initializing Firebase...');
                
                const fcmSupported = await isSupported();
                console.log('FCM supported:', fcmSupported);
                
                if (!fcmSupported) {
                    showNotificationStatus('Firebase Cloud Messaging not supported in this browser', 'error');
                    return;
                }

                app = initializeApp(firebaseConfig);
                messaging = getMessaging(app);
                console.log('Firebase initialized');

                // Register service worker
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered successfully');
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                        showNotificationStatus('Service Worker failed to register', 'error');
                    }
                } else {
                    console.log('Service Worker not supported');
                    showNotificationStatus('Service Worker not supported', 'error');
                }

                // Listen for foreground messages
                onMessage(messaging, (payload) => {
                    console.log('Foreground message received:', payload);
                    showSendStatus('New notification received!', 'success');
                });

                // Check existing permission
                checkPermission();

            } catch (error) {
                console.error('Firebase initialization error:', error);
                showNotificationStatus('Firebase init failed: ' + error.message, 'error');
            }
        }

        // Check current notification permission
        function checkPermission() {
            const permission = Notification.permission;
            console.log('Current permission:', permission);
            
            if (permission === 'granted') {
                document.getElementById('enableNotifications').disabled = true;
                document.getElementById('enableNotifications').textContent = 'Notifications Enabled âœ…';
                showNotificationStatus('Notifications are already enabled!', 'success');
                getFCMToken();
            } else if (permission === 'denied') {
                showNotificationStatus('Notifications are blocked. Please enable them in browser settings.', 'error');
            } else {
                showNotificationStatus('Click the button to enable notifications', 'info');
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            try {
                showNotificationStatus('Requesting notification permission...', 'info');
                
                const permission = await Notification.requestPermission();
                console.log('Permission result:', permission);
                
                if (permission === 'granted') {
                    document.getElementById('enableNotifications').disabled = true;
                    document.getElementById('enableNotifications').textContent = 'Notifications Enabled âœ…';
                    showNotificationStatus('Notification permission granted!', 'success');
                    await getFCMToken();
                } else if (permission === 'denied') {
                    showNotificationStatus('Notification permission denied', 'error');
                } else {
                    showNotificationStatus('Notification permission dismissed', 'info');
                }
            } catch (error) {
                console.error('Error requesting permission:', error);
                showNotificationStatus('Error requesting permission: ' + error.message, 'error');
            }
        }

        // Get FCM token
        async function getFCMToken() {
            try {
                if (!messaging) {
                    throw new Error('Messaging not initialized');
                }

                showNotificationStatus('Getting FCM token...', 'info');
                
                const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                console.log('FCM Token received:', token ? 'Yes' : 'No');
                
                if (token) {
                    currentFCMToken = token;
                    document.getElementById('tokenDisplay').textContent = token;
                    document.getElementById('tokenSection').classList.remove('hidden');
                    showNotificationStatus('FCM token obtained successfully!', 'success');
                    console.log('FCM Token:', token);
                    
                    // Save token to server
                    await saveTokenToServer(token);
                } else {
                    showNotificationStatus('No FCM token available. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error getting FCM token:', error);
                showNotificationStatus('Error getting token: ' + error.message, 'error');
            }
        }

        // Save token to server
        async function saveTokenToServer(token) {
            try {
                const response = await fetch('/save-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const result = await response.json();
                console.log('Save token response:', result);
                
                if (result.success) {
                    console.log('Token saved to server successfully');
                    // Refresh users list
                    await loadUsers();
                } else {
                    console.error('Failed to save token:', result.message);
                }
            } catch (error) {
                console.error('Error saving token to server:', error);
            }
        }

        // Send notification to current user
        async function sendNotification() {
            const title = document.getElementById('notificationTitle').value;
            const body = document.getElementById('notificationBody').value;
            
            if (!title || !body) {
                showSendStatus('Please enter both title and message', 'error');
                return;
            }

            if (!currentFCMToken) {
                showSendStatus('No FCM token available. Please enable notifications first.', 'error');
                return;
            }

            try {
                showSendStatus('Sending notification...', 'info');
                
                const response = await fetch('/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        title: title, 
                        body: body,
                        token: currentFCMToken 
                    })
                });
                
                const result = await response.json();
                console.log('Send notification response:', result);
                
                if (result.success) {
                    showSendStatus('Notification sent successfully!', 'success');
                } else {
                    showSendStatus('Failed to send: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error sending notification:', error);
                showSendStatus('Error sending notification: ' + error.message, 'error');
            }
        }

        // Send to all users
        async function sendToAllUsers() {
            const title = document.getElementById('notificationTitle').value;
            const body = document.getElementById('notificationBody').value;
            
            if (!title || !body) {
                showSendStatus('Please enter both title and message', 'error');
                return;
            }

            try {
                showSendStatus('Sending to all users...', 'info');
                
                const response = await fetch('/send-to-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        title: title, 
                        body: body
                    })
                });
                
                const result = await response.json();
                console.log('Send to all response:', result);
                
                if (result.success) {
                    showSendStatus(result.message, 'success');
                } else {
                    showSendStatus('Failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error sending to all:', error);
                showSendStatus('Error: ' + error.message, 'error');
            }
        }

        // Load users list
        async function loadUsers() {
            try {
                console.log('Loading users...');
                const response = await fetch('/get-tokens');
                const result = await response.json();
                console.log('Users response:', result);
                
                const usersList = document.getElementById('usersList');
                const usersCount = document.getElementById('usersCount');
                
                if (result.success) {
                    if (result.tokens && result.tokens.length > 0) {
                        usersList.innerHTML = result.tokens.map(token => 
                            `<div class="user-item">${token}</div>`
                        ).join('');
                        usersCount.textContent = `${result.count} users registered`;
                        usersCount.className = 'status status-success';
                    } else {
                        usersList.innerHTML = 'No users registered yet';
                        usersCount.textContent = '0 users registered';
                        usersCount.className = 'status status-info';
                    }
                } else {
                    usersList.innerHTML = 'Error loading users';
                    usersCount.textContent = 'Error';
                    usersCount.className = 'status status-error';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                const usersList = document.getElementById('usersList');
                const usersCount = document.getElementById('usersCount');
                usersList.innerHTML = 'Error loading users list';
                usersCount.textContent = 'Error';
                usersCount.className = 'status status-error';
            }
        }

        // Copy token to clipboard
        async function copyToken() {
            try {
                await navigator.clipboard.writeText(currentFCMToken);
                showNotificationStatus('Token copied to clipboard!', 'success');
            } catch (error) {
                showNotificationStatus('Failed to copy token', 'error');
            }
        }

        // Status display functions
        function showNotificationStatus(message, type) {
            const element = document.getElementById('notificationStatus');
            if (element) {
                element.textContent = message;
                element.className = `status status-${type}`;
            }
        }

        function showSendStatus(message, type) {
            const element = document.getElementById('sendStatus');
            if (element) {
                element.textContent = message;
                element.className = `status status-${type}`;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            initializeFirebase();
            
            // Add event listeners
            const enableBtn = document.getElementById('enableNotifications');
            if (enableBtn) {
                enableBtn.addEventListener('click', requestNotificationPermission);
            }
            
            // Load users on startup
            loadUsers();
            
            console.log('Initialization complete');
        });

        // Make functions global for onclick handlers
        window.copyToken = copyToken;
        window.sendNotification = sendNotification;
        window.sendToAllUsers = sendToAllUsers;
        window.loadUsers = loadUsers;
    </script>
</body>
</html>