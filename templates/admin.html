<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyxNexus | Admin Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/_0eXv3/tailwind.all.css"></script>
    <script src="/_0eXv4/n-s.js"></script>
    <script src="/_0eXv4/loading.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #818cf8;
        --secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #0f172a;
        --darker: #020617;
        --light: #f8fafc;
        --gray: #94a3b8;
        --card-bg: rgba(30, 41, 59, 0.8);
        --border: rgba(99, 102, 241, 0.2);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
        color: var(--light);
        min-height: 100vh;
        overflow: hidden;
    }

    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.3);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }

    .app-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
        position: relative;
    }

    .sidebar {
        width: 280px;
        background: rgba(2, 6, 23, 0.95);
        backdrop-filter: blur(10px);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 50;
    }

    .sidebar.collapsed {
        width: 120px;
    }

    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .logo-badge,
    .sidebar.collapsed .nav-label,
    .sidebar.collapsed .nav-item span:not(.icon-only) {
        display: none;
    }

    .sidebar.collapsed .nav-item {
        justify-content: center;
        padding: 12px 0;
    }

    .sidebar.collapsed .nav-item i {
        margin: 0;
        font-size: 20px;
    }

    .sidebar.collapsed .sidebar-header {
        padding: 20px 0;
        justify-content: center;
    }

    .sidebar.collapsed .logo-wrapper {
        justify-content: center;
    }

    .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .logo-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
        flex-shrink: 0;
    }

    .logo-text {
        font-weight: 700;
        font-size: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
        white-space: nowrap;
    }

    .logo-badge {
        font-size: 12px;
        background: rgba(99, 102, 241, 0.2);
        padding: 2px 8px;
        border-radius: 20px;
        color: var(--primary-light);
        margin-top: 2px;
        display: inline-block;
        white-space: nowrap;
    }

    .toggle-sidebar {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--gray);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .toggle-sidebar:hover {
        background: var(--primary);
        color: white;
        border-color: transparent;
    }

    .sidebar.collapsed .toggle-sidebar i {
        transform: rotate(180deg);
    }

    .nav-section {
        padding: 20px;
        flex: 1;
    }

    .nav-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--gray);
        margin-bottom: 12px;
        font-weight: 600;
        transition: opacity 0.2s ease;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        color: var(--gray);
        transition: all 0.2s ease;
        margin-bottom: 4px;
        cursor: pointer;
        border: 1px solid transparent;
        white-space: nowrap;
    }

    .nav-item:hover {
        background: rgba(99, 102, 241, 0.1);
        color: var(--light);
        border-color: var(--border);
    }

    .nav-item.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
        color: var(--light);
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .nav-item i {
        width: 20px;
        font-size: 16px;
        flex-shrink: 0;
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: rgba(15, 23, 42, 0.4);
        transition: all 0.3s ease;
    }

    .top-bar {
        background: rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(10px);
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .top-bar-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .menu-toggle {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--gray);
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .menu-toggle:hover {
        background: var(--primary);
        color: white;
        border-color: transparent;
    }

    .page-title {
        font-size: 20px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .user-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
    }

    .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }

    .quick-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }

    .action-btn {
        padding: 10px 20px;
        border-radius: 100px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid var(--border);
        color: var(--light);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .action-btn:hover {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
    }

    .action-btn i {
        font-size: 14px;
    }

    .sub-tabs {
        display: flex;
        gap: 8px;
        padding: 4px;
        background: rgba(2, 6, 23, 0.4);
        border-radius: 100px;
        margin-bottom: 24px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .sub-tabs::-webkit-scrollbar {
        display: none;
    }

    .sub-tab {
        padding: 10px 24px;
        border-radius: 100px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gray);
        transition: all 0.2s ease;
        white-space: nowrap;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .sub-tab:hover {
        color: var(--light);
        background: rgba(99, 102, 241, 0.1);
    }

    .sub-tab.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        border: 1px solid var(--border);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
    }

    .card:hover {
        transform: translateY(-4px);
        border-color: var(--primary);
        box-shadow: 0 20px 30px -10px rgba(99, 102, 241, 0.2);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .card-title {
        font-weight: 600;
        font-size: 16px;
        color: var(--light);
        text-decoration: underline;
        text-decoration-color: var(--primary);
        text-underline-offset: 4px;
    }

    .card-subtitle {
        font-size: 12px;
        color: var(--gray);
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .card-body {
        padding: 16px 20px;
    }

    .card-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .year-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 12px;
        font-weight: 600;
        gap: 6px;
    }

    .year-badge.all { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .year-badge.year1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .year-badge.year2 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .year-badge.year3 { background: linear-gradient(135deg, #10b981, #059669); }
    .year-badge.year4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .year-badge.year5 { background: linear-gradient(135deg, #ef4444, #dc2626); }

    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--gray);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-icon:hover {
        background: var(--primary);
        color: white;
        border-color: transparent;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    @keyframes successPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); box-shadow: 0 0 20px var(--success); }
        100% { transform: scale(1); }
    }

    @keyframes loadingSpin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes checkmark {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    .btn-sm {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s ease;
        background: rgba(6, 172, 243, 0.687);
    }

    .btn-sm.primary {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .btn-sm.primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .btn-sm.primary:hover::before {
        left: 100%;
    }

    .btn-sm.primary.saving {
        animation: pulse 1s infinite;
        pointer-events: none;
        opacity: 0.8;
        background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
    }

    .btn-sm.primary.saving i {
        animation: loadingSpin 1s linear infinite;
    }

    .btn-sm.primary.success {
        animation: successPop 0.5s ease;
        background: linear-gradient(135deg, var(--success), #059669);
    }

    .btn-sm.primary.success i {
        animation: checkmark 0.5s ease;
    }

    .btn-sm.primary.error {
        animation: pulse 0.5s ease;
        background: linear-gradient(135deg, var(--danger), #dc2626);
    }

    /* Shimmer effect for loading state */
    .btn-sm.primary.saving::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 2s infinite;
    }

    /* Icon animations */
    .btn-sm.primary i {
        transition: all 0.3s ease;
    }

    .btn-sm.primary:not(.saving):not(.success):hover i {
        transform: scale(1.2);
    }

    /* Button click effect */
    .btn-sm.primary:active:not(.saving) {
        transform: scale(0.95);
    }

    /* Success state icon */
    .btn-sm.primary.success i {
        color: white;
    }

    /* Disabled state */
    .btn-sm.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Ripple effect on click */
    .btn-sm.primary .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: scale(0);
        animation: ripple 0.6s ease-out;
        pointer-events: none;
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    .btn-sm.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
        border: 1px solid var(--border);
    }

    .btn-sm.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
    }

    .confirm-modal.show {
        display: flex;
    }

    .confirm-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .confirm-icon {
        width: 56px;
        height: 56px;
        background: rgba(239, 68, 68, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: var(--danger);
        font-size: 24px;
    }

    .confirm-title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
    }

    .confirm-message {
        text-align: center;
        color: var(--gray);
        font-size: 14px;
        margin-bottom: 20px;
    }

    .confirm-actions {
        display: flex;
        gap: 12px;
    }

    .confirm-btn {
        flex: 1;
        padding: 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
    }

    .confirm-btn.cancel {
        background: rgba(255, 255, 255, 0.05);
        color: var(--gray);
        border: 1px solid var(--border);
    }

    .confirm-btn.cancel:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
    }

    .confirm-btn.confirm {
        background: var(--danger);
        color: white;
    }

    .confirm-btn.confirm:hover {
        background: #dc2626;
    }

    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--primary); }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        grid-column: 1 / -1;
    }

    .empty-state i {
        font-size: 48px;
        color: var(--gray);
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--gray);
        font-size: 14px;
        max-width: 300px;
        margin: 0 auto 20px;
    }

    .attachment-preview {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        margin-top: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .attachment-preview:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    .attachment-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        animation: scaleIn 0.3s ease;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--light);
        font-size: 14px;
        margin-bottom: 16px;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-input::placeholder {
        color: var(--gray);
    }

    .file-input-label {
        display: block;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px dashed var(--border);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--gray);
    }

    .file-input-label:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        color: var(--light);
    }

    .file-input-wrapper {
        position: relative;
        margin-bottom: 16px;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-info {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            left: -280px;
            height: 100vh;
            z-index: 100;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
        }

        .sidebar.mobile-open {
            left: 0;
        }

        .menu-toggle {
            display: flex;
        }

        .content-grid {
            grid-template-columns: 1fr;
        }

        .sub-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 4px;
            border-radius: 50px;
        }

        .quick-actions {
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .action-btn {
            flex-shrink: 0;
        }

        .top-bar {
            padding: 12px 16px;
        }

        .content-area {
            padding: 16px;
        }
    }

    @media (max-width: 480px) {
        .card-header {
            flex-direction: column;
            gap: 12px;
        }

        .card-header > div:last-child {
            align-self: flex-end;
        }

        .user-menu .btn-icon {
            display: none;
        }

        .page-title {
            font-size: 18px;
        }
    }

    @media (min-width: 2560px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        }

        .sidebar {
            width: 320px;
        }

        .sidebar.collapsed {
            width: 100px;
        }
    }

    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .icon-only {
        display: none;
    }

    .sidebar.collapsed .icon-only {
        display: inline-block;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
    }

    .status-badge.online {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    .status-badge.offline {
        background: rgba(100, 116, 139, 0.2);
        color: var(--gray);
    }
</style>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-title" id="confirm-title">Confirm Action</h3>
            <p class="confirm-message" id="confirm-message">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" id="confirm-cancel">Cancel</button>
                <button class="confirm-btn confirm" id="confirm-ok">Confirm</button>
            </div>
        </div>
    </div>

    <div class="modal" id="image-modal">
        <div class="modal-content" style="max-width: 800px; background: transparent; border: none; padding: 0;">
            <img id="modal-image" src="" style="width: 100%; border-radius: 16px;" alt="Preview">
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-wrapper">
                    <div class="logo-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <div class="logo-text">LyxNexus</div>
                        <span class="logo-badge">Admin Portal</span>
                    </div>
                </div>
                <button class="toggle-sidebar" id="toggle-sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-tab="dashboard">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                    <span class="icon-only">DB</span>
                </div>
                <div class="nav-item" data-tab="announcements">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                    <span class="icon-only">Ann</span>
                </div>
                <div class="nav-item" data-tab="assignments">
                    <i class="fas fa-tasks"></i>
                    <span>Assignments</span>
                    <span class="icon-only">Asg</span>
                </div>
                <div class="nav-item" data-tab="topics">
                    <i class="fas fa-book"></i>
                    <span>Units</span>
                    <span class="icon-only">Unt</span>
                </div>
                <div class="nav-item" data-tab="timetable">
                    <i class="fas fa-calendar"></i>
                    <span>Timetable</span>
                    <span class="icon-only">TT</span>
                </div>

                <div class="nav-label" style="margin-top: 20px;">Resources</div>
                <div class="nav-item" onclick="window.location.href='/files'">
                    <i class="fas fa-file"></i>
                    <span>Files</span>
                    <span class="icon-only">Fls</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/store'">
                    <i class="fas fa-folder-open"></i>
                    <span>Archives</span>
                    <span class="icon-only">Arc</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/past-papers'">
                    <i class="fas fa-scroll"></i>
                    <span>Papers</span>
                    <span class="icon-only">Pap</span>
                </div>

                <div class="nav-label" style="margin-top: 20px;">Administration</div>
                <div class="nav-item" onclick="window.location.href='/admin/users'">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                    <span class="icon-only">Usr</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/secret-code'">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secret Code</span>
                    <span class="icon-only">Cod</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/operator'">
                    <i class="fas fa-cog"></i>
                    <span>Operator</span>
                    <span class="icon-only">Ops</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/clone-db'">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                    <span class="icon-only">DB</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/profile'">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                    <span class="icon-only">Prf</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/messages'">
                    <i class="fas fa-comments"></i>
                    <span>Messages</span>
                    <span class="icon-only">Msg</span>
                </div>
            </div>

            <div class="nav-section" style="border-top: 1px solid var(--border);">
                <div class="nav-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <span class="icon-only">Ext</span>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                </div>
                <div class="user-menu">
                    <button class="btn-icon" onclick="window.location.href='/messages'">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="btn-icon" onclick="window.location.href='/profile'">
                        <i class="fas fa-user"></i>
                    </button>
                    <button class="btn-icon" id="topbar-logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <div class="user-avatar" id="user-avatar" onclick="window.location.href='/profile'">A</div>
                </div>
            </div>

            <div class="content-area" id="content-area">
                <div class="quick-actions" id="quick-actions"></div>
                <div class="sub-tabs" id="sub-tabs"></div>
                <div id="content-container" class="content-grid">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="create-modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Create New</h3>
            <form id="modal-form">
                <input type="hidden" id="modal-id">
                <div id="modal-fields"></div>
                
                <div id="modal-file-section" style="display: none;">
                    <div class="file-input-wrapper">
                        <input type="file" id="modal-file">
                        <label for="modal-file" class="file-input-label">
                            <i class="fas fa-upload mr-2"></i>Attach File (Optional)
                        </label>
                    </div>
                    <div id="modal-file-info" class="file-info" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file"></i>
                            <span id="modal-file-name"></span>
                        </div>
                        <button type="button" class="btn-icon" id="clear-modal-file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn-sm secondary" id="cancel-modal">Cancel</button>
                    <button type="submit" class="btn-sm primary" id="modal-submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== Configuration ====================
        const API_BASE = '/api';
        const ENDPOINTS = {
            ANNOUNCEMENTS: `${API_BASE}/announcements`,
            ASSIGNMENTS: `${API_BASE}/assignments`,
            TIMETABLE: `${API_BASE}/timetable`,
            TOPICS: `${API_BASE}/topics`,
            FILES: `${API_BASE}/files`,
            USERS: `${API_BASE}/users`,
            CURRENT_USER: `${API_BASE}/user/profile`
        };

        // ==================== State Management ====================
        let currentMainTab = 'dashboard';
        let currentSubTab = 'announcements';
        let currentEditingId = null;
        let currentFile = null;
        let toastManager;
        let confirmResolver = null;
        let isSidebarCollapsed = false;

        // ==================== Toast Manager ====================
        class ToastManager {
            constructor() {
                this.container = document.getElementById('toast-container');
            }

            show(message, type = 'info', title = null) {
                const titles = { success: 'Success', error: 'Error', info: 'Information' };
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icon = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                }[type];

                toast.innerHTML = `
                    <i class="fas ${icon}" style="color: var(--${type}); font-size: 20px;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${title || titles[type]}</div>
                        <div style="font-size: 13px; color: var(--gray);">${message}</div>
                    </div>
                `;

                this.container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        }

        toastManager = new ToastManager();

        // ==================== Utility Functions ====================
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const d = new Date(dateString);
                return d.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch {
                return dateString;
            }
        }

        function getFileIcon(filename) {
            if (!filename) return 'fa-file';
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
                txt: 'fa-file-alt', zip: 'fa-file-archive', jpg: 'fa-file-image',
                jpeg: 'fa-file-image', png: 'fa-file-image', gif: 'fa-file-image',
                mp4: 'fa-file-video', mp3: 'fa-file-audio', xls: 'fa-file-excel',
                xlsx: 'fa-file-excel', ppt: 'fa-file-powerpoint', pptx: 'fa-file-powerpoint'
            };
            return icons[ext] || 'fa-file';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 KB';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ==================== API Functions ====================
        async function loadUserData() {
            try {
                const response = await fetch(ENDPOINTS.CURRENT_USER);
                if (!response.ok) throw new Error('Failed to fetch user');
                const userData = await response.json();
                localStorage.setItem('user', JSON.stringify(userData));
                document.getElementById('user-avatar').textContent = 
                    (userData.username || 'A').charAt(0).toUpperCase();
                return userData;
            } catch (error) {
                console.error('Error loading user:', error);
                return null;
            }
        }

        async function fetchData(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Fetch error:', err);
                return [];
            }
        }

        async function sendData(url, data, method = 'POST') {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function deleteData(url) {
            const res = await fetch(url, { method: 'DELETE' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function uploadFile(endpoint, file, id) {
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch(`${endpoint}/${id}/upload`, { method: 'POST', body: fd });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        // ==================== Confirm Modal ====================
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                confirmResolver = resolve;
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-modal').classList.add('show');
            });
        }

        // ==================== Sidebar Functions ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            isSidebarCollapsed = !isSidebarCollapsed;
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // ==================== Tab Management ====================
        function switchMainTab(tab) {
            currentMainTab = tab;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            const titles = {
                dashboard: 'Dashboard',
                announcements: 'Announcements',
                assignments: 'Assignments',
                topics: 'Units',
                timetable: 'Timetable'
            };
            
            document.getElementById('page-title').textContent = titles[tab] || tab;
            
            updateQuickActions(tab);
            updateSubTabs(tab);
            loadTabContent(tab, currentSubTab);
        }

        function updateQuickActions(tab) {
            const actions = {
                announcements: [
                    { icon: 'fa-plus', text: 'New Announcement', action: 'createAnnouncement' },
                    { icon: 'fa-filter', text: 'Filter', action: 'filterContent' },
                    { icon: 'fa-search', text: 'Search', action: 'searchContent' }
                ],
                assignments: [
                    { icon: 'fa-plus', text: 'New Assignment', action: 'createAssignment' },
                    { icon: 'fa-filter', text: 'Filter', action: 'filterContent' },
                    { icon: 'fa-calendar', text: 'Due Soon', action: 'filterDueSoon' }
                ],
                topics: [
                    { icon: 'fa-plus', text: 'New Unit', action: 'createTopic' },
                    { icon: 'fa-filter', text: 'Filter', action: 'filterContent' },
                    { icon: 'fa-chart-bar', text: 'Statistics', action: 'showStats' }
                ],
                timetable: [
                    { icon: 'fa-plus', text: 'New Slot', action: 'createTimetable' },
                    { icon: 'fa-filter', text: 'Filter', action: 'filterContent' },
                    { icon: 'fa-print', text: 'Print', action: 'printTimetable' }
                ],
                dashboard: [
                    { icon: 'fa-bullhorn', text: 'Announcements', action: 'announcements' },
                    { icon: 'fa-tasks', text: 'Assignments', action: 'assignments' },
                    { icon: 'fa-folder', text: 'Units', action: 'topics' },
                    { icon: 'fa-calendar', text: 'Timetable', action: 'timetable' }
                ]
            };

            const container = document.getElementById('quick-actions');
            container.innerHTML = (actions[tab] || []).map(action => {
                if (tab === 'dashboard') {
                    return `<button class="action-btn" onclick="switchMainTab('${action.action}')">
                        <i class="fas ${action.icon}"></i>
                        <span>${action.text}</span>
                    </button>`;
                } else {
                    return `<button class="action-btn" onclick="window.${action.action}()">
                        <i class="fas ${action.icon}"></i>
                        <span>${action.text}</span>
                    </button>`;
                }
            }).join('');
        }

        function updateSubTabs(mainTab) {
            const subTabs = {
                announcements: [
                    { id: 'announcements', name: 'All Announcements' },
                    { id: 'my-announcements', name: 'My Announcements' },
                    { id: 'highlighted', name: 'Highlighted' }
                ],
                assignments: [
                    { id: 'assignments', name: 'All Assignments' },
                    { id: 'due-soon', name: 'Due Soon' },
                    { id: 'overdue', name: 'Overdue' }
                ],
                topics: [
                    { id: 'topics', name: 'All Units' },
                    { id: 'my-topics', name: 'My Units' }
                ],
                timetable: [
                    { id: 'timetable', name: 'Weekly View' },
                    { id: 'today', name: 'Today' },
                    { id: 'tomorrow', name: 'Tomorrow' }
                ],
                dashboard: []
            };

            const tabs = subTabs[mainTab] || [];
            const container = document.getElementById('sub-tabs');
            
            if (tabs.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = tabs.map(tab => `
                <button class="sub-tab ${tab.id === currentSubTab ? 'active' : ''}" 
                        onclick="switchSubTab('${tab.id}')">
                    ${tab.name}
                </button>
            `).join('');
        }

        function switchSubTab(subTab) {
            currentSubTab = subTab;
            document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            loadTabContent(currentMainTab, subTab);
        }

        // ==================== Content Loading ====================
        async function loadTabContent(mainTab, subTab) {
            const container = document.getElementById('content-container');
            
            container.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                </div>
            `;

            await new Promise(resolve => setTimeout(resolve, 300));

            switch(mainTab) {
                case 'announcements':
                    await loadAnnouncements(subTab);
                    break;
                case 'assignments':
                    await loadAssignments(subTab);
                    break;
                case 'topics':
                    await loadTopics(subTab);
                    break;
                case 'timetable':
                    await loadTimetable(subTab);
                    break;
                case 'dashboard':
                    await loadDashboard();
                    break;
            }
        }

        async function loadAnnouncements(filter = 'announcements') {
            const items = await fetchData(ENDPOINTS.ANNOUNCEMENTS);
            const container = document.getElementById('content-container');
            
            let filtered = items;
            if (filter === 'my-announcements') {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                filtered = items.filter(a => a.author?.id === user.id);
            } else if (filter === 'highlighted') {
                filtered = items.filter(a => a.highlight);
            }

            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <h3>No Announcements Found</h3>
                        <p>${filter === 'my-announcements' ? "You haven't created any announcements yet." : 'Create your first announcement to get started'}</p>
                        <button class="btn-sm primary" onclick="createAnnouncement()">
                            <i class="fas fa-plus mr-1"></i> Create Announcement
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${escapeHtml(item.title || 'Untitled')}</h3>
                            <div class="card-subtitle">
                                <span class="year-badge ${item.author?.year == 5 ? 'all' : `year${item.author?.year || 1}`}">
                                    <i class="fas fa-graduation-cap"></i>
                                    ${item.author?.year == 5 ? 'All Years' : `Year ${item.author?.year || 1}`}
                                </span>
                                <span>
                                    <i class="fas fa-user"></i> ${escapeHtml(item.author?.username || 'Unknown')}
                                </span>
                                ${item.highlight ? `
                                    <span class="status-badge" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);">
                                        <i class="fas fa-star"></i> Highlighted
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn-icon" onclick="editAnnouncement(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteAnnouncement(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray); line-height: 1.6; margin-bottom: 16px;">${escapeHtml(item.content)}</p>
                        
                        ${item.file_name ? `
                            <div class="attachment-preview" onclick="window.open('/announcement-file/${item.id}/${encodeURIComponent(item.file_name)}', '_blank')">
                                <div class="attachment-icon">
                                    <i class="fas ${getFileIcon(item.file_name)}"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${escapeHtml(item.file_name)}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${formatFileSize(item.file_size)}  Click to download</div>
                                </div>
                                <i class="fas fa-download" style="color: var(--gray);"></i>
                            </div>
                        ` : ''}
                    </div>
                    <div class="card-footer">
                        <span style="color: var(--gray); font-size: 12px;">
                            <i class="fas fa-clock"></i> ${formatDate(item.created_at)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        async function loadAssignments(filter = 'assignments') {
            const items = await fetchData(ENDPOINTS.ASSIGNMENTS);
            const container = document.getElementById('content-container');
            const now = new Date();

            let filtered = items;
            if (filter === 'due-soon') {
                filtered = items.filter(a => {
                    const due = new Date(a.due_date);
                    const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                    return diffDays > 0 && diffDays <= 3;
                });
            } else if (filter === 'overdue') {
                filtered = items.filter(a => new Date(a.due_date) < now);
            }

            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <h3>No Assignments Found</h3>
                        <p>${filter === 'due-soon' ? 'No assignments due soon' : 'Create your first assignment to get started'}</p>
                        <button class="btn-sm primary" onclick="createAssignment()">
                            <i class="fas fa-plus mr-1"></i> Create Assignment
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const due = new Date(item.due_date);
                const isOverdue = due < now;
                const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                const timeLeft = isOverdue ? 'Overdue' : 
                               diffDays === 0 ? 'Due today' :
                               diffDays === 1 ? 'Due tomorrow' :
                               `${diffDays} days left`;

                return `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">${escapeHtml(item.title)}</h3>
                                <div class="card-subtitle">
                                    <span class="year-badge ${item.creator?.year == 5 ? 'all' : `year${item.creator?.year || 1}`}">
                                        <i class="fas fa-graduation-cap"></i>
                                        ${item.creator?.year == 5 ? 'All Years' : `Year ${item.creator?.year || 1}`}
                                    </span>
                                    ${item.topic?.name ? `
                                        <span>
                                            <i class="fas fa-folder"></i> ${escapeHtml(item.topic.name)}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn-icon" onclick="editAssignment(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteAssignment(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--gray); margin-bottom: 16px;">${escapeHtml(item.description)}</p>
                            
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--success)'}; font-weight: 500;">
                                        <i class="fas ${isOverdue ? 'fa-exclamation-circle' : 'fa-clock'}"></i>
                                        Due: ${formatDate(item.due_date)}
                                    </span>
                                    <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--gray)'}; font-size: 12px; font-weight: 500;">
                                        ${timeLeft}
                                    </span>
                                </div>
                            </div>

                            ${item.file_name ? `
                                <div class="attachment-preview" onclick="downloadAssignmentFile(${item.id})">
                                    <div class="attachment-icon">
                                        <i class="fas ${getFileIcon(item.file_name)}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${escapeHtml(item.file_name)}</div>
                                        <div style="font-size: 12px; color: var(--gray);">${formatFileSize(item.file_size)}  Click to download</div>
                                    </div>
                                    <i class="fas fa-download" style="color: var(--gray);"></i>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadTopics(filter = 'topics') {
            const items = await fetchData(ENDPOINTS.TOPICS);
            const container = document.getElementById('content-container');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder"></i>
                        <h3>No Units Found</h3>
                        <p>Create your first unit to get started</p>
                        <button class="btn-sm primary" onclick="createTopic()">
                            <i class="fas fa-plus mr-1"></i> Create Unit
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${escapeHtml(item.name)}</h3>
                            <div class="card-subtitle">
                                <span class="year-badge ${item.year == 5 ? 'all' : `year${item.year || 1}`}">
                                    <i class="fas fa-graduation-cap"></i>
                                    ${item.year == 5 ? 'All Years' : `Year ${item.year || 1}`}
                                </span>
                                <span>
                                    <i class="fas fa-chalkboard-teacher"></i> ${escapeHtml(item.lecturer || 'TBA')}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn-icon" onclick="window.location.href='/material/${item.id}'">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="btn-icon" onclick="editTopic(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteTopic(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray); margin-bottom: 16px;">${escapeHtml(item.description || 'No description available')}</p>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                                <span><i class="fas fa-user"></i> ${escapeHtml(item.lecturer || 'TBA')}</span>
                                ${item.contact ? `
                                    <span><i class="fas fa-phone"></i> ${escapeHtml(item.contact)}</span>
                                ` : ''}
                                <span><i class="fas fa-clock"></i> Created ${formatDate(item.created_at)}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button class="btn-sm primary" onclick="window.location.href='/material/${item.id}'">
                                <i class="fas fa-tasks"></i> View Materials
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadTimetable(filter = 'timetable') {
            const raw = await fetchData(ENDPOINTS.TIMETABLE);
            const container = document.getElementById('content-container');
            const now = new Date();
            const today = now.toLocaleDateString('en-US', { weekday: 'long' });

            let slots = [];
            if (Array.isArray(raw) && raw.length && raw[0].day && raw[0].slots) {
                raw.forEach(d => {
                    d.slots.forEach(s => slots.push({ ...s, day: d.day }));
                });
            } else if (Array.isArray(raw)) {
                slots = raw;
            }

            let filtered = slots;
            if (filter === 'today') {
                filtered = slots.filter(s => (s.day_of_week || s.day) === today);
            } else if (filter === 'tomorrow') {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowDay = tomorrow.toLocaleDateString('en-US', { weekday: 'long' });
                filtered = slots.filter(s => (s.day_of_week || s.day) === tomorrowDay);
            }

            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <h3>No Timetable Slots Found</h3>
                        <p>${filter === 'today' ? 'No classes scheduled for today' : 'Create your first timetable slot'}</p>
                        <button class="btn-sm primary" onclick="createTimetable()">
                            <i class="fas fa-plus mr-1"></i> Add Slot
                        </button>
                    </div>
                `;
                return;
            }

            const grouped = filtered.reduce((acc, slot) => {
                const day = slot.day_of_week || slot.day || 'Unsorted';
                if (!acc[day]) acc[day] = [];
                acc[day].push(slot);
                return acc;
            }, {});

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            container.innerHTML = days.map(day => {
                if (!grouped[day] || grouped[day].length === 0) return '';
                
                return `
                    <div class="card" style="grid-column: 1/-1;">
                        <div class="card-header">
                            <h3 class="card-title">${day}</h3>
                            <span class="status-badge" style="background: rgba(99, 102, 241, 0.2); color: var(--primary);">
                                ${grouped[day].length} slot${grouped[day].length > 1 ? 's' : ''}
                            </span>
                        </div>
                        <div class="card-body">
                            ${grouped[day].map(slot => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-weight: 500;">${escapeHtml(slot.subject)}</span>
                                            <span class="year-badge ${slot.year == 5 ? 'all' : `year${slot.year || 0}`}" style="font-size: 10px; padding: 2px 8px;">
                                                ${s.year === 5 ? 'All' : `Y${s.year || 1}`}
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--gray); display: flex; gap: 16px; flex-wrap: wrap;">
                                            <span><i class="fas fa-clock"></i> ${escapeHtml(slot.start_time)} - ${escapeHtml(slot.end_time)}</span>
                                            <span><i class="fas fa-chalkboard-teacher"></i> ${escapeHtml(slot.teacher || 'TBA')}</span>
                                            <span><i class="fas fa-door-open"></i> ${escapeHtml(slot.room || 'TBA')}</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn-icon" onclick="editTimetableSlot(${slot.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon" onclick="deleteTimetableSlot(${slot.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');
        }

        async function loadDashboard() {
            const [announcements, assignments, topics, users] = await Promise.all([
                fetchData(ENDPOINTS.ANNOUNCEMENTS),
                fetchData(ENDPOINTS.ASSIGNMENTS),
                fetchData(ENDPOINTS.TOPICS),
                fetchData(ENDPOINTS.USERS)
            ]);

            const now = new Date();
            const upcomingAssignments = (assignments || [])
                .filter(a => new Date(a.due_date) > now)
                .sort((a, b) => new Date(a.due_date) - new Date(b.due_date))
                .slice(0, 5);

            const recentAnnouncements = (announcements || [])
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            const container = document.getElementById('content-container');
            
            container.innerHTML = `
                <div class="card" style="grid-column: 1/-1;">
                    <div class="card-header">
                        <h3 class="card-title">Quick Overview</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(99, 102, 241, 0.1); border-radius: 16px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${announcements?.length || 0}</div>
                                <div style="font-size: 14px; color: var(--gray);">Announcements</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 16px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--secondary);">${assignments?.length || 0}</div>
                                <div style="font-size: 14px; color: var(--gray);">Assignments</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 16px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--success);">${topics?.length || 0}</div>
                                <div style="font-size: 14px; color: var(--gray);">Units</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 16px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--warning);">${users?.length || 0}</div>
                                <div style="font-size: 14px; color: var(--gray);">Users</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Announcements</h3>
                        <button class="btn-icon" onclick="switchMainTab('announcements')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${recentAnnouncements.length > 0 ? recentAnnouncements.map(a => `
                            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                <div style="font-weight: 500;">${escapeHtml(a.title || 'Untitled')}</div>
                                <div style="font-size: 12px; color: var(--gray); display: flex; justify-content: space-between; margin-top: 4px;">
                                    <span>${escapeHtml(a.author?.username || 'Unknown')}</span>
                                    <span>${formatDate(a.created_at)}</span>
                                </div>
                            </div>
                        `).join('') : `
                            <p style="color: var(--gray); text-align: center; padding: 20px;">No recent announcements</p>
                        `}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Upcoming Assignments</h3>
                        <button class="btn-icon" onclick="switchMainTab('assignments')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${upcomingAssignments.length > 0 ? upcomingAssignments.map(a => {
                            const due = new Date(a.due_date);
                            const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                            return `
                                <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 500;">${escapeHtml(a.title)}</div>
                                            <div style="font-size: 12px; color: var(--gray);">${escapeHtml(a.topic?.name || 'No topic')}</div>
                                        </div>
                                        <span style="font-size: 12px; color: ${diffDays <= 2 ? 'var(--warning)' : 'var(--gray)'};">
                                            ${diffDays === 0 ? 'Today' : diffDays === 1 ? 'Tomorrow' : `${diffDays} days`}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <p style="color: var(--gray); text-align: center; padding: 20px;">No upcoming assignments</p>
                        `}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button class="btn-sm primary" onclick="createAnnouncement()" style="justify-content: center;">
                                <i class="fas fa-bullhorn"></i> Announce
                            </button>
                            <button class="btn-sm primary" onclick="createAssignment()" style="justify-content: center;">
                                <i class="fas fa-tasks"></i> Assignment
                            </button>
                            <button class="btn-sm primary" onclick="createTopic()" style="justify-content: center;">
                                <i class="fas fa-folder"></i> Unit
                            </button>
                            <button class="btn-sm primary" onclick="createTimetable()" style="justify-content: center;">
                                <i class="fas fa-calendar"></i> Timetable
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== Modal Functions ====================
        function openCreateModal(title, fields, hasFile = false) {
            const modal = document.getElementById('create-modal');
            document.getElementById('modal-title').textContent = title;
            
            const fieldsHtml = fields.map(field => {
                if (field.type === 'textarea') {
                    return `<textarea class="form-input" id="modal-${field.id}" placeholder="${field.placeholder}" ${field.required ? 'required' : ''} style="height: ${field.height || '100px'};">${field.value || ''}</textarea>`;
                } else if (field.type === 'checkbox') {
                    return `<label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; cursor: pointer;">
                        <input type="checkbox" id="modal-${field.id}" style="width: 16px; height: 16px; accent-color: var(--primary);" ${field.checked ? 'checked' : ''}>
                        <span style="color: var(--gray);">${field.label}</span>
                    </label>`;
                } else if (field.type === 'select') {
                    const options = field.options || [];
                    return `<select class="form-input" id="modal-${field.id}" ${field.required ? 'required' : ''}>
                        <option value="">${field.placeholder}</option>
                        ${options.map(opt => {
                            if (typeof opt === 'object') {
                                return `<option value="${opt.value}" ${opt.value == field.value ? 'selected' : ''}>${opt.label}</option>`;
                            } else {
                                return `<option value="${opt}" ${opt == field.value ? 'selected' : ''}>${opt}</option>`;
                            }
                        }).join('')}
                    </select>`;
                } else if (field.type === 'time' || field.type === 'datetime-local') {
                    return `<input type="${field.type}" class="form-input" id="modal-${field.id}" value="${field.value || ''}" ${field.required ? 'required' : ''}>`;
                } else {
                    return `<input type="${field.type}" class="form-input" id="modal-${field.id}" 
                        placeholder="${field.placeholder}" value="${field.value || ''}" ${field.required ? 'required' : ''}>`;
                }
            }).join('');

            document.getElementById('modal-fields').innerHTML = fieldsHtml;
            document.getElementById('modal-file-section').style.display = hasFile ? 'block' : 'none';
            document.getElementById('modal-id').value = currentEditingId || '';
            document.getElementById('modal-submit').textContent = currentEditingId ? 'Update' : 'Save';
            modal.classList.add('show');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('show');
            currentEditingId = null;
            currentFile = null;
        }

        // ==================== CRUD Operations ====================
        window.createAnnouncement = function() {
            currentEditingId = null;
            openCreateModal('Create Announcement', [
                { type: 'text', id: 'title', placeholder: 'Title (Optional)' },
                { type: 'textarea', id: 'content', placeholder: 'Content', required: true },
                { type: 'checkbox', id: 'highlight', label: 'Highlight this announcement' }
            ], true);
        };

        window.editAnnouncement = async function(id) {
            try {
                const items = await fetchData(ENDPOINTS.ANNOUNCEMENTS);
                const item = items.find(x => x.id == id);

                if (!item) {
                    toastManager.show('Announcement not found', 'error');
                    return;
                }
            
                currentEditingId = id;
                openCreateModal('Edit Announcement', [
                    { type: 'text', id: 'title', placeholder: 'Title (Optional)', value: item.title || '' },
                    { type: 'textarea', id: 'content', placeholder: 'Content', required: true, value: item.content || '' },
                    { type: 'checkbox', id: 'highlight', label: 'Highlight this announcement', checked: item.highlight || false }
                ], true);
                
                if (item.file_name) {
                    const fileInfo = document.getElementById('modal-file-info');
                    const fileName = document.getElementById('modal-file-name');
                    if (fileInfo && fileName) {
                        fileInfo.style.display = 'flex';
                        fileName.textContent = item.file_name;
                    }
                }

            } catch (error) {
                console.error('Edit error:', error);
                toastManager.show('Failed to load announcement', 'error');
            }
        };        

        window.deleteAnnouncement = async function(id) {
            const confirmed = await showConfirm('Delete Announcement', 'Are you sure you want to delete this announcement?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.ANNOUNCEMENTS}/${id}`);
                toastManager.show('Announcement deleted successfully', 'success');
                await loadAnnouncements(currentSubTab);
            } catch (error) {
                toastManager.show('Failed to delete announcement', 'error');
            }
        };

        window.createAssignment = function() {
            currentEditingId = null;
            openCreateModal('Create Assignment', [
                { type: 'text', id: 'title', placeholder: 'Assignment Title', required: true },
                { type: 'textarea', id: 'description', placeholder: 'Description', required: true },
                { type: 'datetime-local', id: 'due_date', required: true },
                { type: 'select', id: 'topic_id', placeholder: 'Select Topic (Optional)', options: [] }
            ], true);
            
            fetchData(ENDPOINTS.TOPICS).then(topics => {
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Topic (Optional)</option>' + 
                        topics.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
                }
            });
        };

        window.editAssignment = async function(id) {
            try {
                const items = await fetchData(ENDPOINTS.ASSIGNMENTS);
                const item = items.find(x => x.id == id);
                if (!item) {
                    toastManager.show('Assignment not found', 'error');
                    return;
                }

                currentEditingId = id;
                const dueDate = item.due_date ? new Date(item.due_date).toISOString().slice(0, 16) : '';
                
                openCreateModal('Edit Assignment', [
                    { type: 'text', id: 'title', placeholder: 'Assignment Title', required: true, value: item.title || '' },
                    { type: 'textarea', id: 'description', placeholder: 'Description', required: true, value: item.description || '' },
                    { type: 'datetime-local', id: 'due_date', required: true, value: dueDate },
                    { type: 'select', id: 'topic_id', placeholder: 'Select Topic (Optional)', options: [], value: item.topic?.id || '' }
                ], true);

                const topics = await fetchData(ENDPOINTS.TOPICS);
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">* Select Topic</option>' + 
                        topics.map(t => `<option value="${t.id}" ${t.id == item.topic?.id ? 'selected' : ''}>${escapeHtml(t.name)}</option>`).join('');
                }
            } catch (error) {
                toastManager.show('Failed to load assignment', 'error');
            }
        };

        window.deleteAssignment = async function(id) {
            const confirmed = await showConfirm('Delete Assignment', 'Are you sure you want to delete this assignment?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.ASSIGNMENTS}/${id}`);
                toastManager.show('Assignment deleted successfully', 'success');
                await loadAssignments(currentSubTab);
            } catch (error) {
                toastManager.show('Failed to delete assignment', 'error');
            }
        };

        window.createTopic = function() {
            currentEditingId = null;
            openCreateModal('Create Unit', [
                { type: 'text', id: 'name', placeholder: 'Unit Name', required: true },
                { type: 'text', id: 'lecturer', placeholder: 'Lecturer Name', required: true },
                { type: 'text', id: 'contact', placeholder: 'Contact (Optional)' },
                { type: 'textarea', id: 'description', placeholder: 'Description (Optional)' }
            ]);
        };

        window.editTopic = async function(id) {
            try {
                const items = await fetchData(ENDPOINTS.TOPICS);
                const item = items.find(x => x.id == id);
                if (!item) {
                    toastManager.show('Topic not found', 'error');
                    return;
                }

                currentEditingId = id;
                openCreateModal('Edit Unit', [
                    { type: 'text', id: 'name', placeholder: 'Unit Name', required: true, value: item.name || '' },
                    { type: 'text', id: 'lecturer', placeholder: 'Lecturer Name', required: true, value: item.lecturer || '' },
                    { type: 'text', id: 'contact', placeholder: 'Contact (Optional)', value: item.contact || '' },
                    { type: 'textarea', id: 'description', placeholder: 'Description (Optional)', value: item.description || '' }
                ]);
            } catch (error) {
                toastManager.show('Failed to load topic', 'error');
            }
        };

        window.deleteTopic = async function(id) {
            const confirmed = await showConfirm('Delete Unit', 'Are you sure you want to delete this unit?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.TOPICS}/${id}`);
                toastManager.show('Unit deleted successfully', 'success');
                await loadTopics(currentSubTab);
            } catch (error) {
                toastManager.show('Failed to delete unit', 'error');
            }
        };

        window.createTimetable = function() {
            currentEditingId = null;
            openCreateModal('Create Timetable Slot', [
                { type: 'select', id: 'day_of_week', placeholder: 'Select Day', required: true,
                  options: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] },
                { type: 'time', id: 'start_time', required: true },
                { type: 'time', id: 'end_time', required: true },
                { type: 'text', id: 'subject', placeholder: 'Subject', required: true },
                { type: 'text', id: 'room', placeholder: 'Room (Optional)' },
                { type: 'text', id: 'teacher', placeholder: 'Teacher (Optional)' },
                { type: 'select', id: 'topic_id', placeholder: 'Select Topic (Optional)', options: [] }
            ]);

            fetchData(ENDPOINTS.TOPICS).then(topics => {
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Topic (Optional)</option>' + 
                        topics.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
                }
            });
        };

        window.editTimetableSlot = async function(id) {
            try {
                const raw = await fetchData(ENDPOINTS.TIMETABLE);
                let slots = [];
                if (Array.isArray(raw) && raw.length && raw[0].day && raw[0].slots) {
                    raw.forEach(d => {
                        d.slots.forEach(s => slots.push({ ...s, day: d.day }));
                    });
                } else if (Array.isArray(raw)) {
                    slots = raw;
                }
                
                const slot = slots.find(s => s.id == id);
                if (!slot) {
                    toastManager.show('Timetable slot not found', 'error');
                    return;
                }

                currentEditingId = id;
                openCreateModal('Edit Timetable Slot', [
                    { type: 'select', id: 'day_of_week', placeholder: 'Select Day', required: true,
                      options: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                      value: slot.day_of_week || slot.day || '' },
                    { type: 'time', id: 'start_time', required: true, value: slot.start_time || '' },
                    { type: 'time', id: 'end_time', required: true, value: slot.end_time || '' },
                    { type: 'text', id: 'subject', placeholder: 'Subject', required: true, value: slot.subject || '' },
                    { type: 'text', id: 'room', placeholder: 'Room (Optional)', value: slot.room || '' },
                    { type: 'text', id: 'teacher', placeholder: 'Teacher (Optional)', value: slot.teacher || '' },
                    { type: 'select', id: 'topic_id', placeholder: 'Select Topic (Optional)', options: [], value: slot.topic?.id || '' }
                ]);

                const topics = await fetchData(ENDPOINTS.TOPICS);
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Topic (Optional)</option>' + 
                        topics.map(t => `<option value="${t.id}" ${t.id == slot.topic?.id ? 'selected' : ''}>${escapeHtml(t.name)}</option>`).join('');
                }
            } catch (error) {
                toastManager.show('Failed to load timetable slot', 'error');
            }
        };

        window.deleteTimetableSlot = async function(id) {
            const confirmed = await showConfirm('Delete Timetable Slot', 'Are you sure you want to delete this slot?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.TIMETABLE}/${id}`);
                toastManager.show('Timetable slot deleted successfully', 'success');
                await loadTimetable(currentSubTab);
            } catch (error) {
                toastManager.show('Failed to delete timetable slot', 'error');
            }
        };

        window.downloadAssignmentFile = function(id) {
            window.open(`${ENDPOINTS.ASSIGNMENTS}/${id}/download`, '_blank');
        };

        window.filterContent = function() {
            toastManager.show('Filter feature coming soon', 'info');
        };

        window.searchContent = function() {
            toastManager.show('Search feature coming soon', 'info');
        };

        window.filterDueSoon = function() {
            switchSubTab('due-soon');
        };

        window.showStats = function() {
            toastManager.show('Statistics feature coming soon', 'info');
        };

        window.printTimetable = function() {
            window.print();
        };

        window.clearModalFile = function() {
            currentFile = null;
            document.getElementById('modal-file').value = '';
            document.getElementById('modal-file-info').style.display = 'none';
        };

        // ==================== Event Listeners ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();

            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
                isSidebarCollapsed = true;
            }

            await loadDashboard();
        });

        document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
        document.getElementById('menu-toggle').addEventListener('click', toggleMobileMenu);
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('mobile-open');
            }
        });
        
        document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchMainTab(item.dataset.tab);
            });
        });

        const logoutHandler = async () => {
            const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?');
            if (confirmed) {
                localStorage.removeItem('user');
                window.location.href = '/logout';
            }
        };

        document.getElementById('logout-btn').addEventListener('click', logoutHandler);
        document.getElementById('topbar-logout').addEventListener('click', logoutHandler);
        document.getElementById('confirm-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(false);
                confirmResolver = null;
            }
        });

        document.getElementById('confirm-ok').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(true);
                confirmResolver = null;
            }
        });

        document.getElementById('modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
        
            const submitBtn = document.getElementById('modal-submit');
            const originalText = submitBtn.innerHTML;
            const title = document.getElementById('modal-title').textContent;
            const type = title.includes('Announcement') ? 'announcement' :
                         title.includes('Assignment') ? 'assignment' :
                         title.includes('Unit') ? 'topic' : 'timetable';
        
            // Create ripple effect on click
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            const rect = submitBtn.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
            submitBtn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);

            submitBtn.classList.add('saving');
            submitBtn.classList.remove('success', 'error');
            submitBtn.innerHTML = '<i class="fas fa-spinner"></i> Saving...';
            submitBtn.disabled = true;
        
            try {
                let result;
                const endpoint = type === 'timetable' ? ENDPOINTS.TIMETABLE : ENDPOINTS[type.toUpperCase() + 'S'];
            
                // Check if this type needs FormData (only announcements and assignments)
                const needsFormData = type === 'announcement' || type === 'assignment';
            
                if (needsFormData) {
                    const formData = new FormData();
                    const fields = document.querySelectorAll('#modal-fields input, #modal-fields textarea, #modal-fields select');

                    fields.forEach(field => {
                        const id = field.id.replace('modal-', '');
                        if (field.type === 'checkbox') {
                            formData.append(id, field.checked);
                        } else if (field.type === 'datetime-local' || field.type === 'time') {
                            formData.append(id, field.value);
                        } else {
                            formData.append(id, field.value);
                        }
                    });
                
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    formData.append('year', user.year || 1);
                
                    if (currentFile) {
                        formData.append('file', currentFile);
                    }
                
                    if (currentEditingId) {
                        const response = await fetch(`${endpoint}/${currentEditingId}`, {
                            method: 'PUT',
                            body: formData
                        });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        result = await response.json();
                    } else {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        result = await response.json();
                    }
                } else {
                    const data = {};
                    const fields = document.querySelectorAll('#modal-fields input, #modal-fields textarea, #modal-fields select');

                    fields.forEach(field => {
                        const id = field.id.replace('modal-', '');
                        if (field.type === 'checkbox') {
                            data[id] = field.checked;
                        } else if (field.type === 'datetime-local' || field.type === 'time') {
                            data[id] = field.value;
                        } else {
                            data[id] = field.value;
                        }
                    });
                
                    if (type === 'topic') {
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        data.year = user.year || 1;
                    }
                
                    if (currentEditingId) {
                        result = await sendData(`${endpoint}/${currentEditingId}`, data, 'PUT');
                    } else {
                        result = await sendData(endpoint, data, 'POST');
                    }
                }
            
                // Show success state
                submitBtn.classList.remove('saving');
                submitBtn.classList.add('success');
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
            
                setTimeout(() => {
                    closeCreateModal();
                    toastManager.show(`${title} ${currentEditingId ? 'updated' : 'created'} successfully`, 'success');
                }, 800);
            
                setTimeout(() => {
                    submitBtn.disabled = false;
                    loadTabContent(currentMainTab, currentSubTab);
                }, 1000);
            
            } catch (err) {
                console.error('Save error:', err);
            
                // Show error state
                submitBtn.classList.remove('saving');
                submitBtn.classList.add('error');
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed!';
            
                // Show error message
                toastManager.show(`Error saving ${title.toLowerCase()}`, 'error');
            
                setTimeout(() => {
                    submitBtn.classList.remove('error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 2000);
            }
        });        

        document.getElementById('modal-file').addEventListener('change', (e) => {
            currentFile = e.target.files[0];
            if (currentFile) {
                document.getElementById('modal-file-info').style.display = 'flex';
                document.getElementById('modal-file-name').textContent = currentFile.name;
            }
        });

        document.getElementById('clear-modal-file').addEventListener('click', () => {
            currentFile = null;
            document.getElementById('modal-file').value = '';
            document.getElementById('modal-file-info').style.display = 'none';
        });

        document.getElementById('cancel-modal').addEventListener('click', closeCreateModal);
        document.getElementById('create-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('create-modal')) {
                closeCreateModal();
            }
        });

        document.getElementById('image-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('image-modal')) {
                e.target.classList.remove('show');
            }
        });

        // Escape key handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('create-modal').classList.remove('show');
                document.getElementById('image-modal').classList.remove('show');
                document.getElementById('confirm-modal').classList.remove('show');
            }
        });

        const modal = document.getElementById('create-modal');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    if (modal.classList.contains('show')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    </script>
</body>
</html>