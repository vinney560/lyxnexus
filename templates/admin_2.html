<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyxNexus | Admin Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/_0eXv3/tailwind.all.css"></script>
    <script src="/_0eXv4/n-s.js"></script>
    <script src="/_0eXv4/loading.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #818cf8;
        --secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #0f172a;
        --darker: #020617;
        --light: #f8fafc;
        --gray: #94a3b8;
        --card-bg: rgba(30, 41, 59, 0.8);
        --border: rgba(99, 102, 241, 0.2);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
        color: var(--light);
        min-height: 100vh;
        overflow: hidden;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.3);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }

    /* Layout */
    .app-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background: rgba(2, 6, 23, 0.8);
        backdrop-filter: blur(10px);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
    }

    .logo-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
    }

    .logo-text {
        font-weight: 700;
        font-size: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
    }

    .logo-badge {
        font-size: 12px;
        background: rgba(99, 102, 241, 0.2);
        padding: 2px 8px;
        border-radius: 20px;
        color: var(--primary-light);
        margin-top: 2px;
        display: inline-block;
    }

    /* Navigation */
    .nav-section {
        padding: 20px;
        flex: 1;
    }

    .nav-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--gray);
        margin-bottom: 12px;
        font-weight: 600;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        color: var(--gray);
        transition: all 0.2s ease;
        margin-bottom: 4px;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .nav-item:hover {
        background: rgba(99, 102, 241, 0.1);
        color: var(--light);
        border-color: var(--border);
    }

    .nav-item.active {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
        color: var(--light);
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .nav-item i {
        width: 20px;
        font-size: 16px;
    }

    /* Main Content */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: rgba(15, 23, 42, 0.4);
    }

    /* Top Bar */
    .top-bar {
        background: rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(10px);
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .page-title {
        font-size: 20px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
    }

    /* Content Area */
    .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
    }

    .action-btn {
        padding: 10px 20px;
        border-radius: 100px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid var(--border);
        color: var(--light);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .action-btn:hover {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
    }

    .action-btn i {
        font-size: 14px;
    }

    /* Sub Tabs */
    .sub-tabs {
        display: flex;
        gap: 8px;
        padding: 4px;
        background: rgba(2, 6, 23, 0.4);
        border-radius: 100px;
        margin-bottom: 24px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .sub-tabs::-webkit-scrollbar {
        display: none;
    }

    .sub-tab {
        padding: 10px 24px;
        border-radius: 100px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gray);
        transition: all 0.2s ease;
        white-space: nowrap;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .sub-tab:hover {
        color: var(--light);
        background: rgba(99, 102, 241, 0.1);
    }

    .sub-tab.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* Cards Grid */
    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
    }

    .card:hover {
        transform: translateY(-4px);
        border-color: var(--primary);
        box-shadow: 0 20px 30px -10px rgba(99, 102, 241, 0.2);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .card-title {
        font-weight: 600;
        font-size: 16px;
        color: var(--light);
    }

    .card-subtitle {
        font-size: 12px;
        color: var(--gray);
        margin-top: 4px;
    }

    .card-body {
        padding: 16px 20px;
    }

    .card-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    /* Year Badges */
    .year-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 12px;
        font-weight: 600;
        gap: 6px;
    }

    .year-badge.all { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .year-badge.year1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .year-badge.year2 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .year-badge.year3 { background: linear-gradient(135deg, #10b981, #059669); }
    .year-badge.year4 { background: linear-gradient(135deg, #f59e0b, #d97706); }

    /* Buttons */
    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--gray);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-icon:hover {
        background: var(--primary);
        color: white;
        border-color: transparent;
    }

    .btn-sm {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s ease;
    }

    .btn-sm.primary {
        background: var(--primary);
        color: white;
    }

    .btn-sm.primary:hover {
        background: var(--primary-dark);
    }

    .btn-sm.warning {
        background: var(--warning);
        color: white;
    }

    .btn-sm.danger {
        background: var(--danger);
        color: white;
    }

    /* Custom Confirm Modal */
    .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
    }

    .confirm-modal.show {
        display: flex;
    }

    .confirm-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .confirm-icon {
        width: 56px;
        height: 56px;
        background: rgba(239, 68, 68, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: var(--danger);
        font-size: 24px;
    }

    .confirm-title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
    }

    .confirm-message {
        text-align: center;
        color: var(--gray);
        font-size: 14px;
        margin-bottom: 20px;
    }

    .confirm-actions {
        display: flex;
        gap: 12px;
    }

    .confirm-btn {
        flex: 1;
        padding: 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
    }

    .confirm-btn.cancel {
        background: rgba(255, 255, 255, 0.05);
        color: var(--gray);
        border: 1px solid var(--border);
    }

    .confirm-btn.cancel:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
    }

    .confirm-btn.confirm {
        background: var(--danger);
        color: white;
    }

    .confirm-btn.confirm:hover {
        background: #dc2626;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--primary); }

    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
    }

    .empty-state i {
        font-size: 48px;
        color: var(--gray);
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--gray);
        font-size: 14px;
        max-width: 300px;
        margin: 0 auto 20px;
    }

    /* File Attachment */
    .attachment-preview {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        margin-top: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .attachment-preview:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    .attachment-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            left: -280px;
            height: 100vh;
            z-index: 100;
        }

        .sidebar.open {
            left: 0;
        }

        .content-grid {
            grid-template-columns: 1fr;
        }

        .sub-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
        }
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--light);
        font-size: 14px;
        margin-bottom: 16px;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .file-input-label {
        display: block;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px dashed var(--border);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .file-input-label:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    /* Loading Overlay */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(2, 6, 23, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
</style>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Custom Confirm Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-title" id="confirm-title">Confirm Action</h3>
            <p class="confirm-message" id="confirm-message">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" id="confirm-cancel">Cancel</button>
                <button class="confirm-btn confirm" id="confirm-ok">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal" id="image-modal">
        <div class="modal-content" style="max-width: 800px; background: transparent; border: none; padding: 0;">
            <img id="modal-image" src="" style="width: 100%; border-radius: 16px;" alt="Preview">
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-wrapper">
                    <div class="logo-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <div class="logo-text">LyxNexus</div>
                        <span class="logo-badge">Admin Portal</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" onclick="switchMainTab('dashboard')">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchMainTab('announcements')">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </div>
                <div class="nav-item" onclick="switchMainTab('assignments')">
                    <i class="fas fa-tasks"></i>
                    <span>Assignments</span>
                </div>
                <div class="nav-item" onclick="switchMainTab('topics')">
                    <i class="fas fa-folder"></i>
                    <span>Units</span>
                </div>
                <div class="nav-item" onclick="switchMainTab('timetable')">
                    <i class="fas fa-calendar"></i>
                    <span>Timetable</span>
                </div>

                <div class="nav-label" style="margin-top: 20px;">Quick Access</div>
                <div class="nav-item" onclick="window.location.href='/files'">
                    <i class="fas fa-file"></i>
                    <span>Files</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/store'">
                    <i class="fas fa-archive"></i>
                    <span>Archives</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/past-papers'">
                    <i class="fas fa-scroll"></i>
                    <span>Papers</span>
                </div>

                <div class="nav-label" style="margin-top: 20px;">Admin</div>
                <div class="nav-item" onclick="window.location.href='/admin/users'">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/secret-code'">
                    <i class="fas fa-shield"></i>
                    <span>Secret Code</span>
                </div>
                <div class="nav-item" onclick="window.location.href='/admin/clone-db'">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <button class="btn-icon" id="menu-toggle" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="user-menu">
                    <button class="btn-icon" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <div class="user-avatar" id="user-avatar">A</div>
                </div>
            </div>

            <!-- Content Area with Scroll -->
            <div class="content-area" id="content-area">
                <!-- Quick Actions -->
                <div class="quick-actions" id="quick-actions">
                    <!-- Dynamically filled -->
                </div>

                <!-- Sub Tabs -->
                <div class="sub-tabs" id="sub-tabs">
                    <!-- Dynamically filled -->
                </div>

                <!-- Content Grid -->
                <div id="content-container" class="content-grid">
                    <div class="loading-container" style="grid-column: 1/-1; text-align: center; padding: 60px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Modal (Universal) -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Create New</h3>
            <form id="modal-form">
                <input type="hidden" id="modal-id">
                <div id="modal-fields"></div>
                
                <!-- File Upload Section (for announcements/assignments) -->
                <div id="modal-file-section" style="display: none;">
                    <div class="file-input-wrapper">
                        <input type="file" id="modal-file" style="display: none;">
                        <label for="modal-file" class="file-input-label">
                            <i class="fas fa-upload mr-2"></i>Attach File
                        </label>
                    </div>
                    <div id="modal-file-info" class="file-info" style="display: none; margin-top: 12px;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" class="btn-sm cancel" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn-sm primary" id="modal-submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== Configuration ====================
        const API_BASE = '/api';
        const ENDPOINTS = {
            ANNOUNCEMENTS: `${API_BASE}/announcements`,
            ASSIGNMENTS: `${API_BASE}/assignments`,
            TIMETABLE: `${API_BASE}/timetable`,
            TOPICS: `${API_BASE}/topics`,
            FILES: `${API_BASE}/files`,
            USERS: `${API_BASE}/users`
        };

        // ==================== State Management ====================
        let currentMainTab = 'dashboard';
        let currentSubTab = 'announcements';
        let currentEditingId = null;
        let currentFile = null;
        let toastManager;
        let confirmResolver = null;

        // ==================== Custom Confirm ====================
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                confirmResolver = resolve;
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-modal').classList.add('show');
            });
        }

        document.getElementById('confirm-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(false);
                confirmResolver = null;
            }
        });

        document.getElementById('confirm-ok').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(true);
                confirmResolver = null;
            }
        });

        // ==================== Toast System ====================
        class ToastManager {
            constructor() {
                this.container = document.getElementById('toast-container');
            }

            show(message, type = 'info', title = null) {
                const titles = { success: 'Success', error: 'Error', info: 'Information' };
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icon = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                }[type];

                toast.innerHTML = `
                    <i class="fas ${icon}" style="color: var(--${type});"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${title || titles[type]}</div>
                        <div style="font-size: 13px; color: var(--gray);">${message}</div>
                    </div>
                `;

                this.container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        }

        toastManager = new ToastManager();

        // ==================== Utility Functions ====================
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const d = new Date(dateString);
                return d.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch {
                return dateString;
            }
        }

        function getFileIcon(filename) {
            if (!filename) return 'fa-file';
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
                txt: 'fa-file-alt', zip: 'fa-file-archive', jpg: 'fa-file-image',
                jpeg: 'fa-file-image', png: 'fa-file-image', gif: 'fa-file-image'
            };
            return icons[ext] || 'fa-file';
        }

        function isImageFile(filename) {
            if (!filename) return false;
            return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(filename.split('.').pop().toLowerCase());
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 KB';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ==================== API Functions ====================
        async function fetchData(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Fetch error:', err);
                return [];
            }
        }

        async function sendData(url, data, method = 'POST') {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function deleteData(url) {
            const res = await fetch(url, { method: 'DELETE' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function uploadFile(endpoint, file, id) {
            const fd = new FormData();
            fd.append('file', file);
            const res = await fetch(`${endpoint}/${id}/upload`, { method: 'POST', body: fd });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        // ==================== Tab Management ====================
        function switchMainTab(tab) {
            currentMainTab = tab;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('page-title').textContent = 
                tab.charAt(0).toUpperCase() + tab.slice(1);
            
            updateQuickActions(tab);
            updateSubTabs(tab);
            loadTabContent(tab, currentSubTab);
        }

        function updateQuickActions(tab) {
            const actions = {
                announcements: [{ icon: 'fa-plus', text: 'New Announcement', action: 'createAnnouncement' }],
                assignments: [{ icon: 'fa-plus', text: 'New Assignment', action: 'createAssignment' }],
                topics: [{ icon: 'fa-plus', text: 'New Unit', action: 'createTopic' }],
                timetable: [{ icon: 'fa-plus', text: 'New Slot', action: 'createTimetable' }],
                dashboard: [
                    { icon: 'fa-bullhorn', text: 'Announcements', action: 'switchMainTab:announcements' },
                    { icon: 'fa-tasks', text: 'Assignments', action: 'switchMainTab:assignments' },
                    { icon: 'fa-folder', text: 'Units', action: 'switchMainTab:topics' }
                ]
            };

            const container = document.getElementById('quick-actions');
            container.innerHTML = (actions[tab] || []).map(action => `
                <button class="action-btn" onclick="${action.action.includes(':') ? 
                    `switchMainTab('${action.action.split(':')[1]}')` : 
                    `${action.action}()`}">
                    <i class="fas ${action.icon}"></i>
                    <span>${action.text}</span>
                </button>
            `).join('');
        }

        function updateSubTabs(mainTab) {
            const subTabs = {
                announcements: [
                    { id: 'announcements', name: 'All Announcements' },
                    { id: 'my-announcements', name: 'My Announcements' }
                ],
                assignments: [
                    { id: 'assignments', name: 'All Assignments' },
                    { id: 'due-soon', name: 'Due Soon' },
                    { id: 'completed', name: 'Completed' }
                ],
                topics: [
                    { id: 'topics', name: 'All Units' },
                    { id: 'my-topics', name: 'My Units' }
                ],
                timetable: [
                    { id: 'timetable', name: 'Weekly View' },
                    { id: 'today', name: 'Today' }
                ],
                dashboard: []
            };

            const tabs = subTabs[mainTab] || [];
            const container = document.getElementById('sub-tabs');
            
            if (tabs.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = tabs.map(tab => `
                <button class="sub-tab ${tab.id === currentSubTab ? 'active' : ''}" 
                        onclick="switchSubTab('${tab.id}')">
                    ${tab.name}
                </button>
            `).join('');
        }

        function switchSubTab(subTab) {
            currentSubTab = subTab;
            document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            loadTabContent(currentMainTab, subTab);
        }

        // ==================== Content Loading ====================
        async function loadTabContent(mainTab, subTab) {
            const container = document.getElementById('content-container');
            
            // Show loading
            container.innerHTML = `
                <div class="loading-container" style="grid-column: 1/-1; text-align: center; padding: 60px;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            `;

            switch(mainTab) {
                case 'announcements':
                    await loadAnnouncements(subTab);
                    break;
                case 'assignments':
                    await loadAssignments(subTab);
                    break;
                case 'topics':
                    await loadTopics(subTab);
                    break;
                case 'timetable':
                    await loadTimetable(subTab);
                    break;
                case 'dashboard':
                    await loadDashboard();
                    break;
            }
        }

        async function loadAnnouncements(filter = 'announcements') {
            const items = await fetchData(ENDPOINTS.ANNOUNCEMENTS);
            const container = document.getElementById('content-container');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-bullhorn"></i>
                        <h3>No Announcements</h3>
                        <p>Create your first announcement to get started</p>
                        <button class="btn-sm primary" onclick="createAnnouncement()">
                            <i class="fas fa-plus mr-1"></i> Create Announcement
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${escapeHtml(item.title || 'Untitled')}</h3>
                            <div class="card-subtitle">
                                <span class="year-badge ${item.author?.year == 5 ? 'all' : `year${item.author?.year || 1}`}">
                                    <i class="fas fa-graduation-cap"></i>
                                    ${item.author?.year == 5 ? 'All Years' : `Year ${item.author?.year || 1}`}
                                </span>
                                <span style="margin-left: 8px;">
                                    <i class="fas fa-user"></i> ${escapeHtml(item.author?.username || 'Unknown')}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn-icon" onclick="editAnnouncement(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteAnnouncement(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray); line-height: 1.6;">${escapeHtml(item.content)}</p>
                        
                        ${item.file_name ? `
                            <div class="attachment-preview" onclick="window.open('/announcement-file/${item.id}/${encodeURIComponent(item.file_name)}', '_blank')">
                                <div class="attachment-icon">
                                    <i class="fas ${getFileIcon(item.file_name)}"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${escapeHtml(item.file_name)}</div>
                                    <div style="font-size: 12px; color: var(--gray);">Click to download</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="card-footer">
                        <span style="color: var(--gray); font-size: 12px;">
                            <i class="fas fa-clock"></i> ${formatDate(item.created_at)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        async function loadAssignments(filter = 'assignments') {
            const items = await fetchData(ENDPOINTS.ASSIGNMENTS);
            const container = document.getElementById('content-container');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-tasks"></i>
                        <h3>No Assignments</h3>
                        <p>Create your first assignment to get started</p>
                        <button class="btn-sm primary" onclick="createAssignment()">
                            <i class="fas fa-plus mr-1"></i> Create Assignment
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => {
                const due = new Date(item.due_date);
                const now = new Date();
                const isOverdue = due < now;
                const timeLeft = Math.ceil((due - now) / (1000 * 60 * 60 * 24));

                return `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">${escapeHtml(item.title)}</h3>
                                <div class="card-subtitle">
                                    <span class="year-badge ${item.creator?.year == 5 ? 'all' : `year${item.creator?.year || 1}`}">
                                        <i class="fas fa-graduation-cap"></i>
                                        ${item.creator?.year == 5 ? 'All Years' : `Year ${item.creator?.year || 1}`}
                                    </span>
                                    ${item.topic?.name ? `
                                        <span style="margin-left: 8px;">
                                            <i class="fas fa-folder"></i> ${escapeHtml(item.topic.name)}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn-icon" onclick="editAssignment(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteAssignment(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--gray); margin-bottom: 12px;">${escapeHtml(item.description)}</p>
                            
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--success)'}; font-weight: 500;">
                                        <i class="fas ${isOverdue ? 'fa-exclamation-circle' : 'fa-clock'}"></i>
                                        Due: ${formatDate(item.due_date)}
                                    </span>
                                    ${!isOverdue ? `
                                        <span style="color: var(--gray); font-size: 12px;">
                                            ${timeLeft} day${timeLeft !== 1 ? 's' : ''} left
                                        </span>
                                    ` : ''}
                                </div>
                            </div>

                            ${item.file_name ? `
                                <div class="attachment-preview" onclick="downloadAssignmentFile(${item.id})">
                                    <div class="attachment-icon">
                                        <i class="fas ${getFileIcon(item.file_name)}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${escapeHtml(item.file_name)}</div>
                                        <div style="font-size: 12px; color: var(--gray);">Click to download</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadTopics(filter = 'topics') {
            const items = await fetchData(ENDPOINTS.TOPICS);
            const container = document.getElementById('content-container');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-folder"></i>
                        <h3>No Units</h3>
                        <p>Create your first unit to get started</p>
                        <button class="btn-sm primary" onclick="createTopic()">
                            <i class="fas fa-plus mr-1"></i> Create Unit
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${escapeHtml(item.name)}</h3>
                            <div class="card-subtitle">
                                <span class="year-badge ${item.year == 5 ? 'all' : `year${item.year || 1}`}">
                                    <i class="fas fa-graduation-cap"></i>
                                    ${item.year == 5 ? 'All Years' : `Year ${item.year || 1}`}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn-icon" onclick="window.location.href='/material/${item.id}'">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="btn-icon" onclick="editTopic(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteTopic(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray); margin-bottom: 12px;">${escapeHtml(item.description || 'No description')}</p>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span><i class="fas fa-chalkboard-teacher"></i> ${escapeHtml(item.lecturer || 'TBA')}</span>
                                ${item.contact ? `
                                    <span><i class="fas fa-phone"></i> ${escapeHtml(item.contact)}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadTimetable(filter = 'timetable') {
            const raw = await fetchData(ENDPOINTS.TIMETABLE);
            const container = document.getElementById('content-container');

            let slots = [];
            if (Array.isArray(raw) && raw.length && raw[0].day && raw[0].slots) {
                raw.forEach(d => {
                    d.slots.forEach(s => slots.push({ ...s, day: d.day }));
                });
            } else if (Array.isArray(raw)) {
                slots = raw;
            }

            if (!slots || slots.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-calendar"></i>
                        <h3>No Timetable</h3>
                        <p>Create your first timetable slot</p>
                        <button class="btn-sm primary" onclick="createTimetable()">
                            <i class="fas fa-plus mr-1"></i> Add Slot
                        </button>
                    </div>
                `;
                return;
            }

            const grouped = slots.reduce((acc, slot) => {
                const day = slot.day_of_week || slot.day || 'Unsorted';
                if (!acc[day]) acc[day] = [];
                acc[day].push(slot);
                return acc;
            }, {});

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            container.innerHTML = days.map(day => {
                if (!grouped[day] || grouped[day].length === 0) return '';
                
                return `
                    <div class="card" style="grid-column: 1/-1;">
                        <div class="card-header">
                            <h3 class="card-title">${day}</h3>
                        </div>
                        <div class="card-body">
                            ${grouped[day].map(slot => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-weight: 500;">${escapeHtml(slot.subject)}</div>
                                        <div style="font-size: 13px; color: var(--gray);">
                                            <span>${escapeHtml(slot.start_time)} - ${escapeHtml(slot.end_time)}</span>
                                            <span style="margin: 0 8px;"></span>
                                            <span>${escapeHtml(slot.teacher || 'TBA')}</span>
                                            <span style="margin: 0 8px;"></span>
                                            <span>${escapeHtml(slot.room || 'TBA')}</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn-icon" onclick="editTimetableSlot(${slot.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon" onclick="deleteTimetableSlot(${slot.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');
        }

        async function loadDashboard() {
            const [announcements, assignments, topics] = await Promise.all([
                fetchData(ENDPOINTS.ANNOUNCEMENTS),
                fetchData(ENDPOINTS.ASSIGNMENTS),
                fetchData(ENDPOINTS.TOPICS)
            ]);

            const container = document.getElementById('content-container');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Announcements</h3>
                        <button class="btn-icon" onclick="switchMainTab('announcements')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${(announcements || []).slice(0, 3).map(a => `
                            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                <div style="font-weight: 500;">${escapeHtml(a.title || 'Untitled')}</div>
                                <div style="font-size: 12px; color: var(--gray);">${formatDate(a.created_at)}</div>
                            </div>
                        `).join('') || '<p style="color: var(--gray);">No announcements</p>'}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Upcoming Assignments</h3>
                        <button class="btn-icon" onclick="switchMainTab('assignments')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${(assignments || []).slice(0, 3).map(a => `
                            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                <div style="font-weight: 500;">${escapeHtml(a.title)}</div>
                                <div style="font-size: 12px; color: var(--gray);">Due: ${formatDate(a.due_date)}</div>
                            </div>
                        `).join('') || '<p style="color: var(--gray);">No assignments</p>'}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Units Overview</h3>
                        <button class="btn-icon" onclick="switchMainTab('topics')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        ${(topics || []).slice(0, 3).map(t => `
                            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                <div style="font-weight: 500;">${escapeHtml(t.name)}</div>
                                <div style="font-size: 12px; color: var(--gray);">${escapeHtml(t.lecturer || 'TBA')}</div>
                            </div>
                        `).join('') || '<p style="color: var(--gray);">No units</p>'}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Stats</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${announcements?.length || 0}</div>
                                <div style="font-size: 12px; color: var(--gray);">Announcements</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary);">${assignments?.length || 0}</div>
                                <div style="font-size: 12px; color: var(--gray);">Assignments</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);">${topics?.length || 0}</div>
                                <div style="font-size: 12px; color: var(--gray);">Units</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${(await fetchData(ENDPOINTS.USERS))?.length || 0}</div>
                                <div style="font-size: 12px; color: var(--gray);">Users</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== CRUD Operations ====================
        function createAnnouncement() {
            openCreateModal('announcement', 'Create Announcement', [
                { type: 'text', id: 'title', placeholder: 'Title (Optional)' },
                { type: 'textarea', id: 'content', placeholder: 'Content', required: true },
                { type: 'checkbox', id: 'highlight', label: 'Highlight' }
            ], true);
        }

        function createAssignment() {
            openCreateModal('assignment', 'Create Assignment', [
                { type: 'text', id: 'title', placeholder: 'Title', required: true },
                { type: 'textarea', id: 'description', placeholder: 'Description', required: true },
                { type: 'datetime-local', id: 'due_date', required: true },
                { type: 'select', id: 'topic_id', placeholder: 'Select Topic', options: [] }
            ], true);
            
            // Load topics for dropdown
            fetchData(ENDPOINTS.TOPICS).then(topics => {
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Topic</option>' + 
                        topics.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
                }
            });
        }

        function createTopic() {
            openCreateModal('topic', 'Create Unit', [
                { type: 'text', id: 'name', placeholder: 'Unit Name', required: true },
                { type: 'text', id: 'lecturer', placeholder: 'Lecturer', required: true },
                { type: 'text', id: 'contact', placeholder: 'Contact (Optional)' },
                { type: 'textarea', id: 'description', placeholder: 'Description (Optional)' }
            ]);
        }

        function createTimetable() {
            openCreateModal('timetable', 'Create Timetable Slot', [
                { type: 'select', id: 'day_of_week', placeholder: 'Select Day', required: true,
                  options: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] },
                { type: 'time', id: 'start_time', required: true },
                { type: 'time', id: 'end_time', required: true },
                { type: 'text', id: 'subject', placeholder: 'Subject', required: true },
                { type: 'text', id: 'room', placeholder: 'Room (Optional)' },
                { type: 'text', id: 'teacher', placeholder: 'Teacher (Optional)' },
                { type: 'select', id: 'topic_id', placeholder: 'Select Topic', options: [] }
            ]);

            fetchData(ENDPOINTS.TOPICS).then(topics => {
                const select = document.getElementById('modal-topic_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Topic</option>' + 
                        topics.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
                }
            });
        }

        function openCreateModal(type, title, fields, hasFile = false) {
            const modal = document.getElementById('create-modal');
            document.getElementById('modal-title').textContent = title;
            
            const fieldsHtml = fields.map(field => {
                if (field.type === 'textarea') {
                    return `<textarea class="form-input" id="modal-${field.id}" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}></textarea>`;
                } else if (field.type === 'checkbox') {
                    return `<label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <input type="checkbox" id="modal-${field.id}">
                        <span>${field.label}</span>
                    </label>`;
                } else if (field.type === 'select') {
                    const options = field.options || [];
                    return `<select class="form-input" id="modal-${field.id}" ${field.required ? 'required' : ''}>
                        <option value="">${field.placeholder}</option>
                        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>`;
                } else {
                    return `<input type="${field.type}" class="form-input" id="modal-${field.id}" 
                        placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>`;
                }
            }).join('');

            document.getElementById('modal-fields').innerHTML = fieldsHtml;
            document.getElementById('modal-file-section').style.display = hasFile ? 'block' : 'none';
            document.getElementById('modal-id').value = '';
            
            modal.classList.add('show');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('show');
            currentEditingId = null;
            currentFile = null;
        }

        // Modal Form Submit
        document.getElementById('modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('modal-title').textContent.includes('Announcement') ? 'announcement' :
                         document.getElementById('modal-title').textContent.includes('Assignment') ? 'assignment' :
                         document.getElementById('modal-title').textContent.includes('Unit') ? 'topic' : 'timetable';

            const data = {};
            const fields = document.querySelectorAll('#modal-fields input, #modal-fields textarea, #modal-fields select');
            fields.forEach(field => {
                const id = field.id.replace('modal-', '');
                if (field.type === 'checkbox') {
                    data[id] = field.checked;
                } else {
                    data[id] = field.value;
                }
            });

            try {
                let result;
                if (currentEditingId) {
                    result = await sendData(`${ENDPOINTS[type.toUpperCase()]}${type === 'timetable' ? '' : 'S'}/${currentEditingId}`, data, 'PUT');
                    toastManager.show(`${type} updated successfully`, 'success');
                } else {
                    result = await sendData(ENDPOINTS[type.toUpperCase()] + (type === 'timetable' ? '' : 'S'), data, 'POST');
                    toastManager.show(`${type} created successfully`, 'success');
                }

                if (currentFile && result.id) {
                    await uploadFile(ENDPOINTS[type.toUpperCase() + 'S'], currentFile, result.id);
                }

                closeCreateModal();
                loadTabContent(currentMainTab, currentSubTab);
            } catch (err) {
                toastManager.show(`Error saving ${type}`, 'error');
            }
        });

        // File input handling
        document.getElementById('modal-file')?.addEventListener('change', (e) => {
            currentFile = e.target.files[0];
            if (currentFile) {
                document.getElementById('modal-file-info').style.display = 'block';
                document.getElementById('modal-file-info').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-file"></i>
                        <span>${currentFile.name}</span>
                        <button type="button" class="btn-icon" onclick="document.getElementById('modal-file').value=''; this.parentElement.style.display='none';">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
        });

        // Edit functions
        async function editAnnouncement(id) {
            const items = await fetchData(ENDPOINTS.ANNOUNCEMENTS);
            const item = items.find(x => x.id == id);
            if (!item) return;

            createAnnouncement();
            document.getElementById('modal-id').value = item.id;
            document.getElementById('modal-title').value = item.title || '';
            document.getElementById('modal-content').value = item.content || '';
            document.getElementById('modal-highlight').checked = item.highlight || false;
            currentEditingId = id;
        }

        async function editAssignment(id) {
            const items = await fetchData(ENDPOINTS.ASSIGNMENTS);
            const item = items.find(x => x.id == id);
            if (!item) return;

            createAssignment();
            document.getElementById('modal-id').value = item.id;
            document.getElementById('modal-title').value = item.title || '';
            document.getElementById('modal-description').value = item.description || '';
            document.getElementById('modal-due_date').value = item.due_date ? new Date(item.due_date).toISOString().slice(0,16) : '';
            document.getElementById('modal-topic_id').value = item.topic?.id || '';
            currentEditingId = id;
        }

        async function editTopic(id) {
            const items = await fetchData(ENDPOINTS.TOPICS);
            const item = items.find(x => x.id == id);
            if (!item) return;

            createTopic();
            document.getElementById('modal-id').value = item.id;
            document.getElementById('modal-name').value = item.name || '';
            document.getElementById('modal-lecturer').value = item.lecturer || '';
            document.getElementById('modal-contact').value = item.contact || '';
            document.getElementById('modal-description').value = item.description || '';
            currentEditingId = id;
        }

        async function editTimetableSlot(id) {
            const raw = await fetchData(ENDPOINTS.TIMETABLE);
            let slots = [];
            if (Array.isArray(raw) && raw.length && raw[0].day && raw[0].slots) {
                raw.forEach(d => {
                    d.slots.forEach(s => slots.push({ ...s, day: d.day }));
                });
            } else if (Array.isArray(raw)) {
                slots = raw;
            }
            
            const slot = slots.find(s => s.id == id);
            if (!slot) return;

            createTimetable();
            document.getElementById('modal-id').value = slot.id;
            document.getElementById('modal-day_of_week').value = slot.day_of_week || slot.day || '';
            document.getElementById('modal-start_time').value = slot.start_time || '';
            document.getElementById('modal-end_time').value = slot.end_time || '';
            document.getElementById('modal-subject').value = slot.subject || '';
            document.getElementById('modal-room').value = slot.room || '';
            document.getElementById('modal-teacher').value = slot.teacher || '';
            document.getElementById('modal-topic_id').value = slot.topic?.id || '';
            currentEditingId = id;
        }

        // Delete functions with custom confirm
        async function deleteAnnouncement(id) {
            const confirmed = await showConfirm('Delete Announcement', 'Are you sure you want to delete this announcement? This action cannot be undone.');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.ANNOUNCEMENTS}/${id}`);
                toastManager.show('Announcement deleted', 'success');
                loadAnnouncements(currentSubTab);
            } catch {
                toastManager.show('Failed to delete announcement', 'error');
            }
        }

        async function deleteAssignment(id) {
            const confirmed = await showConfirm('Delete Assignment', 'Are you sure you want to delete this assignment?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.ASSIGNMENTS}/${id}`);
                toastManager.show('Assignment deleted', 'success');
                loadAssignments(currentSubTab);
            } catch {
                toastManager.show('Failed to delete assignment', 'error');
            }
        }

        async function deleteTopic(id) {
            const confirmed = await showConfirm('Delete Unit', 'Are you sure you want to delete this unit?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.TOPICS}/${id}`);
                toastManager.show('Unit deleted', 'success');
                loadTopics(currentSubTab);
            } catch {
                toastManager.show('Failed to delete unit', 'error');
            }
        }

        async function deleteTimetableSlot(id) {
            const confirmed = await showConfirm('Delete Slot', 'Are you sure you want to delete this timetable slot?');
            if (!confirmed) return;

            try {
                await deleteData(`${ENDPOINTS.TIMETABLE}/${id}`);
                toastManager.show('Slot deleted', 'success');
                loadTimetable(currentSubTab);
            } catch {
                toastManager.show('Failed to delete slot', 'error');
            }
        }

        function downloadAssignmentFile(id) {
            window.open(`${ENDPOINTS.ASSIGNMENTS}/${id}/download`, '_blank');
        }

        // ==================== Logout ====================
        async function logout() {
            const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?');
            if (confirmed) {
                window.location.href = '/logout';
            }
        }

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Set user avatar
            const userStr = localStorage.getItem('user') || '{}';
            try {
                const user = JSON.parse(userStr);
                document.getElementById('user-avatar').textContent = 
                    (user.username || 'A').charAt(0).toUpperCase();
            } catch {
                document.getElementById('user-avatar').textContent = 'A';
            }

            // Mobile menu toggle
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Load initial content
            loadDashboard();
        });

        // Close modal on outside click
        document.getElementById('create-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('create-modal')) {
                closeCreateModal();
            }
        });

        document.getElementById('image-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('image-modal')) {
                e.target.classList.remove('show');
            }
        });

        // Escape key handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('create-modal').classList.remove('show');
                document.getElementById('image-modal').classList.remove('show');
                document.getElementById('confirm-modal').classList.remove('show');
            }
        });
    </script>
</body>
</html>